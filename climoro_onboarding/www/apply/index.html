{% extends "templates/web.html" %}

{% block page_content %}
<div class="onboarding-container">
    <!-- Header with Logo -->
    <div class="onboarding-header">
        <div class="logo-container">
            <img src="/files/Climoro.png"" alt="Climoro Logo" class="climoro-logo">
        </div>
        <h1>Climoro Onboarding Form</h1>
        <p>Complete your company onboarding in 6 simple steps</p>
    </div>

    <!-- Progress Indicator -->
    <div class="onboarding-progress-container">
        <div class="onboarding-progress-bar">
            <div class="onboarding-progress-step onboarding-current" data-step="1">
                <div class="onboarding-step-number">1</div>
                <div class="onboarding-step-label">Contact Details</div>
            </div>
            <div class="onboarding-progress-line"></div>
            <div class="onboarding-progress-step" data-step="2">
                <div class="onboarding-step-number">2</div>
                <div class="onboarding-step-label">Company Details</div>
            </div>
            <div class="onboarding-progress-line"></div>
            <div class="onboarding-progress-step" data-step="3">
                <div class="onboarding-step-number">3</div>
                <div class="onboarding-step-label">Units & Users</div>
            </div>
            <div class="onboarding-progress-line"></div>
            <div class="onboarding-progress-step" data-step="4">
                <div class="onboarding-step-number">4</div>
                <div class="onboarding-step-label">GHG Accounting</div>
            </div>
            <div class="onboarding-progress-line"></div>
            <div class="onboarding-progress-step" data-step="5">
                <div class="onboarding-step-number">5</div>
                <div class="onboarding-step-label">Reduction Form</div>
            </div>
            <div class="onboarding-progress-line"></div>
            <div class="onboarding-progress-step" data-step="6">
                <div class="onboarding-step-number">6</div>
                <div class="onboarding-step-label">Method of Calculation</div>
            </div>
        </div>
    </div>

    <!-- Form Container -->
    <div class="form-container" id="form-container">
        <form id="onboarding-form" class="onboarding-form">
            <!-- Step 1: Contact Details -->
            <div class="form-step active" id="step-1">
                <h2>Contact Details</h2>
                <div class="form-group">
                    <label for="first_name">First Name *</label>
                    <input type="text" id="first_name" name="first_name" required>
                </div>
                <div class="form-group">
                    <label for="middle_name">Middle Name</label>
                    <input type="text" id="middle_name" name="middle_name" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="last_name">Last Name *</label>
                    <input type="text" id="last_name" name="last_name" required>
                </div>
                <div class="form-group">
                    <label for="phone_number">Phone Number *</label>
                    <input type="tel" id="phone_number" name="phone_number" required>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="position">Position</label>
                    <input type="text" id="position" name="position">
                </div>
            </div>

            <!-- Step 2: Company Details -->
            <div class="form-step" id="step-2">
                <h2>Company Details (Headquarters)</h2>
                <div class="form-group">
                    <label for="company_name">Company Name *</label>
                    <input type="text" id="company_name" name="company_name" required>
                </div>
                <div class="form-group">
                    <label for="address">Address <span class="required-asterisk">*</span></label>
                    <textarea id="address" name="address" rows="3" placeholder="Enter your complete address" required></textarea>
                </div>
                <div class="form-group">
                    <label for="gps_coordinates">Map Location (Area/Building) <span class="required-asterisk">*</span></label>
                    <div class="gps-container">
                        <input type="text" id="gps_coordinates" name="gps_coordinates" placeholder="e.g., 28.6139, 77.2090 (type manually or use map)" readonly>
                        <button type="button" id="map_search_btn" class="btn btn-secondary map-select-btn" onclick="openMapModal()">üìç Map</button>
                    </div>
                <small style="color: #6c757d; margin-top: 5px; display: block;">
                        üí° <strong>Tip:</strong> Click "üìç Map" to select your location visually, or type coordinates manually.
                        <br>üìç <strong>Example:</strong> 28.6139, 77.2090 (New Delhi) | You can get coordinates from Google Maps by right-clicking any location.
                    </small>
                </div>
                <div class="form-group">
                    <label for="location_name">Location Name</label>
                    <input type="text" id="location_name" name="location_name" class="form-control" placeholder="Full location name will be set automatically" readonly>
                </div>
                <div class="form-group">
                    <label for="cin">CIN *</label>
                    <input type="text" id="cin" name="cin" required>
                </div>
                <div class="form-group">
                    <label for="gst_number">GST Number *</label>
                    <input type="text" id="gst_number" name="gst_number" required>
                </div>
                <div class="form-group">
                    <label for="industry_type">Industry Type *</label>
                    <select id="industry_type" name="industry_type" required onchange="updateSubIndustryOptions()">
                        <option value="">Select Industry Type</option>
                        <option value="Energy">Energy</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Construction">Construction</option>
                        <option value="Transportation & Logistics">Transportation & Logistics</option>
                        <option value="Retail & Consumer Goods">Retail & Consumer Goods</option>
                        <option value="Chemical & Petrochemical">Chemical & Petrochemical</option>
                        <option value="Financial & Insurance Services">Financial & Insurance Services</option>
                        <option value="Real Estate & Property Management">Real Estate & Property Management</option>
                        <option value="Services">Services</option>
                        <option value="Agriculture, Forestry & Land Use">Agriculture, Forestry & Land Use</option>
                        <option value="Waste Management">Waste Management</option>
                        <option value="Water Supply & Treatment">Water Supply & Treatment</option>
                        <option value="Telecommunications">Telecommunications</option>
                        <option value="Government & Public Administration">Government & Public Administration</option>
                        <option value="Aviation & Aerospace">Aviation & Aerospace</option>
                        <option value="Mining & Quarrying">Mining & Quarrying</option>
                        <option value="Fossil Fuel Supply Chain">Fossil Fuel Supply Chain</option>
                        <option value="Fisheries & Marine">Fisheries & Marine</option>
                        <option value="Media, Entertainment & Culture">Media, Entertainment & Culture</option>
                        <option value="Carbon Market & Climate Services">Carbon Market & Climate Services</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sub_industry_type">Sub-Industry Type *</label>
                    <select id="sub_industry_type" name="sub_industry_type" required>
                        <option value="">Select Industry Type First</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="website">Website</label>
                    <input type="url" id="website" name="website">
                </div>
                <div class="form-group">
                    <label for="letter_of_authorisation">Letter of Authorisation *</label>
                    <div class="file-upload-area" data-field="letter_of_authorisation">
                        <div class="upload-placeholder">
                            <i class="fa fa-upload"></i>
                            <p>Drag & drop your file here or <span class="browse-link">browse</span></p>
                            <small>Supported: PDF, DOCX, JPG, PNG, XLSX (Max 25MB)</small>
                        </div>
                        <input type="file" id="letter_of_authorisation" name="letter_of_authorisation" 
                               accept=".pdf,.docx,.doc,.xlsx,.xls,.csv,.jpg,.jpeg,.png,.gif,.bmp" style="display: none;">
                        <div class="file-preview" style="display: none;"></div>
                        <div class="upload-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Units & Users -->
            <div class="form-step" id="step-3">
                <h2>Units & Users</h2>
                
                <!-- Units Section -->
                <div class="section-container">
                    <h3>Units</h3>
                    <div id="units-container">
                        <!-- Units will be added here dynamically -->
                    </div>
                    <button type="button" id="add-unit-btn" class="btn btn-secondary">+ Add Unit</button>
                </div>
            </div>

            <!-- Step 4: GHG Accounting -->
            <div class="form-step" id="step-4">
                <h2>GHG Accounting</h2>
                
                <div class="form-group">
                    <label for="purpose_of_reporting">Purpose of Reporting *</label>
                    <select id="purpose_of_reporting" name="purpose_of_reporting" required>
                        <option value="">Select Purpose</option>
                        <option value="Regulatory / Compliance Reporting">Regulatory / Compliance Reporting</option>
                        <option value="Voluntary / Market-Based Reporting">Voluntary / Market-Based Reporting</option>
                        <option value="Strategic & Internal Reporting">Strategic & Internal Reporting</option>
                        <option value="Project-Level Reporting">Project-Level Reporting</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Gases to be Reported *</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="gases_to_report_co2" value="1"> CO2
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="gases_to_report_ch4" value="1"> CH4
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="gases_to_report_n2o" value="1"> N2O
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="gases_to_report_hfcs" value="1"> HFCs
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="gases_to_report_pfcs" value="1"> PFCs
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="gases_to_report_sf6" value="1"> SF6
                        </label>
                        <label class="checkbox-label" id="nf3-checkbox" style="display: none;">
                            <input type="checkbox" name="gases_to_report_nf3" value="1"> NF3 (Semiconductor Industry)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Scopes to Report *</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="scopes_to_report_scope1" value="1" onchange="toggleScopeOptions('scope1')"> Scope 1
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scopes_to_report_scope2" value="1" onchange="toggleScopeOptions('scope2')"> Scope 2
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scopes_to_report_scope3" value="1" onchange="toggleScopeOptions('scope3')"> Scope 3
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scopes_to_report_reductions" value="1" onchange="toggleScopeOptions('reductions')"> Reductions
                        </label>
                    </div>
                </div>

                <!-- Dynamic Scope Options -->
                <div id="scope1-options" class="scope-options" style="display: none;">
                    <h4>Scope 1 Options</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_1_options_process" value="1"> Process
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_1_options_stationary" value="1"> Stationary
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_1_options_mobile" value="1"> Mobile
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_1_options_fugitive" value="1"> Fugitive
                        </label>
                    </div>
                </div>

                <div id="scope2-options" class="scope-options" style="display: none;">
                    <h4>Scope 2 Options</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_2_options_electricity" value="1"> Electricity
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_2_options_heating" value="1"> Heating
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_2_options_cooling" value="1"> Cooling
                        </label>
                    </div>
                </div>

                <div id="scope3-options" class="scope-options" style="display: none;">
                    <h4>Scope 3 Options</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_3_options_upstream" value="1"> Upstream
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="scope_3_options_downstream" value="1"> Downstream
                        </label>
                    </div>
                </div>

                <div id="reductions-options" class="scope-options" style="display: none;">
                    <h4>Reduction Options</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="reduction_options_energy_efficiency" value="1"> Energy Efficiency
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="reduction_options_renewable_energy" value="1"> Renewable Energy
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="reduction_options_process_optimization" value="1"> Process Optimization
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="reduction_options_waste_management" value="1"> Waste Management
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="reduction_options_transportation" value="1"> Transportation
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="reduction_options_other" value="1"> Other
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 5: Reduction Form -->
            <div class="form-step" id="step-5">
                <h2>Reduction Form (Step 5)</h2>
                
                <!-- Section A: Emissions Inventory Setup -->
                <div class="section-container">
                    <h3>Section A: Emissions Inventory Setup</h3>
                    
                    <div class="form-group">
                        <label for="base_year">Baseline Year *</label>
                        <select id="base_year" name="base_year" required>
                            <option value="">Select Baseline Year</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                            <option value="2031">2031</option>
                            <option value="2032">2032</option>
                            <option value="2033">2033</option>
                            <option value="2034">2034</option>
                            <option value="2035">2035</option>
                            <option value="2036">2036</option>
                            <option value="2037">2037</option>
                            <option value="2038">2038</option>
                            <option value="2039">2039</option>
                            <option value="2040">2040</option>
                            <option value="2041">2041</option>
                            <option value="2042">2042</option>
                            <option value="2043">2043</option>
                            <option value="2044">2044</option>
                            <option value="2045">2045</option>
                            <option value="2046">2046</option>
                            <option value="2047">2047</option>
                            <option value="2048">2048</option>
                            <option value="2049">2049</option>
                            <option value="2050">2050</option>
                            <option value="2051">2051</option>
                            <option value="2052">2052</option>
                            <option value="2053">2053</option>
                            <option value="2054">2054</option>
                            <option value="2055">2055</option>
                            <option value="2056">2056</option>
                            <option value="2057">2057</option>
                            <option value="2058">2058</option>
                            <option value="2059">2059</option>
                            <option value="2060">2060</option>
                            <option value="2061">2061</option>
                            <option value="2062">2062</option>
                            <option value="2063">2063</option>
                            <option value="2064">2064</option>
                            <option value="2065">2065</option>
                            <option value="2066">2066</option>
                            <option value="2067">2067</option>
                            <option value="2068">2068</option>
                            <option value="2069">2069</option>
                            <option value="2070">2070</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="base_year_reason">Reason for Baseline Year Selection</label>
                        <textarea id="base_year_reason" name="base_year_reason" rows="3" placeholder="Explain why this year was chosen as the baseline year"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Scopes Covered</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="scopes_covered_scope1" value="1"> Scope 1 ‚Äì Direct emissions
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scopes_covered_scope2" value="1"> Scope 2 ‚Äì Indirect emissions
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scopes_covered_scope3" value="1"> Scope 3 ‚Äì Other indirect emissions
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>GHG Boundary Approach</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="ghg_boundary_approach_operational_control" value="1"> Operational Control
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="ghg_boundary_approach_financial_control" value="1"> Financial Control
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="ghg_boundary_approach_equity_share" value="1"> Equity Share
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Scope 3 Categories Included</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_purchased_goods" value="1"> Purchased goods and services
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_capital_goods" value="1"> Capital goods
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_fuel_energy" value="1"> Fuel- and energy-related activities
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_transportation" value="1"> Upstream/downstream transportation and distribution
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_waste" value="1"> Waste generated in operations
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_business_travel" value="1"> Business travel / employee commuting
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_use_sold_products" value="1"> Use of sold products
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_end_life_treatment" value="1"> End-of-life treatment of sold products
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="scope_3_categories_leased_assets" value="1"> Leased assets, franchises, or investments
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="emissions_exclusions">Emissions Exclusions (if any)</label>
                        <textarea id="emissions_exclusions" name="emissions_exclusions" rows="3" placeholder="List any emissions that are excluded from calculations and reasons"></textarea>
                    </div>
                </div>

                <!-- Section B: Emissions Reduction Targets -->
                <div class="section-container">
                    <h3>Section B: Emissions Reduction Targets</h3>
                    
                    <div class="form-group">
                        <label for="target_type">Target Type</label>
                        <select id="target_type" name="target_type">
                            <option value="">Select Target Type</option>
                            <option value="Near-term Target (5‚Äì10 years)">Near-term Target (5‚Äì10 years)</option>
                            <option value="Long-term Net-Zero Target (by 2050 or earlier)">Long-term Net-Zero Target (by 2050 or earlier)</option>
                            <option value="Both">Both</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Target Scope Alignment (Intensity-Based Reduction Goals)</label>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="scope_1_2_intensity_percentage">Scope 1 & 2: Reduce emissions intensity by ___ %</label>
                                <input type="number" id="scope_1_2_intensity_percentage" name="scope_1_2_intensity_percentage" step="0.1" min="0" max="100">
                            </div>
                            <div class="form-col">
                                <label for="scope_1_2_target_year">Target Year</label>
                                <select id="scope_1_2_target_year" name="scope_1_2_target_year">
                                    <option value="">Select Year</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                    <option value="2061">2061</option>
                                    <option value="2062">2062</option>
                                    <option value="2063">2063</option>
                                    <option value="2064">2064</option>
                                    <option value="2065">2065</option>
                                    <option value="2066">2066</option>
                                    <option value="2067">2067</option>
                                    <option value="2068">2068</option>
                                    <option value="2069">2069</option>
                                    <option value="2070">2070</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="scope_3_intensity_percentage">Scope 3: Reduce emissions intensity by ___ %</label>
                                <input type="number" id="scope_3_intensity_percentage" name="scope_3_intensity_percentage" step="0.1" min="0" max="100">
                            </div>
                            <div class="form-col">
                                <label for="scope_3_target_year">Target year</label>
                                <select id="scope_3_target_year" name="scope_3_target_year">
                                    <option value="">Select Year</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                    <option value="2031">2031</option>
                                    <option value="2032">2032</option>
                                    <option value="2033">2033</option>
                                    <option value="2034">2034</option>
                                    <option value="2035">2035</option>
                                    <option value="2036">2036</option>
                                    <option value="2037">2037</option>
                                    <option value="2038">2038</option>
                                    <option value="2039">2039</option>
                                    <option value="2040">2040</option>
                                    <option value="2041">2041</option>
                                    <option value="2042">2042</option>
                                    <option value="2043">2043</option>
                                    <option value="2044">2044</option>
                                    <option value="2045">2045</option>
                                    <option value="2046">2046</option>
                                    <option value="2047">2047</option>
                                    <option value="2048">2048</option>
                                    <option value="2049">2049</option>
                                    <option value="2050">2050</option>
                                    <option value="2051">2051</option>
                                    <option value="2052">2052</option>
                                    <option value="2053">2053</option>
                                    <option value="2054">2054</option>
                                    <option value="2055">2055</option>
                                    <option value="2056">2056</option>
                                    <option value="2057">2057</option>
                                    <option value="2058">2058</option>
                                    <option value="2059">2059</option>
                                    <option value="2060">2060</option>
                                    <option value="2061">2061</option>
                                    <option value="2062">2062</option>
                                    <option value="2063">2063</option>
                                    <option value="2064">2064</option>
                                    <option value="2065">2065</option>
                                    <option value="2066">2066</option>
                                    <option value="2067">2067</option>
                                    <option value="2068">2068</option>
                                    <option value="2069">2069</option>
                                    <option value="2070">2070</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="absolute_emissions_percentage">Optional: Maintain absolute emission with ___ % baseline year levels</label>
                                <input type="number" id="absolute_emissions_percentage" name="absolute_emissions_percentage" step="0.1" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Target Years</label>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="near_term_target_year">Near-Term Target Year</label>
                                <input type="number" id="near_term_target_year" name="near_term_target_year" min="2024" max="2070">
                            </div>
                            <div class="form-col">
                                <label for="long_term_target_year">Long-Term (Net-Zero) Target Year</label>
                                <input type="number" id="long_term_target_year" name="long_term_target_year" min="2024" max="2070">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Target Metrics ‚Äì Select All That Apply</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_absolute_emissions" value="1"> Absolute emissions reduction
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_kgco2e_mwh" value="1"> kgCO‚ÇÇe/MWh electricity (e.g., solar, wind generation)
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_kgco2e_tonne" value="1"> kgCO‚ÇÇe per tonne of material or product
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_kgco2e_unit_service" value="1"> kgCO‚ÇÇe per unit of service
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_kgco2e_usd_revenue" value="1"> kgCO‚ÇÇe per USD revenue
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_kgco2e_stove_year" value="1"> kgCO‚ÇÇe per stove-year (clean cooking)
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_kgco2e_tonne_biochar" value="1"> kgCO‚ÇÇe per tonne biochar applied
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_metrics_kgco2e_km_travelled" value="1"> kgCO‚ÇÇe per km travelled (transport decarbonization)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Target Boundary (Coverage of Emissions)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_boundary_scope1_2_95_percent" value="1"> Scope 1 & 2: ‚â•95% included
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_boundary_scope3_90_percent_long_term" value="1"> Scope 3: ‚â•90% included (long-term)
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_boundary_scope3_67_percent_near_term" value="1"> Scope 3: ‚â•67% (near-term)
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="target_boundary_prioritize_relevance" value="1"> Scope 3: Prioritize by relevance
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Section C: Mitigation Strategies -->
                <div class="section-container">
                    <h3>Section C: Mitigation Strategies</h3>
                    
                    <div class="form-group">
                        <label>1. Operational Emissions (Scope 1 & 2)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="operational_emissions_energy_efficiency" value="1"> Energy efficiency improvements
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="operational_emissions_onsite_renewable" value="1"> Onsite renewable energy (e.g., rooftop solar)
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="operational_emissions_offsite_renewable" value="1"> Offsite renewable procurement
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="operational_emissions_fuel_switching" value="1"> Fuel switching to clean alternatives
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="operational_emissions_process_optimization" value="1"> Process optimization
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>2. Value Chain Emissions (Scope 3)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="value_chain_emissions_supplier_engagement" value="1"> Supplier engagement
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="value_chain_emissions_low_carbon_materials" value="1"> Low-carbon input materials
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="value_chain_emissions_redesign_use_phase" value="1"> Redesign for use-phase reduction
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="value_chain_emissions_optimize_logistics" value="1"> Optimize logistics
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="value_chain_emissions_circular_economy" value="1"> Circular economy practices
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>3. Land Sector & Removals (Optional)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="land_sector_removals_afforestation" value="1"> Afforestation / reforestation
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="land_sector_removals_soil_carbon" value="1"> Soil carbon improvement
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="land_sector_removals_urban_greening" value="1"> Urban greening
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="land_sector_removals_biochar" value="1"> Biochar application
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="land_sector_removals_carbon_capture" value="1"> Carbon capture or enhanced weathering
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="land_sector_removals_certified_removals" value="1"> Certified removals (DAC, agroforestry)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>4. Residual Emissions Strategy</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="residual_emissions_high_quality_credits" value="1"> High-quality removal credits
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="residual_emissions_bvcm" value="1"> Beyond Value Chain Mitigation (BVCM)
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="residual_emissions_temporary_solutions" value="1"> Temporary voluntary solutions
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Section D: Monitoring, Adjustments & Reporting -->
                <div class="section-container">
                    <h3>Section D: Monitoring, Adjustments & Reporting</h3>
                    
                    <div class="form-group">
                        <label for="monitoring_frequency">1. Monitoring Frequency</label>
                        <select id="monitoring_frequency" name="monitoring_frequency" onchange="toggleOtherFrequency()">
                            <option value="">Select Monitoring Frequency</option>
                            <option value="Annual">Annual</option>
                            <option value="Biennial">Biennial</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="other-frequency-group" style="display: none;">
                        <label for="monitoring_frequency_other_text">Other Monitoring Frequency</label>
                        <input type="text" id="monitoring_frequency_other_text" name="monitoring_frequency_other_text" placeholder="Specify other monitoring frequency">
                    </div>
                    
                    <div class="form-group">
                        <label for="assurance_validation">2. Assurance and Validation</label>
                        <select id="assurance_validation" name="assurance_validation">
                            <option value="">Select Assurance and Validation</option>
                            <option value="Internal assurance">Internal assurance</option>
                            <option value="Third-party verification">Third-party verification</option>
                            <option value="Submitted to validation platform (e.g., SBTi)">Submitted to validation platform (e.g., SBTi)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ghg_tracking_tools">GHG Tracking Tools Used</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="ghg_tracking_tools_excel" value="1"> Excel / spreadsheet
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="ghg_tracking_tools_software" value="1" onchange="toggleSoftwareName()"> GHG software
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="ghg_tracking_tools_web_platform" value="1"> Web platform (e.g., CDP, Net-Zero Cloud)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="software-name-group" style="display: none;">
                        <label for="ghg_tracking_tools_software_name">GHG Software Name</label>
                        <input type="text" id="ghg_tracking_tools_software_name" name="ghg_tracking_tools_software_name" placeholder="Name of the GHG software used">
                    </div>
                    
                    <div class="form-group">
                        <label>4. Recalculation Policy</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="recalculation_policy_structural" value="1"> Structural changes
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="recalculation_policy_methodology" value="1"> Methodology changes
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="recalculation_policy_boundary" value="1"> Boundary/scope adjustments
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>5. Progress Communication</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="progress_communication_esg_dashboard" value="1"> ESG dashboard
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="progress_communication_sustainability_report" value="1"> Annual sustainability report
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="progress_communication_cdp_disclosure" value="1"> CDP/public disclosure
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="progress_communication_sbti_registry" value="1"> SBTi registry updates
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Method of Calculation -->
            <div class="form-step" id="step-6">
                <h2>Method of Calculation</h2>
                
                <div class="form-group">
                    <label>Select Method of Calculation *</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="method_of_calculation_option_a" value="1"> Direct Measurement Method
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="method_of_calculation_option_b" value="1"> Emission factor Method
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="method_of_calculation_option_c" value="1"> Stoichiometric Calculation
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="method_of_calculation_option_d" value="1"> Modeling and Simulation
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="method_of_calculation_option_e" value="1"> Default or Proxy Data
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="method_of_calculation_option_f" value="1"> Life Cycle assessment
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="method_of_calculation_option_g" value="1"> Digital MRU and IoT-Based System
                        </label>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="form-navigation">
                <button type="button" id="prev-btn" class="btn btn-secondary" style="display: none;">Previous</button>
                <button type="button" id="next-btn" class="btn btn-primary">Next</button>
                <button type="submit" id="submit-btn" class="btn btn-success" style="display: none;">Submit Application</button>
            </div>
        </form>
    </div>
</div>

<!-- Unit Template (Hidden) -->
<template id="unit-template">
    <div class="unit-container">
        <h3>Unit <span class="unit-number"></span></h3>
        <div class="unit-form">
            <div class="form-group">
                <label>Type of Unit *</label>
                <select class="unit-type" required>
                    <option value="">Select Unit Type</option>
                    <option value="Office">Office</option>
                    <option value="Warehouse">Warehouse</option>
                    <option value="Factory">Factory</option>
                    <option value="Franchise">Franchise</option>
                </select>
            </div>
            <div class="form-group">
                <label>Name of Unit *</label>
                <input type="text" class="unit-name" required>
            </div>
            <div class="form-group">
                <label>Size of Unit (sq ft) *</label>
                <input type="number" class="unit-size" required>
            </div>
            <div class="form-group">
                <label>Address *</label>
                <textarea class="unit-address" required></textarea>
            </div>
            <div class="form-group">
                <label>Map Location (Area/Building) *</label>
                <div class="gps-container">
                    <input type="text" class="unit-gps-coordinates" placeholder="e.g., 28.6139, 77.2090 (type manually or use map)" readonly>
                    <button type="button" class="btn btn-secondary map-select-btn unit-map-btn">
                        <i class="fa fa-map-marker"></i> üìç Map
                    </button>
                </div>
                <small style="color: #6c757d; margin-top: 5px; display: block;">
                    üí° <strong>Tip:</strong> Click "üìç Map" to select your location visually, or type coordinates manually.
                </small>
            </div>
            <div class="form-group">
                <label>Location Name</label>
                <input type="text" class="unit-location-name" placeholder="Full location name will be set automatically" readonly>
            </div>
            <div class="form-group">
                <label>GST (optional)</label>
                <input type="text" class="unit-gst">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" class="unit-phone">
            </div>
            <div class="form-group">
                <label>Position</label>
                <input type="text" class="unit-position">
            </div>
        </div>
        
        <!-- Users Section within Unit -->
        <div class="users-section">
            <h4>Users for this Unit</h4>
            <div class="users-container">
                <!-- Users will be added here dynamically -->
            </div>
            <button type="button" class="add-user-btn btn btn-sm btn-secondary">+ Add User</button>
        </div>
        
        <button type="button" class="remove-unit-btn btn btn-sm btn-danger">Remove Unit</button>
    </div>
</template>

<!-- User Template (Hidden) -->
<template id="user-template">
    <div class="user-container">
        <h5>User <span class="user-number"></span></h5>
        <div class="user-form">
            <div class="form-group">
                <label>Email *</label>
                <input type="email" class="user-email" required>
            </div>
            <div class="form-group">
                <label>First Name *</label>
                <input type="text" class="user-first-name" required>
            </div>
            <div class="form-group">
                <label>User Role *</label>
                <select class="user-role" required>
                    <option value="">Select Role</option>
                    <option value="Unit Manager">Unit Manager</option>
                    <option value="Data Analyst">Data Analyst</option>
                </select>
            </div>
        </div>
        <button type="button" class="remove-user-btn btn btn-sm btn-danger">Remove User</button>
    </div>
</template>

<!-- Map Modal -->
<div id="mapModal" class="map-modal">
    <div class="map-modal-content">
        <div class="map-modal-header">
            <h3>üó∫Ô∏è Select Area/Building Location</h3>
            <button type="button" class="map-modal-close" onclick="closeMapModal()">&times;</button>
        </div>
        
        <div class="map-search-container">
            <input type="text" id="mapSearchInput" class="map-search-input" placeholder="Search for area, building, or landmark...">
        </div>
        
        <div id="map" class="map-container">
            <div class="map-loading">
                <i class="fa fa-spinner fa-spin"></i> Loading Google Maps...
            </div>
        </div>
        
        <div id="coordinatesDisplay" class="coordinates-display">
            Click on the map to select a location, then click "Confirm Location" to save
        </div>
        
        <div class="map-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeMapModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmLocation()">Confirm Location</button>
        </div>
    </div>
</div>

{% endblock %}

{% block style %}
<style>
/* ERP Theme Colors */
:root {
    --primary-color: #5e64ff;
    --primary-hover: #4a4fef;
    --secondary-color: #6c757d;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --border-color: #dee2e6;
    --text-color: #495057;
    --text-muted: #6c757d;
    --background-color: #f5f7fa;
    --card-background: #ffffff;
    --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

body {
    background-color: var(--background-color);
    color: var(--text-color);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Global checkbox reset to prevent any default styling */
* input[type="checkbox"] {
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    -ms-appearance: none !important;
    appearance: none !important;
    border-radius: 0 !important;
    -webkit-border-radius: 0 !important;
    -moz-border-radius: 0 !important;
    background-image: none !important;
    -webkit-background-image: none !important;
    -moz-background-image: none !important;
    -ms-background-image: none !important;
    content: none !important;
    outline: none !important;
    -webkit-outline: none !important;
    -moz-outline: none !important;
    box-shadow: none !important;
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    /* Force square shape */
    width: 18px !important;
    height: 18px !important;
    min-width: 18px !important;
    min-height: 18px !important;
    max-width: 18px !important;
    max-height: 18px !important;
    /* Default unchecked state */
    border: 2px solid var(--border-color) !important;
    border-radius: 4px !important;
    -webkit-border-radius: 4px !important;
    -moz-border-radius: 4px !important;
    background-color: var(--card-background) !important;
    position: relative !important;
    display: inline-block !important;
    vertical-align: middle !important;
    margin: 0 !important;
    padding: 0 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

/* Checked state - consistent purple color */
* input[type="checkbox"]:checked {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    background-image: none !important;
    -webkit-background-image: none !important;
    -moz-background-image: none !important;
    -ms-background-image: none !important;
    content: none !important;
    border-radius: 4px !important;
    -webkit-border-radius: 4px !important;
    -moz-border-radius: 4px !important;
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    box-shadow: none !important;
    outline: none !important;
    -webkit-outline: none !important;
    -moz-outline: none !important;
}

/* Custom checkmark - centered and consistent */
* input[type="checkbox"]:checked::after {
    content: '‚úì' !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    color: white !important;
    font-size: 11px !important;
    font-weight: bold !important;
    line-height: 1 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    z-index: 10 !important;
    pointer-events: none !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    text-align: center !important;
    width: 100% !important;
    height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Hover state */
* input[type="checkbox"]:hover {
    border-color: var(--primary-color) !important;
}

/* Focus state */
* input[type="checkbox"]:focus {
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(94, 100, 255, 0.1) !important;
}

.onboarding-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

/* Header with Logo */
.onboarding-header {
    text-align: center;
    margin-bottom: 40px;
    background: var(--card-background);
    border-radius: 8px;
    padding: 30px;
    box-shadow: var(--shadow);
}

.logo-container {
    margin-bottom: 20px;
}

.climoro-logo {
    max-height: 80px;
    max-width: 200px;
    object-fit: contain;
}

.onboarding-header h1 {
    color: var(--dark-color);
    margin-bottom: 10px;
    font-size: 2rem;
    font-weight: 600;
}

.onboarding-header p {
    color: var(--text-muted);
    font-size: 1.1rem;
    margin: 0;
}

/* Progress Indicator - Updated with unique class names to avoid conflicts */
.onboarding-progress-container {
    margin-bottom: 30px;
    background: var(--card-background);
    border-radius: 8px;
    padding: 25px;
    box-shadow: var(--shadow);
}

.onboarding-progress-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    background: none;
    height: auto;
    min-height: auto;
    width: 100%;
}

.onboarding-progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
    z-index: 2;
}

.onboarding-step-number {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 10px;
    border: 3px solid var(--border-color);
    background-color: var(--card-background);
    color: var(--text-muted);
    transition: all 0.3s ease;
    box-shadow: none;
    position: relative;
}

.onboarding-step-label {
    font-size: 14px;
    color: var(--text-color);
    text-align: center;
    font-weight: 500;
    transition: all 0.3s ease;
}

/* Progress Step States */
.onboarding-progress-step.onboarding-completed .onboarding-step-number {
    background-color: var(--success-color);
    border-color: var(--success-color);
    color: white;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
}

.onboarding-progress-step.onboarding-completed .onboarding-step-label {
    color: var(--success-color);
    font-weight: 600;
}

.onboarding-progress-step.onboarding-current .onboarding-step-number {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    box-shadow: 0 0 0 3px rgba(94, 100, 255, 0.2);
}

.onboarding-progress-step.onboarding-current .onboarding-step-label {
    color: var(--primary-color);
    font-weight: 600;
}

.onboarding-progress-step:not(.onboarding-completed):not(.onboarding-current) .onboarding-step-number {
    background-color: var(--light-color);
    border-color: var(--border-color);
    color: var(--text-muted);
}

.onboarding-progress-step:not(.onboarding-completed):not(.onboarding-current) .onboarding-step-label {
    color: var(--text-muted);
}

/* Progress Lines */
.onboarding-progress-line {
    flex: 1;
    height: 3px;
    background-color: var(--border-color);
    margin: 0 15px;
    position: relative;
    top: -15px;
    z-index: 1;
}

.onboarding-progress-line.onboarding-completed {
    background-color: var(--success-color);
}

/* Form Container */
.form-container {
    background: var(--card-background);
    border-radius: 8px;
    box-shadow: var(--shadow);
    padding: 30px;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

.form-step h2 {
    margin-bottom: 25px;
    color: var(--dark-color);
    font-size: 1.5rem;
    font-weight: 600;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 10px;
}

.form-group {
    margin-bottom: 25px;
}

/* Improved spacing for form sections */
.form-step {
    display: none;
    padding: 20px 0;
}

.form-step.active {
    display: block;
}

.form-step h2 {
    margin-bottom: 30px;
    color: var(--dark-color);
    font-size: 1.5rem;
    font-weight: 600;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 15px;
}

/* Section breaks and headings */
.form-step h3 {
    margin: 30px 0 20px 0;
    color: var(--dark-color);
    font-size: 1.2rem;
    font-weight: 600;
    padding: 10px 15px;
    background-color: var(--light-color);
    border-radius: 6px;
    border-left: 4px solid var(--primary-color);
}

.form-step h4 {
    margin: 25px 0 15px 0;
    color: var(--dark-color);
    font-size: 1.1rem;
    font-weight: 600;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-color);
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background-color: var(--card-background);
    color: var(--text-color);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(94, 100, 255, 0.1);
}

.form-group textarea {
    height: 80px;
    resize: vertical;
}

.form-group input[type="file"] {
    padding: 8px;
    border: 2px dashed var(--border-color);
    background-color: var(--light-color);
    cursor: pointer;
}

.form-group input[type="file"]:hover {
    border-color: var(--primary-color);
    background-color: rgba(94, 100, 255, 0.05);
}

/* GPS Coordinates Styles */
.gps-coordinates-container {
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

.gps-coordinates-container input {
    flex: 1;
    background-color: var(--light-color);
    cursor: not-allowed;
}

.gps-coordinates-container input:not([readonly]) {
    background-color: var(--card-background);
    cursor: text;
}

.map-select-btn {
    white-space: nowrap;
    padding: 12px 16px;
    font-size: 13px;
    min-width: 140px;
}

.map-select-btn i {
    margin-right: 5px;
}

/* Map Modal Styles */
.map-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.map-modal-content {
    background-color: var(--card-background);
    margin: 5% auto;
    padding: 25px;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    position: relative;
    max-height: 80vh;
    overflow: hidden;
}

.map-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.map-modal-header h3 {
    margin: 0;
    color: var(--text-color);
    font-size: 20px;
    font-weight: 600;
}

.map-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-muted);
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.map-modal-close:hover {
    background-color: var(--light-color);
    color: var(--text-color);
}

.map-search-container {
    margin-bottom: 15px;
}

.map-search-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.map-search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(94, 100, 255, 0.1);
}

/* Google Places Autocomplete Styles */
.pac-container {
    z-index: 10001 !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    border: 1px solid var(--border-color) !important;
    font-family: inherit !important;
}

.pac-item {
    padding: 12px 16px !important;
    border-bottom: 1px solid var(--border-color) !important;
    cursor: pointer !important;
    transition: background-color 0.2s ease !important;
}

.pac-item:hover {
    background-color: var(--light-color) !important;
}

.pac-item:last-child {
    border-bottom: none !important;
}

.pac-item-query {
    font-weight: 500 !important;
    color: var(--text-color) !important;
}

.pac-matched {
    font-weight: 600 !important;
    color: var(--primary-color) !important;
}

.pac-secondary-text {
    color: var(--text-muted) !important;
    font-size: 13px !important;
}

.map-container {
    width: 100%;
    height: 400px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    overflow: hidden;
}

.coordinates-display {
    background: var(--light-color);
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    border-left: 4px solid var(--primary-color);
}

.map-modal-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
}

.map-modal-actions .btn {
    flex: 1;
    max-width: 150px;
}

.map-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 400px;
    background: var(--light-color);
    border-radius: 8px;
    font-size: 16px;
    color: var(--text-muted);
}

.map-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 400px;
    background: var(--light-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.map-error h4 {
    color: var(--danger-color);
    margin-bottom: 10px;
}

.map-error .manual-entry-help {
    background: var(--card-background);
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
    border: 1px solid var(--border-color);
}

/* Navigation Buttons */
.form-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(94, 100, 255, 0.3);
}

.btn-secondary {
    background-color: var(--secondary-color);
    color: white;
}

.btn-secondary:hover:not(:disabled) {
    background-color: #5a6268;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
}

.btn-success {
    background-color: var(--success-color);
    color: white;
}

.btn-success:hover:not(:disabled) {
    background-color: #218838;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.btn-danger {
    background-color: var(--danger-color);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background-color: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

/* Unit and User Containers */
.unit-container {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background-color: var(--light-color);
    position: relative;
}

.unit-container h3 {
    margin-bottom: 15px;
    color: var(--dark-color);
    font-size: 1.2rem;
    font-weight: 600;
}

.users-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

.users-section h4 {
    margin-bottom: 15px;
    color: var(--dark-color);
    font-size: 1rem;
    font-weight: 600;
}

.user-container {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: var(--card-background);
    position: relative;
}

.user-container h5 {
    margin-bottom: 10px;
    color: var(--dark-color);
    font-size: 0.9rem;
    font-weight: 600;
}

#add-unit-btn {
    margin-bottom: 20px;
    width: 100%;
    padding: 15px;
    font-size: 16px;
}

.add-user-btn {
    margin-bottom: 10px;
    width: 100%;
}

.remove-unit-btn,
.remove-user-btn {
    margin-top: 10px;
    position: absolute;
    top: 10px;
    right: 10px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .onboarding-container {
        padding: 10px;
    }
    
    .form-container {
        padding: 20px;
    }
    
    .onboarding-progress-bar {
        flex-direction: column;
        gap: 20px;
    }
    
    .onboarding-progress-line {
        display: none;
    }
    
    .form-navigation {
        flex-direction: column;
        gap: 10px;
    }
    
    .btn {
        width: 100%;
    }
    
    /* Mobile checkbox improvements */
    .checkbox-group {
        padding: 12px;
        gap: 10px;
    }
    
    .checkbox-label {
        padding: 10px 8px;
        font-size: 13px;
    }
    
    .checkbox-label input[type="checkbox"] {
        width: 16px;
        height: 16px;
    }
    
    /* Mobile form layout */
    .form-row {
        flex-direction: column;
        gap: 15px;
    }
    
    .form-col {
        width: 100%;
    }
    
    /* Mobile section headings */
    .form-step h2 {
        font-size: 1.3rem;
        margin-bottom: 25px;
    }
    
    .form-step h3 {
        font-size: 1.1rem;
        margin: 25px 0 15px 0;
    }
    
    .form-step h4 {
        font-size: 1rem;
        margin: 20px 0 12px 0;
    }
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--primary-color);
    border-top: 2px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Error States */
.form-group input.error,
.form-group select.error,
.form-group textarea.error {
    border-color: var(--danger-color);
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

.error-message {
    color: var(--danger-color);
    font-size: 12px;
    margin-top: 5px;
}

/* Warning States */
.form-group input.warning,
.form-group select.warning,
.form-group textarea.warning {
    border-color: var(--warning-color);
    box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
}

.warning-message {
    color: var(--warning-color);
    font-size: 12px;
    margin-top: 5px;
}

/* Success States */
.form-group input.success:not([type="checkbox"]),
.form-group select.success,
.form-group textarea.success {
    border-color: var(--success-color);
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

/* Checkbox Styles - Fix spacing and double tick issue */
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: var(--light-color);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

/* Override any Frappe default checkbox styles */
.onboarding-form input[type="checkbox"],
.form-container input[type="checkbox"],
.checkbox-group input[type="checkbox"] {
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    -ms-appearance: none !important;
    width: 18px !important;
    height: 18px !important;
    margin: 0 !important;
    padding: 0 !important;
    border: 2px solid var(--border-color) !important;
    border-radius: 4px !important;
    background-color: var(--card-background) !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    position: relative !important;
    box-shadow: none !important;
    outline: none !important;
    display: inline-block !important;
    vertical-align: middle !important;
    flex-shrink: 0 !important;
    /* Completely hide default checkbox */
    opacity: 1 !important;
    background-image: none !important;
    background-size: auto !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
    /* Remove any default styling */
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    box-shadow: none !important;
    /* Ensure no default content */
    content: none !important;
}

.onboarding-form input[type="checkbox"]:checked,
.form-container input[type="checkbox"]:checked,
.checkbox-group input[type="checkbox"]:checked {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    position: relative !important;
    /* Completely override any default checked styling */
    background-image: none !important;
    -webkit-background-image: none !important;
    -moz-background-image: none !important;
    -ms-background-image: none !important;
    /* Remove any default content */
    content: none !important;
    /* Ensure no default checkmark shows */
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    box-shadow: none !important;
}

.onboarding-form input[type="checkbox"]:checked::after,
.form-container input[type="checkbox"]:checked::after,
.checkbox-group input[type="checkbox"]:checked::after {
    content: '‚úì' !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    color: white !important;
    font-size: 11px !important;
    font-weight: bold !important;
    line-height: 1 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    /* Ensure this is the only checkmark visible */
    z-index: 10 !important;
    pointer-events: none !important;
    /* Remove any default pseudo-elements */
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
    box-shadow: none !important;
    background: none !important;
    border: none !important;
    width: 100% !important;
    height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

.checkbox-label {
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    cursor: pointer !important;
    padding: 8px 12px !important;
    border-radius: 6px !important;
    transition: background-color 0.2s ease !important;
    font-size: 14px !important;
    color: var(--text-color) !important;
    margin: 0 !important;
    line-height: 1.4 !important;
    min-height: 20px !important;
}

.checkbox-label:hover {
    background-color: rgba(94, 100, 255, 0.05);
}

.checkbox-label input[type="checkbox"] {
    width: 18px !important;
    height: 18px !important;
    margin: 0 !important;
    padding: 0 !important;
    border: 2px solid var(--border-color) !important;
    border-radius: 4px !important;
    background-color: var(--card-background) !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    flex-shrink: 0 !important;
    position: relative !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    box-shadow: none !important;
    outline: none !important;
    display: inline-block !important;
    vertical-align: middle !important;
}

.checkbox-label input[type="checkbox"]:checked {
    background-color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    position: relative !important;
}

.checkbox-label input[type="checkbox"]:checked::after {
    content: '‚úì' !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    color: white !important;
    font-size: 11px !important;
    font-weight: bold !important;
    line-height: 1 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 100% !important;
    height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

.checkbox-label input[type="checkbox"]:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(94, 100, 255, 0.1);
}

.checkbox-label input[type="checkbox"]:hover {
    border-color: var(--primary-color);
}

/* Section headings for checkbox groups */
.checkbox-group h4,
.checkbox-group h5 {
    margin: 0 0 15px 0;
    color: var(--dark-color);
    font-weight: 600;
    font-size: 16px;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
}

.checkbox-group h5 {
    font-size: 14px;
    margin-bottom: 12px;
}

/* Form row layout for better spacing */
.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.form-col {
    flex: 1;
}

.form-col .form-group {
    margin-bottom: 15px;
}

/* Additional spacing improvements */
.form-step .form-group:last-child {
    margin-bottom: 0;
}

.checkbox-group:last-child {
    margin-bottom: 0;
}

/* Ensure proper alignment of checkbox text */
.checkbox-label span,
.checkbox-label {
    vertical-align: middle !important;
    display: inline-flex !important;
    align-items: center !important;
}

/* Fix any potential alignment issues */
.checkbox-label input[type="checkbox"] {
    margin-right: 0 !important;
    margin-left: 0 !important;
}

/* Additional checkbox styling removed - now handled by global rules above */

/* Frappe-specific checkbox styling removed - now handled by global rules above */

/* File Upload Styles */
.file-upload-area {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background-color: var(--light-color);
    transition: all 0.3s ease;
    position: relative;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.file-upload-area:hover {
    border-color: var(--primary-color);
    background-color: rgba(94, 100, 255, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--primary-color);
    background-color: rgba(94, 100, 255, 0.1);
    transform: scale(1.02);
}

.upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.upload-placeholder i {
    font-size: 24px;
    color: var(--primary-color);
}

.upload-placeholder p {
    margin: 0;
    color: var(--text-color);
    font-size: 14px;
}

.browse-link {
    color: var(--primary-color);
    text-decoration: underline;
    cursor: pointer;
    font-weight: 500;
}

.browse-link:hover {
    color: var(--primary-hover);
}

.upload-placeholder small {
    color: var(--muted-color);
    font-size: 12px;
}

.file-preview {
    width: 100%;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background-color: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 10px;
}

.file-item-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.file-item-icon {
    font-size: 20px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--light-color);
    border-radius: 6px;
}

.file-item-details {
    flex: 1;
}

.file-item-name {
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 4px;
}

.file-item-size {
    font-size: 12px;
    color: var(--muted-color);
}

.file-item-status {
    font-size: 12px;
    color: var(--success-color);
}

.file-item-actions {
    display: flex;
    gap: 8px;
}

.file-action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.file-action-btn.remove {
    background-color: var(--danger-color);
    color: white;
}

.file-action-btn.remove:hover {
    background-color: #c82333;
}

.file-action-btn.download {
    background-color: var(--primary-color);
    color: white;
}

.file-action-btn.download:hover {
    background-color: var(--primary-hover);
}

.upload-progress {
    margin-top: 10px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background-color: var(--light-color);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    height: 100%;
    background-color: var(--primary-color);
    width: 0%;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 12px;
    color: var(--muted-color);
    text-align: center;
    display: block;
}

.file-error {
    color: var(--danger-color);
    font-size: 12px;
    margin-top: 8px;
    padding: 8px;
    background-color: rgba(220, 53, 69, 0.1);
    border-radius: 4px;
    border: 1px solid rgba(220, 53, 69, 0.2);
}

/* Validation Warnings Container */
.validation-warnings {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Field validation indicators */
.form-group {
    position: relative;
}

.form-group input.success:not([type="checkbox"])::after,
.form-group select.success::after,
.form-group textarea.success::after {
    content: '‚úì';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--success-color);
    font-weight: bold;
}

.form-group input.warning::after,
.form-group select.warning::after,
.form-group textarea.warning::after {
    content: '‚ö†';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--warning-color);
    font-weight: bold;
}

.form-group input.error::after,
.form-group select.error::after,
.form-group textarea.error::after {
    content: '‚úó';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--danger-color);
    font-weight: bold;
}

/* GPS Container Styling */
.gps-container {
    display: flex;
    gap: 10px;
    align-items: center;
}

.gps-container input {
    flex: 1;
    min-width: 200px;
}

.gps-container button {
    white-space: nowrap;
    min-width: 80px;
}

.map-buttons {
    position: absolute !important;
    bottom: 1px !important;
    left: 20px !important;
    right: 20px !important;
    padding: 16px !important;
    text-align: right !important;
    border-top: 1px solid #e9ecef !important;
    background: white !important;
    border-radius: 0 0 8px 8px !important;
}

/* Acknowledgment Page Styles */
.acknowledgment-page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    overflow-y: auto;
    padding: 20px;
}

.acknowledgment-container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 1px solid #e9ecef;
}

.acknowledgment-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 40px;
    text-align: center;
}

.success-icon {
    font-size: 60px;
    margin-bottom: 20px;
}

.acknowledgment-header h1 {
    font-size: 32px;
    margin-bottom: 15px;
    font-weight: 600;
}

.acknowledgment-header p {
    font-size: 18px;
    opacity: 0.9;
    margin: 0;
}

.acknowledgment-footer {
    background: #f8f9fa;
    padding: 40px;
    text-align: center;
}

.acknowledgment-footer p {
    margin: 15px 0;
    font-size: 18px;
    color: #333;
    font-weight: 500;
}

.status-badge {
    background: #28a745;
    color: white;
    padding: 8px 20px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 600;
    display: inline-block;
}

.acknowledgment-actions {
    padding: 30px 40px;
    text-align: center;
    background: white;
}

.acknowledgment-actions .btn {
    padding: 15px 30px;
    font-size: 16px;
    border-radius: 8px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    font-weight: 600;
}

.acknowledgment-actions .btn-primary {
    background: #007bff;
    color: white;
    border: none;
}

.acknowledgment-actions .btn-primary:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
}

/* Print styles */
@media print {
    .acknowledgment-page {
        position: static;
        background: white;
    }
    
    .acknowledgment-actions {
        display: none;
    }
}
</style>
{% endblock %}

{% block script %}
<script>
// Onboarding Form JavaScript
class OnboardingForm {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 6;
        this.formData = {};
        this.isSubmitting = false;
        
        // Check for resume token in URL
        const urlParams = new URLSearchParams(window.location.search);
        const resumeToken = urlParams.get('resume');
        const verifyToken = urlParams.get('verify');
        
        console.log('üîó OnboardingForm constructor - URL:', window.location.href);
        console.log('üîó OnboardingForm constructor - initial currentStep:', this.currentStep);
        if (resumeToken) {
            console.log('üîó Resume token in constructor:', resumeToken);
        } else {
            console.log('üîó No resume token found in URL');
        }
        
        // Initialize form elements
        this.initializeForm();
        this.bindEvents();
        
        // Check if resume data is already available (form initialized after resume verification)
        if (window.resumeSessionData) {
            console.log('Resume data already available in constructor, handling resume...');
            this.handleResume(window.resumeSessionData);
        } else if (resumeToken) {
            // Set resume mode immediately
            window.isResumeMode = true;
            console.log('Resume token detected - setting resume mode');
            
            // Wait for resume data to be loaded
            this.waitForResumeData();
        } else {
            // No resume token, check for local backup first
            const localBackup = this.restoreFromLocalBackup();
            if (localBackup) {
                console.log('üîÑ Restoring from local backup');
                this.restoreFromBackup(localBackup);
            } else {
                // No local backup, proceed with normal initialization
                this.loadSavedData();
            }
        }
    }
    
    waitForResumeData() {
        // Check if resume data is already available
        if (window.resumeSessionData) {
            console.log('Resume data already available, updating form...');
                    this.handleResume(window.resumeSessionData);
            return;
        }
        
        // Wait for resume data to be loaded
        let attempts = 0;
        const maxAttempts = 50; // 5 seconds max wait
        
        const checkResumeData = () => {
            attempts++;
            console.log(`Checking for resume data (attempt ${attempts}/${maxAttempts})...`);
            
            if (window.resumeSessionData) {
                console.log('Resume data found, updating form...');
                this.handleResume(window.resumeSessionData);
                return;
            }
            
            if (attempts >= maxAttempts) {
                console.log('Timeout waiting for resume data, proceeding with normal initialization');
                this.loadSavedData();
                return;
            }
            
            // Check again in 100ms
            setTimeout(checkResumeData, 100);
        };
        
        // Start checking
        setTimeout(checkResumeData, 100);
    }
    
    initializeFileUploads() {
        console.log('Initializing file uploads...');
        // File upload initialization code here
    }
    
    handleResume(sessionData) {
        console.log('üîç handleResume called with session data:', sessionData);
        
        if (sessionData && sessionData.application_data) {
            const appData = sessionData.application_data;
            const currentStep = sessionData.current_step || 1;
            
            console.log('üîç Resuming application at step:', currentStep);
            console.log('üîç Application data keys:', Object.keys(appData));
            console.log('üîç Units data present:', !!appData.units);
            console.log('üîç Assigned users data present:', !!appData.assigned_users);
            
            // Set current step
            this.currentStep = currentStep;
            
            // Restore form data
            console.log('üîç About to call restoreFormDataFromSession...');
            this.restoreFormDataFromSession(appData);
            console.log('üîç restoreFormDataFromSession completed');
            
            // Update UI
            this.goToStep(currentStep);
            this.updateNavigation();
            this.updateProgress();
            
            console.log('üîç Resume completed successfully');
        } else {
            console.log('‚ùå No valid session data for resume');
        }
    }
    
    restoreFormDataFromSession(appData) {
        console.log('üîç üîç üîç restoreFormDataFromSession FUNCTION CALLED üîç üîç üîç');
        console.log('üîç Restoring form data from session:', appData);
        console.log('üîç Application data keys:', Object.keys(appData));
        console.log('üîç Units data:', appData.units);
        console.log('üîç Assigned users data:', appData.assigned_users);
        
        // Restore form fields with enhanced logic
        Object.keys(appData).forEach(key => {
            // Try multiple selectors to find the field
            let field = document.querySelector(`[name="${key}"]`) || 
                       document.querySelector(`#${key}`) ||
                       document.querySelector(`input[name="${key}"]`) ||
                       document.querySelector(`select[name="${key}"]`) ||
                       document.querySelector(`textarea[name="${key}"]`);
            
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = appData[key] === 1 || appData[key] === true || appData[key] === '1';
                    // Trigger change event for checkboxes to update dependent fields
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (field.type === 'file') {
                    // Skip file inputs but log for debugging
                    console.log(`Skipping file field ${key}, value was: ${appData[key]}`);
                } else if (field.type === 'select-one') {
                    // Special handling for select fields
                    field.value = appData[key] || '';
                    // Trigger change event for selects to update dependent fields
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                } else {
                    field.value = appData[key] || '';
                    // Trigger input event for text fields
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
                console.log(`‚úÖ Restored field ${key}: ${appData[key]}`);
                
                // Mark field as successfully restored for visual feedback
                if (field.type !== 'checkbox' && field.value) {
                    field.classList.add('success');
                    field.classList.remove('error', 'warning');
                }
            } else {
                console.log(`‚ö†Ô∏è Field not found in form: ${key}`);
            }
        });
        
        // Special handling for industry type to trigger sub-industry update
        if (appData.industry_type) {
            console.log('üè≠ Triggering sub-industry update for:', appData.industry_type);
            setTimeout(() => {
                if (typeof updateSubIndustryOptions === 'function') {
                    updateSubIndustryOptions();
                }
            }, 100);
        }
        
        // Restore child table data (units and assigned_users)
        console.log('üîç About to call restoreChildTableData...');
        this.restoreChildTableData(appData);
        console.log('üîç restoreChildTableData call completed');
        
        // Update form data object
        this.formData = { ...appData };
        
        // Force update of any dynamic elements
        this.updateFormState();
        
        console.log('‚úÖ Form data restoration completed successfully');
    }
    
    updateFormState() {
        console.log('üîÑ Updating form state after data restoration');
        
        // Update any scope-dependent fields
        const scopeCheckboxes = document.querySelectorAll('input[name^="scopes_to_report_"]');
        scopeCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const scopeName = checkbox.name.replace('scopes_to_report_', '');
                if (typeof toggleScopeOptions === 'function') {
                    toggleScopeOptions(scopeName);
                }
            }
        });
        
        // Update monitoring frequency dependent fields
        const monitoringFreq = document.getElementById('monitoring_frequency');
        if (monitoringFreq && monitoringFreq.value === 'Other') {
            if (typeof toggleOtherFrequency === 'function') {
                toggleOtherFrequency();
            }
        }
        
        // Update software name field if software checkbox is checked
        const softwareCheckbox = document.querySelector('input[name="ghg_tracking_tools_software"]');
        if (softwareCheckbox && softwareCheckbox.checked) {
            if (typeof toggleSoftwareName === 'function') {
                toggleSoftwareName();
            }
        }
        
        console.log('‚úÖ Form state update completed');
    }
    
    restoreChildTableData(appData) {
        console.log('üîç restoreChildTableData function called');
        console.log('üîç AppData received:', appData);
        console.log('üîç AppData type:', typeof appData);
        console.log('üîç AppData keys:', Object.keys(appData));
        console.log('üîç Units:', appData.units);
        console.log('üîç Assigned users:', appData.assigned_users);
        console.log('Restoring child table data:', appData);
        
        // Restore units data
        if (appData.units && Array.isArray(appData.units)) {
            console.log(`Restoring ${appData.units.length} units...`);
            
            // Clear existing units
            this.unitsContainer.innerHTML = '';
            this.unitCounter = 0;
            this.userCounters = {};
            
            // Restore each unit
            appData.units.forEach((unitData, unitIndex) => {
                this.addUnit();
                const unitNumber = unitIndex + 1;
                const unitContainer = this.unitsContainer.querySelector(`[data-unit-number="${unitNumber}"]`);
                
                if (unitContainer) {
                    // Map unit data to CSS classes
                    const unitFieldMappings = {
                        'type_of_unit': '.unit-type',
                        'name_of_unit': '.unit-name',
                        'size_of_unit': '.unit-size',
                        'address': '.unit-address',
                        'gst': '.unit-gst',
                        'phone_number': '.unit-phone',
                        'position': '.unit-position',
                        'gps_coordinates': '.unit-gps-coordinates',
                        'location_name': '.unit-location-name'
                    };
                    
                    Object.keys(unitFieldMappings).forEach(dataField => {
                        const cssSelector = unitFieldMappings[dataField];
                        const field = unitContainer.querySelector(cssSelector);
                        if (field && unitData[dataField]) {
                            field.value = unitData[dataField];
                            console.log(`Restored unit ${unitNumber} field ${dataField}: ${unitData[dataField]}`);
                        }
                    });
                }
            });
            
            console.log('‚úÖ Units restored successfully');
        } else {
            console.log('No units data found in session');
        }
        
        // Restore assigned users data (separate child table)
        if (appData.assigned_users && Array.isArray(appData.assigned_users)) {
            console.log(`Restoring ${appData.assigned_users.length} assigned users...`);
            
            // Group users by assigned unit
            const usersByUnit = {};
            appData.assigned_users.forEach(userData => {
                const unitName = userData.assigned_unit;
                if (!usersByUnit[unitName]) {
                    usersByUnit[unitName] = [];
                }
                usersByUnit[unitName].push(userData);
            });
            
            // Add users to their respective units
            Object.keys(usersByUnit).forEach(unitName => {
                // Find unit container by unit name
                const unitContainers = this.unitsContainer.querySelectorAll('.unit-container');
                let targetUnitContainer = null;
                
                for (const unitContainer of unitContainers) {
                    const unitNameField = unitContainer.querySelector('.unit-name');
                    if (unitNameField && unitNameField.value === unitName) {
                        targetUnitContainer = unitContainer;
                        break;
                    }
                }
                
                if (targetUnitContainer) {
                    const unitNumber = parseInt(targetUnitContainer.dataset.unitNumber);
                    const users = usersByUnit[unitName];
                    
                    console.log(`Adding ${users.length} users to unit: ${unitName}`);
                    
                    users.forEach((userData, userIndex) => {
                        this.addUser(unitNumber);
                        const userNumber = userIndex + 1;
                        const userContainer = targetUnitContainer.querySelector(`[data-user-number="${userNumber}"]`);
                        
                        if (userContainer) {
                            // Map user data to CSS classes
                            const userFieldMappings = {
                                'email': '.user-email',
                                'first_name': '.user-first-name',
                                'user_role': '.user-role'
                            };
                            
                            Object.keys(userFieldMappings).forEach(dataField => {
                                const cssSelector = userFieldMappings[dataField];
                                const field = userContainer.querySelector(cssSelector);
                                if (field && userData[dataField]) {
                                    field.value = userData[dataField];
                                    console.log(`Restored user ${userNumber} field ${dataField}: ${userData[dataField]}`);
                                }
                            });
                        }
                    });
                } else {
                    console.log(`‚ö†Ô∏è Unit container not found for unit name: ${unitName}`);
                }
            });
            
            console.log('‚úÖ Assigned users restored successfully');
        } else {
            console.log('No assigned users data found in session');
        }
    }
    
    goToStep(stepNumber) {
        console.log(`Going to step ${stepNumber}`);
        
        // Hide all steps
        for (let i = 1; i <= this.totalSteps; i++) {
            const stepElement = document.getElementById(`step${i}`);
            if (stepElement) {
                stepElement.style.display = 'none';
            }
        }
        
        // Show the target step
        const targetStep = document.getElementById(`step${stepNumber}`);
        if (targetStep) {
            targetStep.style.display = 'block';
            this.currentStep = stepNumber;
        }
        
        // Update progress indicators
        this.updateProgress();
    }
    
    initializeForm() {
        this.form = document.getElementById('onboarding-form');
        this.prevBtn = document.getElementById('prev-btn');
        this.nextBtn = document.getElementById('next-btn');
        this.submitBtn = document.getElementById('submit-btn');
        this.unitsContainer = document.getElementById('units-container');
        this.addUnitBtn = document.getElementById('add-unit-btn');
        this.unitCounter = 0;
        this.userCounters = {};
        
        this.updateNavigation();
        this.updateProgress();
        this.initializeFileUploads();
        
        // Setup automatic form data preservation
        this.setupAutoSave();
    }
    
    setupAutoSave() {
        console.log('üîÑ Setting up auto-save functionality');
        
        // Save form data on any input change (debounced)
        let saveTimeout;
        const debouncedSave = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                this.saveFormDataToLocal();
            }, 1000); // Save 1 second after user stops typing
        };
        
        document.addEventListener('input', debouncedSave);
        document.addEventListener('change', debouncedSave);
        
        // Save before page unload
        window.addEventListener('beforeunload', () => {
            this.saveFormDataToLocal();
        });
        
        console.log('‚úÖ Auto-save setup completed');
    }
    
    saveFormDataToLocal() {
        try {
            // Only save if not in resume mode to avoid overwriting resume data
            if (window.isResumeMode) {
                console.log('üîÑ Skipping local save - in resume mode');
                return;
            }
            
            const formData = this.collectBasicFormData();
            const backupData = {
                data: formData,
                timestamp: new Date().toISOString(),
                currentStep: this.currentStep,
                units: this.collectUnitsData(),
                assignedUsers: this.collectAssignedUsersData()
            };
            
            localStorage.setItem('onboarding_form_backup', JSON.stringify(backupData));
            console.log('üíæ Form data saved to local storage at', backupData.timestamp);
        } catch (error) {
            console.warn('‚ö†Ô∏è Failed to save form data to local storage:', error);
        }
    }
    
    restoreFromLocalBackup() {
        try {
            if (window.isResumeMode || window.resumeSessionData) {
                console.log('üîÑ Skipping local backup restore - resume data available');
                return null;
            }
            
            const backup = localStorage.getItem('onboarding_form_backup');
            if (backup) {
                const parsed = JSON.parse(backup);
                console.log('üîÑ Found local backup from:', parsed.timestamp);
                
                // Only restore if backup is less than 24 hours old
                const backupDate = new Date(parsed.timestamp);
                const now = new Date();
                const hoursDiff = (now - backupDate) / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    console.log('‚úÖ Local backup is recent, can be restored');
                    return parsed;
                } else {
                    console.log('‚è∞ Local backup is too old, clearing it');
                    localStorage.removeItem('onboarding_form_backup');
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Failed to restore from local backup:', error);
        }
        return null;
    }
    
    collectBasicFormData() {
        const formData = {};
        
        // Collect all form fields
        const inputs = this.form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.name) {
                if (input.type === 'checkbox') {
                    formData[input.name] = input.checked ? '1' : '';
                } else if (input.type !== 'file') {
                    formData[input.name] = input.value || '';
                }
            }
        });
        
        return formData;
    }
    
    restoreFromBackup(backupData) {
        console.log('üîÑ Restoring form from local backup');
        
        if (backupData.data) {
            // Restore basic form data
            Object.keys(backupData.data).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === 'checkbox') {
                        field.checked = backupData.data[key] === '1' || backupData.data[key] === true;
                    } else if (field.type !== 'file') {
                        field.value = backupData.data[key] || '';
                    }
                    console.log(`‚úÖ Restored ${key}: ${backupData.data[key]}`);
                }
            });
        }
        
        // Restore current step
        if (backupData.currentStep) {
            this.currentStep = backupData.currentStep;
            this.goToStep(this.currentStep);
        }
        
        // Restore units and users
        if (backupData.units) {
            this.restoreUnitsFromBackup(backupData.units);
        }
        
        console.log('‚úÖ Local backup restoration completed');
    }
    
    restoreUnitsFromBackup(unitsData) {
        console.log('üîÑ Restoring units from backup:', unitsData);
        // Implementation would go here - for now just log
        // This would need to recreate the unit elements and populate them
    }
    
    bindEvents() {
        this.prevBtn.addEventListener('click', () => this.previousStep());
        this.nextBtn.addEventListener('click', async () => await this.nextStep());
        this.submitBtn.addEventListener('click', (e) => this.submitForm(e));
        this.addUnitBtn.addEventListener('click', () => this.addUnit());
        
        // Form validation with real-time feedback
        this.form.addEventListener('input', (e) => this.handleFieldInput(e));
        this.form.addEventListener('blur', (e) => this.handleFieldBlur(e));
        this.form.addEventListener('change', (e) => this.handleFieldChange(e));
        
        // Check for verification token in URL
        this.checkVerificationToken();
    }
    
    async loadSavedData() {
        try {
            // Get CSRF token
            let csrfToken = frappe?.csrf_token;
            if (!csrfToken) {
                csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                           document.querySelector('meta[name="csrf_token"]')?.getAttribute('content') ||
                           document.querySelector('input[name="csrf_token"]')?.value ||
                           window.csrf_token;
            }
            
            // Create params for API call
            const params = new URLSearchParams();
            if (csrfToken) {
                params.append('csrf_token', csrfToken);
            }
            
            const response = await fetch('/api/method/climoro_onboarding.www.apply.api.get_saved_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Frappe-CSRF-Token': csrfToken || ''
                },
                body: params.toString()
            });
            
            const result = await response.json();
            
            if (result.message && result.message.success && result.message.data) {
                const savedData = result.message.data;
                console.log('üì• Loaded saved data:', savedData);
                
                // Restore form fields with saved data
                if (savedData.first_name) {
                    const firstNameField = document.getElementById('first_name');
                    if (firstNameField) firstNameField.value = savedData.first_name;
                }
                
                if (savedData.middle_name) {
                    const middleNameField = document.getElementById('middle_name');
                    if (middleNameField) middleNameField.value = savedData.middle_name;
                }
                
                if (savedData.last_name) {
                    const lastNameField = document.getElementById('last_name');
                    if (lastNameField) {
                        lastNameField.value = savedData.last_name;
                        console.log('üîç Restored Last Name:', savedData.last_name);
                    }
                }
                
                if (savedData.phone_number) {
                    const phoneField = document.getElementById('phone_number');
                    if (phoneField) phoneField.value = savedData.phone_number;
                }
                
                if (savedData.email) {
                    const emailField = document.getElementById('email');
                    if (emailField) emailField.value = savedData.email;
                }
                
                if (savedData.position) {
                    const positionField = document.getElementById('position');
                    if (positionField) positionField.value = savedData.position;
                }
                
                if (savedData.company_name) {
                    const companyNameField = document.getElementById('company_name');
                    if (companyNameField) companyNameField.value = savedData.company_name;
                }
                
                if (savedData.address) {
                    const addressField = document.getElementById('address');
                    if (addressField) addressField.value = savedData.address;
                }
                
                if (savedData.gps_coordinates) {
                    const gpsField = document.getElementById('gps_coordinates');
                    if (gpsField) gpsField.value = savedData.gps_coordinates;
                }
                
                if (savedData.location_name) {
                    const locationNameField = document.getElementById('location_name');
                    if (locationNameField) locationNameField.value = savedData.location_name;
                }
                
                if (savedData.cin) {
                    const cinField = document.getElementById('cin');
                    if (cinField) cinField.value = savedData.cin;
                }
                
                if (savedData.gst_number) {
                    const gstField = document.getElementById('gst_number');
                    if (gstField) gstField.value = savedData.gst_number;
                }
                
                if (savedData.industry_type) {
                    const industryField = document.getElementById('industry_type');
                    if (industryField) {
                        industryField.value = savedData.industry_type;
                        // Trigger the change event to update sub-industry options
                        updateSubIndustryOptions();
                    }
                }
                
                if (savedData.sub_industry_type) {
                    const subIndustryField = document.getElementById('sub_industry_type');
                    if (subIndustryField) subIndustryField.value = savedData.sub_industry_type;
                }
                
                if (savedData.website) {
                    const websiteField = document.getElementById('website');
                    if (websiteField) websiteField.value = savedData.website;
                }
                
                if (savedData.letter_of_authorisation) {
                    const fileField = document.getElementById('letter_of_authorisation');
                    if (fileField) fileField.setAttribute('data-file-url', savedData.letter_of_authorisation);
                }
                
                // Load GHG Accounting fields (Step 4)
                if (savedData.purpose_of_reporting) {
                    const purposeField = document.getElementById('purpose_of_reporting');
                    if (purposeField) purposeField.value = savedData.purpose_of_reporting;
                }
                
                // Load individual gas checkboxes
                if (savedData.gases_to_report_co2) {
                    const co2Field = document.querySelector('input[name="gases_to_report_co2"]');
                    if (co2Field) co2Field.checked = true;
                }
                if (savedData.gases_to_report_ch4) {
                    const ch4Field = document.querySelector('input[name="gases_to_report_ch4"]');
                    if (ch4Field) ch4Field.checked = true;
                }
                if (savedData.gases_to_report_n2o) {
                    const n2oField = document.querySelector('input[name="gases_to_report_n2o"]');
                    if (n2oField) n2oField.checked = true;
                }
                if (savedData.gases_to_report_hfcs) {
                    const hfcsField = document.querySelector('input[name="gases_to_report_hfcs"]');
                    if (hfcsField) hfcsField.checked = true;
                }
                if (savedData.gases_to_report_pfcs) {
                    const pfcsField = document.querySelector('input[name="gases_to_report_pfcs"]');
                    if (pfcsField) pfcsField.checked = true;
                }
                if (savedData.gases_to_report_sf6) {
                    const sf6Field = document.querySelector('input[name="gases_to_report_sf6"]');
                    if (sf6Field) sf6Field.checked = true;
                }
                if (savedData.gases_to_report_nf3) {
                    const nf3Field = document.querySelector('input[name="gases_to_report_nf3"]');
                    if (nf3Field) nf3Field.checked = true;
                }
                
                // Load individual scope checkboxes and initialize scope options
                if (savedData.scopes_to_report_scope1) {
                    const scope1Field = document.querySelector('input[name="scopes_to_report_scope1"]');
                    if (scope1Field) {
                        scope1Field.checked = true;
                        toggleScopeOptions('scope1');
                    }
                }
                if (savedData.scopes_to_report_scope2) {
                    const scope2Field = document.querySelector('input[name="scopes_to_report_scope2"]');
                    if (scope2Field) {
                        scope2Field.checked = true;
                        toggleScopeOptions('scope2');
                    }
                }
                if (savedData.scopes_to_report_scope3) {
                    const scope3Field = document.querySelector('input[name="scopes_to_report_scope3"]');
                    if (scope3Field) {
                        scope3Field.checked = true;
                        toggleScopeOptions('scope3');
                    }
                }
                if (savedData.scopes_to_report_reductions) {
                    const reductionsField = document.querySelector('input[name="scopes_to_report_reductions"]');
                    if (reductionsField) {
                        reductionsField.checked = true;
                        toggleScopeOptions('reductions');
                    }
                }
                
                // Load individual scope 1 options
                if (savedData.scope_1_options_process) {
                    const processField = document.querySelector('input[name="scope_1_options_process"]');
                    if (processField) processField.checked = true;
                }
                if (savedData.scope_1_options_stationary) {
                    const stationaryField = document.querySelector('input[name="scope_1_options_stationary"]');
                    if (stationaryField) stationaryField.checked = true;
                }
                if (savedData.scope_1_options_mobile) {
                    const mobileField = document.querySelector('input[name="scope_1_options_mobile"]');
                    if (mobileField) mobileField.checked = true;
                }
                if (savedData.scope_1_options_fugitive) {
                    const fugitiveField = document.querySelector('input[name="scope_1_options_fugitive"]');
                    if (fugitiveField) fugitiveField.checked = true;
                }
                
                // Load individual scope 2 options
                if (savedData.scope_2_options_electricity) {
                    const electricityField = document.querySelector('input[name="scope_2_options_electricity"]');
                    if (electricityField) electricityField.checked = true;
                }
                if (savedData.scope_2_options_heating) {
                    const heatingField = document.querySelector('input[name="scope_2_options_heating"]');
                    if (heatingField) heatingField.checked = true;
                }
                if (savedData.scope_2_options_cooling) {
                    const coolingField = document.querySelector('input[name="scope_2_options_cooling"]');
                    if (coolingField) coolingField.checked = true;
                }
                
                // Load individual scope 3 options
                if (savedData.scope_3_options_upstream) {
                    const upstreamField = document.querySelector('input[name="scope_3_options_upstream"]');
                    if (upstreamField) upstreamField.checked = true;
                }
                if (savedData.scope_3_options_downstream) {
                    const downstreamField = document.querySelector('input[name="scope_3_options_downstream"]');
                    if (downstreamField) downstreamField.checked = true;
                }
                
                // Load individual reduction options
                if (savedData.reduction_options_energy_efficiency) {
                    const energyEfficiencyField = document.querySelector('input[name="reduction_options_energy_efficiency"]');
                    if (energyEfficiencyField) energyEfficiencyField.checked = true;
                }
                if (savedData.reduction_options_renewable_energy) {
                    const renewableEnergyField = document.querySelector('input[name="reduction_options_renewable_energy"]');
                    if (renewableEnergyField) renewableEnergyField.checked = true;
                }
                if (savedData.reduction_options_process_optimization) {
                    const processOptimizationField = document.querySelector('input[name="reduction_options_process_optimization"]');
                    if (processOptimizationField) processOptimizationField.checked = true;
                }
                if (savedData.reduction_options_waste_management) {
                    const wasteManagementField = document.querySelector('input[name="reduction_options_waste_management"]');
                    if (wasteManagementField) wasteManagementField.checked = true;
                }
                if (savedData.reduction_options_transportation) {
                    const transportationField = document.querySelector('input[name="reduction_options_transportation"]');
                    if (transportationField) transportationField.checked = true;
                }
                if (savedData.reduction_options_other) {
                    const otherField = document.querySelector('input[name="reduction_options_other"]');
                    if (otherField) otherField.checked = true;
                }
                
                        // Load Step 6: Method of Calculation data
        if (savedData.method_of_calculation_option_a) {
            const optionAField = document.querySelector('input[name="method_of_calculation_option_a"]');
            if (optionAField) optionAField.checked = true;
        }
        if (savedData.method_of_calculation_option_b) {
            const optionBField = document.querySelector('input[name="method_of_calculation_option_b"]');
            if (optionBField) optionBField.checked = true;
        }
        if (savedData.method_of_calculation_option_c) {
            const optionCField = document.querySelector('input[name="method_of_calculation_option_c"]');
            if (optionCField) optionCField.checked = true;
        }
        if (savedData.method_of_calculation_option_d) {
            const optionDField = document.querySelector('input[name="method_of_calculation_option_d"]');
            if (optionDField) optionDField.checked = true;
        }
        if (savedData.method_of_calculation_option_e) {
            const optionEField = document.querySelector('input[name="method_of_calculation_option_e"]');
            if (optionEField) optionEField.checked = true;
        }
        if (savedData.method_of_calculation_option_f) {
            const optionFField = document.querySelector('input[name="method_of_calculation_option_f"]');
            if (optionFField) optionFField.checked = true;
        }
        if (savedData.method_of_calculation_option_g) {
            const optionGField = document.querySelector('input[name="method_of_calculation_option_g"]');
            if (optionGField) optionGField.checked = true;
        }
                
                console.log('‚úÖ Saved data restored successfully');
            } else {
                console.log('üì≠ No saved data found or error loading data');
            }
        } catch (error) {
            console.error('‚ùå Error loading saved data:', error);
        }
    }

    async nextStep() {
        if (this.validateCurrentStep()) {
            // Check if there are any warnings
            const warnings = this.getCurrentWarnings();
            
            if (warnings.length > 0) {
                // Show confirmation dialog for warnings
                const shouldProceed = await this.showWarningConfirmation(warnings);
                if (!shouldProceed) {
                    return;
                }
            }
            
            // If completing Step 1, send verification email (unless in resume mode)
            if (this.currentStep === 1) {
                console.log('Step 1 completion - checking resume mode...');
                console.log('window.isResumeMode:', window.isResumeMode);
                console.log('window.resumeSessionData:', window.resumeSessionData);
                
                // Check if we're in resume mode
                if (window.isResumeMode || window.resumeSessionData) {
                    console.log('üîÑ Resume mode detected - skipping verification email and proceeding to step 2');
                    this.currentStep++;
                    this.updateStep();
                    return;
                } else {
                    console.log('üìß Normal mode - sending verification email');
                    await this.sendVerificationEmail();
                    return;
                }
            }
            
            // Save current step data before moving to next step
            if (this.currentStep >= 2 && this.currentStep <= 6) {
                console.log('üîç nextStep: About to call saveStepData for step:', this.currentStep);
                const saveSuccess = await this.saveStepData();
                console.log('üîç nextStep: saveStepData returned:', saveSuccess);
                if (!saveSuccess) {
                    console.log('‚ùå Failed to save step data, not proceeding to next step');
                    return;
                }
            }
            
            if (this.currentStep < this.totalSteps) {
                this.currentStep++;
                this.updateStep();
            }
        }
    }
    
    previousStep() {
        if (this.currentStep > 1) {
            this.currentStep--;
            this.updateStep();
        }
    }
    
    updateStep() {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Show current step
        document.getElementById(`step-${this.currentStep}`).classList.add('active');
        
        this.updateNavigation();
        this.updateProgress();
        this.validateCurrentStep();
    }
    
    updateNavigation() {
        console.log('Form class updateNavigation called with currentStep:', this.currentStep);
        console.log('Total steps:', this.totalSteps);
        
        const showPrev = this.currentStep > 1;
        const showNext = this.currentStep < this.totalSteps;
        const showSubmit = this.currentStep === this.totalSteps;
        
        console.log('Show prev button:', showPrev);
        console.log('Show next button:', showNext);
        console.log('Show submit button:', showSubmit);
        
        this.prevBtn.style.display = showPrev ? 'block' : 'none';
        this.nextBtn.style.display = showNext ? 'block' : 'none';
        this.submitBtn.style.display = showSubmit ? 'block' : 'none';
        
        console.log('Navigation buttons updated');
    }
    
    updateProgress() {
        document.querySelectorAll('.onboarding-progress-step').forEach((step, index) => {
            const stepNumber = index + 1;
            
            // Remove all classes
            step.classList.remove('onboarding-completed', 'onboarding-current');
            
            if (stepNumber < this.currentStep) {
                // Completed steps
                step.classList.add('onboarding-completed');
            } else if (stepNumber === this.currentStep) {
                // Current step
                step.classList.add('onboarding-current');
            }
        });
        
        // Update progress lines
        document.querySelectorAll('.onboarding-progress-line').forEach((line, index) => {
            const lineNumber = index + 1;
            if (lineNumber < this.currentStep) {
                line.classList.add('onboarding-completed');
            } else {
                line.classList.remove('onboarding-completed');
            }
        });
    }
    
    // Method to handle resume functionality
    handleResume(resumeData) {
        console.log('üîç OnboardingForm handleResume called with:', resumeData);
        
        if (resumeData && resumeData.application_data) {
            const appData = resumeData.application_data;
            const currentStep = resumeData.current_step || 1;
            
            console.log('üîç Resuming application at step:', currentStep);
            console.log('üîç Application data keys:', Object.keys(appData));
            console.log('üîç Units data present:', !!appData.units);
            console.log('üîç Assigned users data present:', !!appData.assigned_users);
            
            // Set current step
            this.currentStep = currentStep;
            
            // Restore form data
            console.log('üîç About to call restoreFormDataFromSession...');
            this.restoreFormDataFromSession(appData);
            console.log('üîç restoreFormDataFromSession completed');
            
            // Update UI
            this.showStep(this.currentStep);
            this.updateNavigation();
            this.updateProgress();
            
            console.log('üîç OnboardingForm resume completed successfully');
        } else if (resumeData && resumeData.current_step) {
            console.log('Form class handling resume to step:', resumeData.current_step);
            this.currentStep = resumeData.current_step;
            this.showStep(this.currentStep);
            this.updateNavigation();
            this.updateProgress();
        } else {
            console.log('‚ùå No valid resume data provided');
        }
    }
    
    // Method to restore form data from session
    restoreFormDataFromSession(appData) {
        console.log('üîç üîç üîç OnboardingForm restoreFormDataFromSession FUNCTION CALLED üîç üîç üîç');
        console.log('üîç Restoring form data from session:', appData);
        console.log('üîç Application data keys:', Object.keys(appData));
        console.log('üîç Units data:', appData.units);
        console.log('üîç Assigned users data:', appData.assigned_users);
        
        // Restore form fields
        Object.keys(appData).forEach(key => {
            const field = document.querySelector(`[name="${key}"]`);
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = appData[key] === 1 || appData[key] === true;
                    // Trigger change event for checkboxes to update dependent options
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (field.type === 'file') {
                    // Skip file inputs
                    console.log(`Skipping file field ${key}`);
                } else {
                    field.value = appData[key] || '';
                }
                console.log(`Restored field ${key}: ${appData[key]}`);
            } else {
                console.log(`Field name not found in form: ${key}`);
            }
        });
        
        // Trigger change events for select fields to update dependent dropdowns
        document.querySelectorAll('select').forEach(select => {
            if (select.value) {
                select.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        
        // Restore child table data (units and assigned_users)
        console.log('üîç About to call restoreChildTableData...');
        this.restoreChildTableData(appData);
        console.log('üîç restoreChildTableData call completed');
        
        // Update form data object
        this.formData = { ...appData };
    }
    
    // Method to restore child table data
    restoreChildTableData(appData) {
        console.log('üîç OnboardingForm restoreChildTableData function called');
        console.log('üîç AppData received:', appData);
        console.log('üîç AppData type:', typeof appData);
        console.log('üîç AppData keys:', Object.keys(appData));
        console.log('üîç Units:', appData.units);
        console.log('üîç Assigned users:', appData.assigned_users);
        console.log('Restoring child table data:', appData);
        
        // Restore units data
        if (appData.units && Array.isArray(appData.units)) {
            console.log(`Restoring ${appData.units.length} units...`);
            
            // Clear existing units
            this.unitsContainer.innerHTML = '';
            this.unitCounter = 0;
            this.userCounters = {};
            
            // Restore each unit
            appData.units.forEach((unitData, unitIndex) => {
                this.addUnit();
                const unitNumber = unitIndex + 1;
                const unitContainer = this.unitsContainer.querySelector(`[data-unit-number="${unitNumber}"]`);
                
                if (unitContainer) {
                    // Map unit data to CSS classes
                    const unitFieldMappings = {
                        'type_of_unit': '.unit-type',
                        'name_of_unit': '.unit-name',
                        'size_of_unit': '.unit-size',
                        'address': '.unit-address',
                        'gst': '.unit-gst',
                        'phone_number': '.unit-phone',
                        'position': '.unit-position',
                        'gps_coordinates': '.unit-gps-coordinates',
                        'location_name': '.unit-location-name'
                    };
                    
                    Object.keys(unitFieldMappings).forEach(dataField => {
                        const cssSelector = unitFieldMappings[dataField];
                        const field = unitContainer.querySelector(cssSelector);
                        if (field && unitData[dataField]) {
                            field.value = unitData[dataField];
                            console.log(`Restored unit ${unitNumber} field ${dataField}: ${unitData[dataField]}`);
                        }
                    });
                }
            });
            
            console.log('‚úÖ Units restored successfully');
        } else {
            console.log('No units data found in session');
        }
        
        // Restore assigned users data (separate child table)
        if (appData.assigned_users && Array.isArray(appData.assigned_users)) {
            console.log(`Restoring ${appData.assigned_users.length} assigned users...`);
            
            // Group users by assigned unit
            const usersByUnit = {};
            appData.assigned_users.forEach(userData => {
                const unitName = userData.assigned_unit;
                if (!usersByUnit[unitName]) {
                    usersByUnit[unitName] = [];
                }
                usersByUnit[unitName].push(userData);
            });
            
            // Add users to their respective units
            Object.keys(usersByUnit).forEach(unitName => {
                // Find unit container by unit name
                const unitContainers = this.unitsContainer.querySelectorAll('.unit-container');
                let targetUnitContainer = null;
                
                for (const unitContainer of unitContainers) {
                    const unitNameField = unitContainer.querySelector('.unit-name');
                    if (unitNameField && unitNameField.value === unitName) {
                        targetUnitContainer = unitContainer;
                        break;
                    }
                }
                
                if (targetUnitContainer) {
                    const unitNumber = parseInt(targetUnitContainer.dataset.unitNumber);
                    const users = usersByUnit[unitName];
                    
                    console.log(`Adding ${users.length} users to unit: ${unitName}`);
                    
                    users.forEach((userData, userIndex) => {
                        this.addUser(unitNumber);
                        const userNumber = userIndex + 1;
                        const userContainer = targetUnitContainer.querySelector(`[data-user-number="${userNumber}"]`);
                        
                        if (userContainer) {
                            // Map user data to CSS classes
                            const userFieldMappings = {
                                'email': '.user-email',
                                'first_name': '.user-first-name',
                                'user_role': '.user-role'
                            };
                            
                            Object.keys(userFieldMappings).forEach(dataField => {
                                const cssSelector = userFieldMappings[dataField];
                                const field = userContainer.querySelector(cssSelector);
                                if (field && userData[dataField]) {
                                    field.value = userData[dataField];
                                    console.log(`Restored user ${userNumber} field ${dataField}: ${userData[dataField]}`);
                                }
                            });
                        }
                    });
                } else {
                    console.log(`‚ö†Ô∏è Unit container not found for unit name: ${unitName}`);
                }
            });
            
            console.log('‚úÖ Assigned users restored successfully');
        } else {
            console.log('No assigned users data found in session');
        }
    }
    
    // Form class showStep method
    showStep(step) {
        console.log('Form class showStep called with step:', step);
        
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(stepElement => {
            stepElement.classList.remove('active');
        });
        
        // Show current step
        const currentStepElement = document.getElementById(`step-${step}`);
        if (currentStepElement) {
            currentStepElement.classList.add('active');
            console.log('Form class activated step element:', `step-${step}`);
        } else {
            console.log('Form class step element not found:', `step-${step}`);
        }
        
        // Update navigation and progress
        this.updateNavigation();
        this.updateProgress();
    }
    
    validateCurrentStep() {
        let isValid = true;
        let warnings = [];
        
        // Clear previous warnings
        this.clearWarnings();
        
        // Only validate current step fields, not all fields from all steps
        const currentStepElement = document.getElementById(`step-${this.currentStep}`);
        const requiredFields = currentStepElement.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            const fieldName = field.name || field.id;
            const fieldValue = field.value.trim();
            
            // Debug: Log validation for last_name field
            if (fieldName === 'last_name') {
                console.log('üîç Last Name Validation Debug:');
                console.log('   Field element:', field);
                console.log('   Field name:', fieldName);
                console.log('   Field value:', fieldValue);
                console.log('   Field value length:', fieldValue.length);
                console.log('   Is empty:', !fieldValue);
            }
            
            if (!fieldValue) {
                field.classList.add('error');
                field.classList.remove('success');
                isValid = false;
                warnings.push(`${this.getFieldLabel(field)} is required`);
            } else {
                // Additional validation for specific fields
                const fieldWarning = this.validateField(field, fieldValue);
                if (fieldWarning) {
                    field.classList.add('warning');
                    field.classList.remove('success');
                    warnings.push(fieldWarning);
                } else {
                    field.classList.remove('error', 'warning');
                    // Don't add success class to checkboxes
                    if (field.type !== 'checkbox') {
                        field.classList.add('success');
                    }
                }
            }
        });
        
        // Additional step-specific validation
        if (this.currentStep === 1) {
            const emailField = document.getElementById('email');
            const phoneField = document.getElementById('phone_number');
            
            if (emailField && emailField.value) {
                const emailWarning = this.validateEmail(emailField.value);
                if (emailWarning) {
                    emailField.classList.add('warning');
                    warnings.push(emailWarning);
                }
            }
            
            if (phoneField && phoneField.value) {
                const phoneWarning = this.validatePhone(phoneField.value);
                if (phoneWarning) {
                    phoneField.classList.add('warning');
                    warnings.push(phoneWarning);
                }
            }
        }
        
        this.nextBtn.disabled = !isValid;
        this.submitBtn.disabled = !isValid;
        
        // Show warnings if any
        if (warnings.length > 0) {
            this.showWarnings(warnings);
        }
        
        return isValid;
    }
    
    validateField(field, value) {
        const fieldName = field.name || field.id;
        
        switch (fieldName) {
            case 'email':
                return this.validateEmail(value);
            case 'phone_number':
                return this.validatePhone(value);
            case 'first_name':
                return this.validateName(value);
            case 'company_name':
                return this.validateCompanyName(value);
            case 'cin':
                return this.validateCIN(value);
            case 'gst_number':
                return this.validateGST(value);
            default:
                return null;
        }
    }
    
    validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            return 'Please enter a valid email address';
        }
        return null;
    }
    
    validatePhone(phone) {
        const digitsOnly = phone.replace(/\D/g, '');
        if (digitsOnly.length < 7) {
            return 'Phone number should be at least 7 digits';
        }
        if (digitsOnly.length > 15) {
            return 'Phone number cannot exceed 15 digits';
        }
        return null;
    }
    
    validateName(name) {
        if (name.length < 2) {
            return 'Name should be at least 2 characters long';
        }
        if (name.length > 50) {
            return 'Name cannot exceed 50 characters';
        }
        return null;
    }
    
    validateCompanyName(name) {
        if (name.length < 2) {
            return 'Company name should be at least 2 characters long';
        }
        if (name.length > 100) {
            return 'Company name cannot exceed 100 characters';
        }
        return null;
    }
    
    validateCIN(cin) {
        if (cin.length < 5) {
            return 'CIN should be at least 5 characters long';
        }
        return null;
    }
    
    validateGST(gst) {
        if (gst.length < 10) {
            return 'GST Number should be at least 10 characters long';
        }
        return null;
    }
    
    getFieldLabel(field) {
        const label = field.closest('.form-group')?.querySelector('label');
        return label ? label.textContent.replace(' *', '') : field.name || field.id;
    }
    
    clearWarnings() {
        // Remove existing warning messages
        const existingWarnings = document.querySelectorAll('.validation-warnings');
        existingWarnings.forEach(warning => warning.remove());
        
        // Remove warning classes from fields
        document.querySelectorAll('.warning').forEach(field => {
            field.classList.remove('warning');
        });
    }
    
    showWarnings(warnings) {
        // Create warning container
        const warningContainer = document.createElement('div');
        warningContainer.className = 'validation-warnings';
        warningContainer.style.cssText = `
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
            font-size: 14px;
        `;
        
        // Create warning header
        const warningHeader = document.createElement('div');
        warningHeader.style.cssText = `
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        `;
        warningHeader.innerHTML = `
            <span style="font-size: 16px;">‚ö†Ô∏è</span>
            <span>Please review the following issues:</span>
        `;
        warningContainer.appendChild(warningHeader);
        
        // Create warning list
        const warningList = document.createElement('ul');
        warningList.style.cssText = `
            margin: 0;
            padding-left: 20px;
        `;
        
        warnings.forEach(warning => {
            const listItem = document.createElement('li');
            listItem.textContent = warning;
            listItem.style.marginBottom = '5px';
            warningList.appendChild(listItem);
        });
        
        warningContainer.appendChild(warningList);
        
        // Insert warning before the navigation buttons
        const currentStepElement = document.getElementById(`step-${this.currentStep}`);
        const navigationElement = currentStepElement.querySelector('.form-navigation');
        if (navigationElement) {
            currentStepElement.insertBefore(warningContainer, navigationElement);
        } else {
            currentStepElement.appendChild(warningContainer);
        }
    }
    
    handleFieldInput(e) {
        const field = e.target;
        if (field.matches('input, select, textarea')) {
            this.validateSingleField(field);
            this.validateCurrentStep();
        }
    }
    
    handleFieldBlur(e) {
        const field = e.target;
        if (field.matches('input, select, textarea')) {
            this.validateSingleField(field, true);
        }
    }
    
    handleFieldChange(e) {
        const field = e.target;
        if (field.matches('input, select, textarea')) {
            this.validateSingleField(field);
            this.validateCurrentStep();
        }
    }
    
    validateSingleField(field, showWarning = false) {
        const fieldValue = field.value.trim();
        const fieldName = field.name || field.id;
        
        // Debug: Log Last Name field validation
        if (fieldName === 'last_name') {
            console.log('üîç Last Name Field Validation Debug:');
            console.log('   Field element:', field);
            console.log('   Field value:', fieldValue);
            console.log('   Field value length:', fieldValue.length);
            console.log('   Is empty:', !fieldValue);
            console.log('   Is required:', field.hasAttribute('required'));
        }
        
        // Clear previous states
        field.classList.remove('error', 'warning', 'success');
        
        // Check if required field is empty
        if (field.hasAttribute('required') && !fieldValue) {
            field.classList.add('error');
            if (showWarning) {
                this.showFieldWarning(field, `${this.getFieldLabel(field)} is required`);
            }
            return false;
        }
        
        // If field has value, validate it
        if (fieldValue) {
            const warning = this.validateField(field, fieldValue);
            if (warning) {
                field.classList.add('warning');
                if (showWarning) {
                    this.showFieldWarning(field, warning);
                }
                return false;
            } else {
                // Don't add success class to checkboxes
                if (field.type !== 'checkbox') {
                    field.classList.add('success');
                }
                this.clearFieldWarning(field);
                return true;
            }
        }
        
        return true;
    }
    
    showFieldWarning(field, message) {
        // Remove existing warning
        this.clearFieldWarning(field);
        
        // Create warning message
        const warningDiv = document.createElement('div');
        warningDiv.className = 'field-warning';
        warningDiv.style.cssText = `
            color: var(--warning-color);
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        `;
        warningDiv.innerHTML = `
            <span>‚ö†Ô∏è</span>
            <span>${message}</span>
        `;
        
        // Insert after the field
        const formGroup = field.closest('.form-group');
        if (formGroup) {
            formGroup.appendChild(warningDiv);
        }
    }
    
    clearFieldWarning(field) {
        const formGroup = field.closest('.form-group');
        if (formGroup) {
            const existingWarning = formGroup.querySelector('.field-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
        }
    }
    
    getCurrentWarnings() {
        const warnings = [];
        const currentStepElement = document.getElementById(`step-${this.currentStep}`);
        const warningFields = currentStepElement.querySelectorAll('.warning');
        
        warningFields.forEach(field => {
            const fieldName = field.name || field.id;
            const fieldValue = field.value.trim();
            const warning = this.validateField(field, fieldValue);
            if (warning) {
                warnings.push(`${this.getFieldLabel(field)}: ${warning}`);
            }
        });
        
        return warnings;
    }
    
    async showWarningConfirmation(warnings) {
        return new Promise((resolve) => {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 8px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;
            
            // Create warning icon and title
            const title = document.createElement('div');
            title.style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
                font-size: 18px;
                font-weight: 600;
                color: var(--warning-color);
            `;
            title.innerHTML = `
                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                <span>Validation Warnings</span>
            `;
            
            // Create warning message
            const message = document.createElement('div');
            message.style.cssText = `
                margin-bottom: 20px;
                color: var(--text-color);
                line-height: 1.5;
            `;
            message.innerHTML = `
                <p>You have some validation warnings. You can still proceed, but it's recommended to fix these issues first:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    ${warnings.map(warning => `<li style="margin-bottom: 5px;">${warning}</li>`).join('')}
                </ul>
            `;
            
            // Create buttons
            const buttons = document.createElement('div');
            buttons.style.cssText = `
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            `;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Go Back & Fix';
            cancelBtn.style.cssText = `
                padding: 10px 20px;
                border: 1px solid var(--border-color);
                background: white;
                color: var(--text-color);
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            `;
            cancelBtn.onclick = () => {
                document.body.removeChild(modal);
                resolve(false);
            };
            
            const proceedBtn = document.createElement('button');
            proceedBtn.textContent = 'Proceed Anyway';
            proceedBtn.style.cssText = `
                padding: 10px 20px;
                border: none;
                background: var(--warning-color);
                color: white;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
            `;
            proceedBtn.onclick = () => {
                document.body.removeChild(modal);
                resolve(true);
            };
            
            buttons.appendChild(cancelBtn);
            buttons.appendChild(proceedBtn);
            
            // Assemble modal
            modalContent.appendChild(title);
            modalContent.appendChild(message);
            modalContent.appendChild(buttons);
            modal.appendChild(modalContent);
            
            // Add to page
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    resolve(false);
                }
            };
        });
    }
    
    addUnit() {
        this.unitCounter++;
        const unitNumber = this.unitCounter;
        this.userCounters[unitNumber] = 0;
        
        const template = document.getElementById('unit-template');
        const unitElement = template.content.cloneNode(true);
        
        const unitContainer = unitElement.querySelector('.unit-container');
        unitContainer.dataset.unitNumber = unitNumber;
        
        const unitNumberSpan = unitElement.querySelector('.unit-number');
        unitNumberSpan.textContent = unitNumber;
        
        // Bind unit events
        const removeUnitBtn = unitElement.querySelector('.remove-unit-btn');
        removeUnitBtn.addEventListener('click', () => this.removeUnit(unitContainer));
        
        const addUserBtn = unitElement.querySelector('.add-user-btn');
        addUserBtn.addEventListener('click', () => this.addUser(unitNumber));
        
        this.unitsContainer.appendChild(unitElement);
    }
    
    removeUnit(unitContainer) {
        const unitNumber = parseInt(unitContainer.dataset.unitNumber);
        delete this.userCounters[unitNumber];
        unitContainer.remove();
        
        // Renumber remaining units
        this.renumberUnits();
    }
    
    renumberUnits() {
        const units = this.unitsContainer.querySelectorAll('.unit-container');
        units.forEach((unit, index) => {
            const unitNumber = index + 1;
            unit.dataset.unitNumber = unitNumber;
            unit.querySelector('.unit-number').textContent = unitNumber;
            
            // Update user counters
            if (!this.userCounters[unitNumber]) {
                this.userCounters[unitNumber] = 0;
            }
        });
    }
    
    addUser(unitNumber) {
        this.userCounters[unitNumber]++;
        const userNumber = this.userCounters[unitNumber];
        
        const template = document.getElementById('user-template');
        const userElement = template.content.cloneNode(true);
        
        const userContainer = userElement.querySelector('.user-container');
        userContainer.dataset.unitNumber = unitNumber;
        userContainer.dataset.userNumber = userNumber;
        
        const userNumberSpan = userElement.querySelector('.user-number');
        userNumberSpan.textContent = userNumber;
        
        // Bind user events
        const removeUserBtn = userElement.querySelector('.remove-user-btn');
        removeUserBtn.addEventListener('click', () => this.removeUser(userContainer));
        
        const unitContainer = this.unitsContainer.querySelector(`[data-unit-number="${unitNumber}"]`);
        const usersContainer = unitContainer.querySelector('.users-container');
        usersContainer.appendChild(userElement);
    }
    
    removeUser(userContainer) {
        const unitNumber = parseInt(userContainer.dataset.unitNumber);
        const userNumber = parseInt(userContainer.dataset.userNumber);
        
        userContainer.remove();
        
        // Renumber remaining users in this unit
        this.renumberUsers(unitNumber);
    }
    
    renumberUsers(unitNumber) {
        const unitContainer = this.unitsContainer.querySelector(`[data-unit-number="${unitNumber}"]`);
        const users = unitContainer.querySelectorAll('.user-container');
        users.forEach((user, index) => {
            const userNumber = index + 1;
            user.dataset.userNumber = userNumber;
            user.querySelector('.user-number').textContent = userNumber;
        });
    }
    
    async sendVerificationEmail() {
        try {
            this.showLoading(true);
            const stepData = this.collectStepData(1);
            
            console.log('üìã Step data:', stepData);
            
            // Get CSRF token - try multiple methods
            let csrfToken = null;
            
            // Method 1: Try frappe object
            if (typeof frappe !== 'undefined' && frappe.csrf_token) {
                csrfToken = frappe.csrf_token;
                console.log('‚úÖ CSRF Token from frappe object:', csrfToken);
            }
            
            // Method 2: Try meta tags
            if (!csrfToken) {
                const metaToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                                document.querySelector('meta[name="csrf_token"]')?.getAttribute('content');
                if (metaToken) {
                    csrfToken = metaToken;
                    console.log('‚úÖ CSRF Token from meta tag:', csrfToken);
                }
            }
            
            // Method 3: Try hidden input
            if (!csrfToken) {
                const inputToken = document.querySelector('input[name="csrf_token"]')?.value;
                if (inputToken) {
                    csrfToken = inputToken;
                    console.log('‚úÖ CSRF Token from hidden input:', csrfToken);
                }
            }
            
            // Method 4: Try window object
            if (!csrfToken && window.csrf_token) {
                csrfToken = window.csrf_token;
                console.log('‚úÖ CSRF Token from window object:', csrfToken);
            }
            
            console.log('üîë Final CSRF Token:', csrfToken);
            
            // Create form data for Frappe API
            const params = new URLSearchParams();
            params.append('email', stepData.email);
            params.append('data', JSON.stringify(stepData));
            
            // Add CSRF token if available
            if (csrfToken) {
                params.append('csrf_token', csrfToken);
            }
            
            console.log('üì§ Sending params:', params.toString());
            
            const response = await fetch('/api/method/climoro_onboarding.www.apply.api.send_verification_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Frappe-CSRF-Token': csrfToken || ''
                },
                body: params.toString()
            });
            
            console.log('üì• Response status:', response.status);
            console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('üì• Response result:', result);
            
            if (result.message && result.message.success) {
                console.log('‚úÖ Verification email sent successfully');
                this.showSuccessMessage('Verification email sent! Please check your email and click the verification link to continue.');
                // Show verification message instead of proceeding
                this.showVerificationMessage();
            } else {
                console.error('‚ùå Failed to send verification email:', result);
                const errorMessage = result.message ? result.message.message : 'Unknown error occurred';
                this.showErrorMessage(errorMessage);
            }
            
        } catch (error) {
            console.error('‚ùå Error sending verification email:', error);
            this.showErrorMessage(`Error sending verification email: ${error.message}`);
        } finally {
            this.showLoading(false);
        }
    }
    
    showVerificationMessage() {
        const step1Element = document.getElementById('step-1');
        step1Element.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;">üìß</div>
                <h2 style="color: var(--dark-color); margin-bottom: 15px;">Check Your Email</h2>
                <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 16px;">
                    We've sent a verification email to your inbox. Please check your email and click the verification link to continue with your onboarding.
                </p>
                <div style="background: var(--light-color); padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="margin-top: 0; color: var(--dark-color);">What to do next:</h4>
                    <ol style="text-align: left; color: var(--text-muted);">
                        <li>Check your email inbox (and spam folder)</li>
                        <li>Click the "Verify Email & Continue Onboarding" button</li>
                        <li>You'll be taken to Step 2: Company Details</li>
                    </ol>
                </div>
                <button type="button" class="btn btn-secondary" onclick="location.reload()">
                    Start Over
                </button>
            </div>
        `;
        
        // Hide navigation buttons
        this.nextBtn.style.display = 'none';
        this.prevBtn.style.display = 'none';
    }
    
    async checkVerificationToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('verify');
        
        if (token) {
            try {
                this.showLoading(true);
                console.log('üîç Verifying token:', token);
                
                // Get CSRF token - try multiple methods
                let csrfToken = null;
                
                // Method 1: Try frappe object
                if (typeof frappe !== 'undefined' && frappe.csrf_token) {
                    csrfToken = frappe.csrf_token;
                    console.log('‚úÖ CSRF Token from frappe object:', csrfToken);
                }
                
                // Method 2: Try meta tags
                if (!csrfToken) {
                    const metaToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                                    document.querySelector('meta[name="csrf_token"]')?.getAttribute('content');
                    if (metaToken) {
                        csrfToken = metaToken;
                        console.log('‚úÖ CSRF Token from meta tag:', csrfToken);
                    }
                }
                
                // Method 3: Try hidden input
                if (!csrfToken) {
                    const inputToken = document.querySelector('input[name="csrf_token"]')?.value;
                    if (inputToken) {
                        csrfToken = inputToken;
                        console.log('‚úÖ CSRF Token from hidden input:', csrfToken);
                    }
                }
                
                // Method 4: Try window object
                if (!csrfToken && window.csrf_token) {
                    csrfToken = window.csrf_token;
                    console.log('‚úÖ CSRF Token from window object:', csrfToken);
                }
                
                console.log('üîë Final CSRF Token:', csrfToken);
                
                // Create form data for Frappe API
                const params = new URLSearchParams();
                params.append('token', token);
                if (csrfToken) {
                    params.append('csrf_token', csrfToken);
                }
                
                console.log('üì§ Sending verification params:', params.toString());
                
                const response = await fetch('/api/method/climoro_onboarding.www.apply.api.verify_email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Frappe-CSRF-Token': csrfToken || ''
                    },
                    body: params.toString()
                });
                
                console.log('üì• Verification response status:', response.status);
                console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üì• Verification result:', result);
                
                if (result.message && result.message.success) {
                    console.log('‚úÖ Email verification successful');
                    
                    // Load session data
                    const sessionParams = new URLSearchParams();
                    sessionParams.append('token', token);
                    if (csrfToken) {
                        sessionParams.append('csrf_token', csrfToken);
                    }
                    
                    console.log('üì§ Sending session params:', sessionParams.toString());
                    
                    const sessionResponse = await fetch('/api/method/climoro_onboarding.www.apply.api.get_session_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Frappe-CSRF-Token': csrfToken || ''
                        },
                        body: sessionParams.toString()
                    });
                    
                    console.log('üì• Session response status:', sessionResponse.status);
                    
                    if (!sessionResponse.ok) {
                        throw new Error(`HTTP error! status: ${sessionResponse.status}`);
                    }
                    
                    const sessionResult = await sessionResponse.json();
                    console.log('üì• Session result:', sessionResult);
                    
                    if (sessionResult.message && sessionResult.message.success) {
                        console.log('‚úÖ Session data retrieved successfully');
                        
                        // Populate form with session data
                        this.populateFormWithSessionData(sessionResult.message.session_data);
                        
                        // Move to Step 2
                        this.currentStep = 2;
                        this.updateStep();
                        
                        // Clean URL
                        const newUrl = window.location.pathname;
                        window.history.replaceState({}, '', newUrl);
                        
                        this.showSuccessMessage('Email verified successfully! You can now continue with Step 2.');
                    } else {
                        console.error('‚ùå Session data retrieval failed:', sessionResult);
                        this.showErrorMessage('Error retrieving session data. Please try again.');
                    }
                } else {
                    console.error('‚ùå Email verification failed:', result);
                    this.showErrorMessage('Email verification failed. Please try again.');
                }
                
            } catch (error) {
                console.error('‚ùå Error verifying email:', error);
                this.showErrorMessage(`Error verifying email: ${error.message}`);
            } finally {
                this.showLoading(false);
            }
        } else {
            console.log('‚ÑπÔ∏è No verification token found in URL');
        }
    }
    
    populateFormWithSessionData(sessionData) {
        const data = sessionData.data;
        
        // Populate Step 1 fields
        if (data.first_name) document.getElementById('first_name').value = data.first_name;
        if (data.phone_number) document.getElementById('phone_number').value = data.phone_number;
        if (data.email) document.getElementById('email').value = data.email;
        if (data.position) document.getElementById('position').value = data.position;
        
        // Populate Step 2 fields if available
        if (data.company_name) document.getElementById('company_name').value = data.company_name;
        if (data.address) document.getElementById('address').value = data.address;
        if (data.gps_coordinates) document.getElementById('gps_coordinates').value = data.gps_coordinates;
        if (data.cin) document.getElementById('cin').value = data.cin;
        if (data.gst_number) document.getElementById('gst_number').value = data.gst_number;
    }
    
    async saveStepData() {
        console.log('üîç saveStepData method called');
        console.log('üîç Current step:', this.currentStep);
        try {
            this.showLoading(true);
            
            console.log('üîç About to call collectStepData...');
            const stepData = this.collectStepData();
            console.log('üîç collectStepData returned:', stepData);
            stepData.step_number = this.currentStep;
            
            console.log('üìã Step data to save:', stepData);
            console.log('üîç Step data location name:', stepData.location_name);
            
            // Get CSRF token
            let csrfToken = frappe?.csrf_token;
            if (!csrfToken) {
                csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                           document.querySelector('meta[name="csrf_token"]')?.getAttribute('content') ||
                           document.querySelector('input[name="csrf_token"]')?.value ||
                           window.csrf_token;
            }
            
            console.log('üîë CSRF Token:', csrfToken);
            
            // Create form data for Frappe API
            const params = new URLSearchParams();
            params.append('step_data', JSON.stringify(stepData));
            if (csrfToken) {
                params.append('csrf_token', csrfToken);
            }
            
            console.log('üì§ Sending step data params:', params.toString());
            
            const response = await fetch('/api/method/climoro_onboarding.www.apply.api.save_step_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Frappe-CSRF-Token': csrfToken || ''
                },
                body: params.toString()
            });
            
            console.log('üì• Step data response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('üì• Step data response result:', result);
            
            // Check for Frappe API error structure
            if (result.exc_type) {
                throw new Error(`API Error: ${result.exc || 'Unknown error'}`);
            }
            
            // Check for success in message
            if (result.message && result.message.success) {
                console.log('‚úÖ Step data saved successfully');
                return true;
            } else if (result.message && !result.message.success) {
                console.error('‚ùå API returned error:', result.message.message);
                this.showErrorMessage(result.message.message || 'Failed to save step data');
                return false;
            } else {
                console.error('‚ùå Unexpected response format:', result);
                this.showErrorMessage('Unexpected response format from server');
                return false;
            }
            
        } catch (error) {
            console.error('‚ùå Error saving step data:', error);
            this.showErrorMessage(`Error saving step data: ${error.message}`);
            return false;
        } finally {
            this.showLoading(false);
        }
    }
    
    collectStepData(step = null) {
        const stepData = {
            email: document.getElementById('email').value
        };
        
        console.log('üîç collectStepData called for step:', step || this.currentStep);
        
        // Determine which step to collect data for
        const targetStep = step || this.currentStep;
        console.log('üîç Target step for data collection:', targetStep);
        console.log('üîç Current step:', this.currentStep);
        console.log('üîç Step parameter:', step);
        
        if (targetStep === 1) {
            // Step 1: Contact Details
            stepData.first_name = document.getElementById('first_name').value;
            stepData.middle_name = document.getElementById('middle_name').value;
            stepData.last_name = document.getElementById('last_name').value;
            stepData.phone_number = document.getElementById('phone_number').value;
            stepData.position = document.getElementById('position').value;
        } else if (targetStep === 2) {
            // Step 2: Company Details
            stepData.company_name = document.getElementById('company_name').value;
            stepData.address = document.getElementById('address').value;
            stepData.gps_coordinates = document.getElementById('gps_coordinates').value;
            stepData.location_name = document.getElementById('location_name').value;
            stepData.cin = document.getElementById('cin').value;
            stepData.gst_number = document.getElementById('gst_number').value;
            stepData.industry_type = document.getElementById('industry_type').value;
            stepData.sub_industry_type = document.getElementById('sub_industry_type').value;
            stepData.website = document.getElementById('website').value;
            stepData.letter_of_authorisation = document.getElementById('letter_of_authorisation').getAttribute('data-file-url') || '';
        } else if (targetStep === 3) {
            // Step 3: Units & Users
            stepData.units = [];
            stepData.assigned_users = [];
            
            // Collect units data
            const units = this.unitsContainer.querySelectorAll('.unit-container');
            units.forEach(unit => {
                const unitData = {
                    type_of_unit: unit.querySelector('.unit-type').value,
                    name_of_unit: unit.querySelector('.unit-name').value,
                    size_of_unit: parseFloat(unit.querySelector('.unit-size').value),
                    address: unit.querySelector('.unit-address').value,
                    gps_coordinates: unit.querySelector('.unit-gps-coordinates').value,
                    location_name: unit.querySelector('.unit-location-name').value,
                    gst: unit.querySelector('.unit-gst').value,
                    phone_number: unit.querySelector('.unit-phone').value,
                    position: unit.querySelector('.unit-position').value
                };
                
                stepData.units.push(unitData);
            });
            
            // Collect users data from within units
            units.forEach(unit => {
                const unitName = unit.querySelector('.unit-name').value;
                const usersInUnit = unit.querySelectorAll('.user-container');
                usersInUnit.forEach(user => {
                    const userData = {
                        assigned_unit: unitName, // Use unit name as reference
                        email: user.querySelector('.user-email').value,
                        first_name: user.querySelector('.user-first-name').value,
                        user_role: user.querySelector('.user-role').value
                    };
                    stepData.assigned_users.push(userData);
                });
            });
        } else if (targetStep === 4) {
            // Step 4: GHG Accounting
            stepData.purpose_of_reporting = this.getMultiSelectValue('purpose_of_reporting');
            
            // Individual gas checkboxes
            stepData.gases_to_report_co2 = this.getCheckboxValue('gases_to_report_co2');
            stepData.gases_to_report_ch4 = this.getCheckboxValue('gases_to_report_ch4');
            stepData.gases_to_report_n2o = this.getCheckboxValue('gases_to_report_n2o');
            stepData.gases_to_report_hfcs = this.getCheckboxValue('gases_to_report_hfcs');
            stepData.gases_to_report_pfcs = this.getCheckboxValue('gases_to_report_pfcs');
            stepData.gases_to_report_sf6 = this.getCheckboxValue('gases_to_report_sf6');
            stepData.gases_to_report_nf3 = this.getCheckboxValue('gases_to_report_nf3');
            
            // Individual scope checkboxes
            stepData.scopes_to_report_scope1 = this.getCheckboxValue('scopes_to_report_scope1');
            stepData.scopes_to_report_scope2 = this.getCheckboxValue('scopes_to_report_scope2');
            stepData.scopes_to_report_scope3 = this.getCheckboxValue('scopes_to_report_scope3');
            stepData.scopes_to_report_reductions = this.getCheckboxValue('scopes_to_report_reductions');
            
            // Individual scope 1 options
            stepData.scope_1_options_process = this.getCheckboxValue('scope_1_options_process');
            stepData.scope_1_options_stationary = this.getCheckboxValue('scope_1_options_stationary');
            stepData.scope_1_options_mobile = this.getCheckboxValue('scope_1_options_mobile');
            stepData.scope_1_options_fugitive = this.getCheckboxValue('scope_1_options_fugitive');
            
            // Individual scope 2 options
            stepData.scope_2_options_electricity = this.getCheckboxValue('scope_2_options_electricity');
            stepData.scope_2_options_heating = this.getCheckboxValue('scope_2_options_heating');
            stepData.scope_2_options_cooling = this.getCheckboxValue('scope_2_options_cooling');
            
            // Individual scope 3 options
            stepData.scope_3_options_upstream = this.getCheckboxValue('scope_3_options_upstream');
            stepData.scope_3_options_downstream = this.getCheckboxValue('scope_3_options_downstream');
            
            // Individual reduction options
            stepData.reduction_options_energy_efficiency = this.getCheckboxValue('reduction_options_energy_efficiency');
            stepData.reduction_options_renewable_energy = this.getCheckboxValue('reduction_options_renewable_energy');
            stepData.reduction_options_process_optimization = this.getCheckboxValue('reduction_options_process_optimization');
            stepData.reduction_options_waste_management = this.getCheckboxValue('reduction_options_waste_management');
            stepData.reduction_options_transportation = this.getCheckboxValue('reduction_options_transportation');
            stepData.reduction_options_other = this.getCheckboxValue('reduction_options_other');
        } else if (targetStep === 5) {
            // Step 5: Reduction Form - Section A: Emissions Inventory Setup
            console.log('üîç Collecting Step 5 data...');
            console.log('üîç base_year element:', document.getElementById('base_year'));
            console.log('üîç base_year value:', document.getElementById('base_year')?.value);
            
            stepData.base_year = document.getElementById('base_year')?.value || '';
            stepData.base_year_reason = document.getElementById('base_year_reason')?.value || '';
            
            // Scopes Covered
            stepData.scopes_covered_scope1 = this.getCheckboxValue('scopes_covered_scope1');
            stepData.scopes_covered_scope2 = this.getCheckboxValue('scopes_covered_scope2');
            stepData.scopes_covered_scope3 = this.getCheckboxValue('scopes_covered_scope3');
            
            // GHG Boundary Approach
            stepData.ghg_boundary_approach_operational_control = this.getCheckboxValue('ghg_boundary_approach_operational_control');
            stepData.ghg_boundary_approach_financial_control = this.getCheckboxValue('ghg_boundary_approach_financial_control');
            stepData.ghg_boundary_approach_equity_share = this.getCheckboxValue('ghg_boundary_approach_equity_share');
            
            // Scope 3 Categories Included
            stepData.scope_3_categories_purchased_goods = this.getCheckboxValue('scope_3_categories_purchased_goods');
            stepData.scope_3_categories_capital_goods = this.getCheckboxValue('scope_3_categories_capital_goods');
            stepData.scope_3_categories_fuel_energy = this.getCheckboxValue('scope_3_categories_fuel_energy');
            stepData.scope_3_categories_transportation = this.getCheckboxValue('scope_3_categories_transportation');
            stepData.scope_3_categories_waste = this.getCheckboxValue('scope_3_categories_waste');
            stepData.scope_3_categories_business_travel = this.getCheckboxValue('scope_3_categories_business_travel');
            stepData.scope_3_categories_use_sold_products = this.getCheckboxValue('scope_3_categories_use_sold_products');
            stepData.scope_3_categories_end_life_treatment = this.getCheckboxValue('scope_3_categories_end_life_treatment');
            stepData.scope_3_categories_leased_assets = this.getCheckboxValue('scope_3_categories_leased_assets');
            
            stepData.emissions_exclusions = document.getElementById('emissions_exclusions')?.value || '';
            
            // Section B: Emissions Reduction Targets
            stepData.target_type = document.getElementById('target_type')?.value || '';
            stepData.scope_1_2_intensity_percentage = document.getElementById('scope_1_2_intensity_percentage')?.value || '';
            stepData.scope_1_2_target_year = document.getElementById('scope_1_2_target_year')?.value || '';
            stepData.scope_3_intensity_percentage = document.getElementById('scope_3_intensity_percentage')?.value || '';
            stepData.scope_3_target_year = document.getElementById('scope_3_target_year')?.value || '';
            stepData.absolute_emissions_percentage = document.getElementById('absolute_emissions_percentage')?.value || '';
            stepData.near_term_target_year = document.getElementById('near_term_target_year')?.value || '';
            stepData.long_term_target_year = document.getElementById('long_term_target_year')?.value || '';
            
            // Target Metrics
            stepData.target_metrics_absolute_emissions = this.getCheckboxValue('target_metrics_absolute_emissions');
            stepData.target_metrics_kgco2e_mwh = this.getCheckboxValue('target_metrics_kgco2e_mwh');
            stepData.target_metrics_kgco2e_tonne = this.getCheckboxValue('target_metrics_kgco2e_tonne');
            stepData.target_metrics_kgco2e_unit_service = this.getCheckboxValue('target_metrics_kgco2e_unit_service');
            stepData.target_metrics_kgco2e_usd_revenue = this.getCheckboxValue('target_metrics_kgco2e_usd_revenue');
            stepData.target_metrics_kgco2e_stove_year = this.getCheckboxValue('target_metrics_kgco2e_stove_year');
            stepData.target_metrics_kgco2e_tonne_biochar = this.getCheckboxValue('target_metrics_kgco2e_tonne_biochar');
            stepData.target_metrics_kgco2e_km_travelled = this.getCheckboxValue('target_metrics_kgco2e_km_travelled');
            
            // Target Boundary
            stepData.target_boundary_scope1_2_95_percent = this.getCheckboxValue('target_boundary_scope1_2_95_percent');
            stepData.target_boundary_scope3_90_percent_long_term = this.getCheckboxValue('target_boundary_scope3_90_percent_long_term');
            stepData.target_boundary_scope3_67_percent_near_term = this.getCheckboxValue('target_boundary_scope3_67_percent_near_term');
            stepData.target_boundary_prioritize_relevance = this.getCheckboxValue('target_boundary_prioritize_relevance');
            
            // Operational Emissions Reduction Strategies
            stepData.operational_emissions_energy_efficiency = this.getCheckboxValue('operational_emissions_energy_efficiency');
            stepData.operational_emissions_onsite_renewable = this.getCheckboxValue('operational_emissions_onsite_renewable');
            stepData.operational_emissions_offsite_renewable = this.getCheckboxValue('operational_emissions_offsite_renewable');
            stepData.operational_emissions_fuel_switching = this.getCheckboxValue('operational_emissions_fuel_switching');
            stepData.operational_emissions_process_optimization = this.getCheckboxValue('operational_emissions_process_optimization');
            
            // Value Chain Emissions Reduction Strategies
            stepData.value_chain_emissions_supplier_engagement = this.getCheckboxValue('value_chain_emissions_supplier_engagement');
            stepData.value_chain_emissions_low_carbon_materials = this.getCheckboxValue('value_chain_emissions_low_carbon_materials');
            stepData.value_chain_emissions_redesign_use_phase = this.getCheckboxValue('value_chain_emissions_redesign_use_phase');
            stepData.value_chain_emissions_optimize_logistics = this.getCheckboxValue('value_chain_emissions_optimize_logistics');
            stepData.value_chain_emissions_circular_economy = this.getCheckboxValue('value_chain_emissions_circular_economy');
            
            // Land Sector Removals
            stepData.land_sector_removals_afforestation = this.getCheckboxValue('land_sector_removals_afforestation');
            stepData.land_sector_removals_soil_carbon = this.getCheckboxValue('land_sector_removals_soil_carbon');
            stepData.land_sector_removals_urban_greening = this.getCheckboxValue('land_sector_removals_urban_greening');
            stepData.land_sector_removals_biochar = this.getCheckboxValue('land_sector_removals_biochar');
            stepData.land_sector_removals_carbon_capture = this.getCheckboxValue('land_sector_removals_carbon_capture');
            stepData.land_sector_removals_certified_removals = this.getCheckboxValue('land_sector_removals_certified_removals');
            
            // Residual Emissions
            stepData.residual_emissions_high_quality_credits = this.getCheckboxValue('residual_emissions_high_quality_credits');
            stepData.residual_emissions_bvcm = this.getCheckboxValue('residual_emissions_bvcm');
            stepData.residual_emissions_temporary_solutions = this.getCheckboxValue('residual_emissions_temporary_solutions');

            // Section D: Monitoring, Adjustments & Reporting
            stepData.monitoring_frequency = document.getElementById('monitoring_frequency')?.value || '';
            stepData.monitoring_frequency_other_text = document.getElementById('monitoring_frequency_other_text')?.value || '';
            stepData.assurance_validation = document.getElementById('assurance_validation')?.value || '';
            
            // GHG Tracking Tools
            stepData.ghg_tracking_tools_excel = this.getCheckboxValue('ghg_tracking_tools_excel');
            stepData.ghg_tracking_tools_software = this.getCheckboxValue('ghg_tracking_tools_software');
            stepData.ghg_tracking_tools_software_name = document.getElementById('ghg_tracking_tools_software_name')?.value || '';
            stepData.ghg_tracking_tools_web_platform = this.getCheckboxValue('ghg_tracking_tools_web_platform');
            
            // Recalculation Policy
            stepData.recalculation_policy_structural = this.getCheckboxValue('recalculation_policy_structural');
            stepData.recalculation_policy_methodology = this.getCheckboxValue('recalculation_policy_methodology');
            stepData.recalculation_policy_boundary = this.getCheckboxValue('recalculation_policy_boundary');
            
            // Progress Communication
            stepData.progress_communication_esg_dashboard = this.getCheckboxValue('progress_communication_esg_dashboard');
            stepData.progress_communication_sustainability_report = this.getCheckboxValue('progress_communication_sustainability_report');
            stepData.progress_communication_cdp_disclosure = this.getCheckboxValue('progress_communication_cdp_disclosure');
            stepData.progress_communication_sbti_registry = this.getCheckboxValue('progress_communication_sbti_registry');
            
            // Debug Section D fields
            console.log('üîç Section D fields collected:');
            console.log('  ghg_tracking_tools_excel:', stepData.ghg_tracking_tools_excel);
            console.log('  ghg_tracking_tools_software:', stepData.ghg_tracking_tools_software);
            console.log('  ghg_tracking_tools_web_platform:', stepData.ghg_tracking_tools_web_platform);
            console.log('  recalculation_policy_structural:', stepData.recalculation_policy_structural);
            console.log('  recalculation_policy_methodology:', stepData.recalculation_policy_methodology);
            console.log('  recalculation_policy_boundary:', stepData.recalculation_policy_boundary);
            console.log('  progress_communication_esg_dashboard:', stepData.progress_communication_esg_dashboard);
            console.log('  progress_communication_sustainability_report:', stepData.progress_communication_sustainability_report);
            console.log('  progress_communication_cdp_disclosure:', stepData.progress_communication_cdp_disclosure);
            console.log('  progress_communication_sbti_registry:', stepData.progress_communication_sbti_registry);
        } else if (targetStep === 6) {
            // Step 6: Method of Calculation
            stepData.method_of_calculation_option_a = this.getCheckboxValue('method_of_calculation_option_a');
            stepData.method_of_calculation_option_b = this.getCheckboxValue('method_of_calculation_option_b');
            stepData.method_of_calculation_option_c = this.getCheckboxValue('method_of_calculation_option_c');
            stepData.method_of_calculation_option_d = this.getCheckboxValue('method_of_calculation_option_d');
            stepData.method_of_calculation_option_e = this.getCheckboxValue('method_of_calculation_option_e');
            stepData.method_of_calculation_option_f = this.getCheckboxValue('method_of_calculation_option_f');
            stepData.method_of_calculation_option_g = this.getCheckboxValue('method_of_calculation_option_g');
        }
        
        stepData.step_number = targetStep;
        console.log('üîç collectStepData collected data:', stepData);
        return stepData;
    }
    
    async submitForm(e) {
        e.preventDefault();
        
        // Debug: Check last_name field before validation
        const lastNameField = document.getElementById('last_name');
        console.log('üîç Last Name Field Debug (before validation):');
        console.log('   Field element:', lastNameField);
        console.log('   Field value:', lastNameField ? lastNameField.value : 'FIELD NOT FOUND');
        console.log('   Field required:', lastNameField ? lastNameField.required : 'N/A');
        
        if (!this.validateAllSteps()) {
            return;
        }
        
        try {
            this.showLoading(true);
            const formData = await this.collectFormData();
            
            // Debug: Check formData before sending
            console.log('üîç Final Form Submission Debug:');
            console.log('   Form data object:', formData);
            console.log('   Last name in formData:', formData.last_name);
            console.log('   Last name type:', typeof formData.last_name);
            console.log('   Last name length:', formData.last_name ? formData.last_name.length : 0);
            console.log('   All form data keys:', Object.keys(formData));
            
            // Get CSRF token from frappe object
            let csrfToken = frappe?.csrf_token;
            
            // If no CSRF token found, try alternative methods
            if (!csrfToken) {
                csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                           document.querySelector('meta[name="csrf_token"]')?.getAttribute('content') ||
                           document.querySelector('input[name="csrf_token"]')?.value ||
                           window.csrf_token;
            }
            
            // Create form data for Frappe API
            const params = new URLSearchParams();
            params.append('form_data', JSON.stringify(formData));
            if (csrfToken) {
                params.append('csrf_token', csrfToken);
            }
            
            const response = await fetch('/api/method/climoro_onboarding.www.apply.api.submit_onboarding_form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Frappe-CSRF-Token': csrfToken || ''
                },
                body: params.toString()
            });
            
            const result = await response.json();
            
            if (result.message && result.message.success) {
                // Show acknowledgment page instead of redirecting
                this.showAcknowledgmentPage(formData, result.message);
            } else {
                this.showErrorMessage(result.message ? result.message.message : 'Unknown error occurred');
            }
            
        } catch (error) {
            console.error('Error submitting form:', error);
            this.showErrorMessage('Error submitting form. Please try again.');
        } finally {
            this.showLoading(false);
        }
    }
    
    async collectFormData() {
        // First, fetch any saved data from the backend
        let savedData = null;
        try {
            const csrfToken = frappe?.csrf_token || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const params = new URLSearchParams();
            if (csrfToken) {
                params.append('csrf_token', csrfToken);
            }
            
            const response = await fetch('/api/method/climoro_onboarding.www.apply.api.get_saved_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Frappe-CSRF-Token': csrfToken || ''
                },
                body: params.toString()
            });
            
            const result = await response.json();
            if (result.message && result.message.success && result.message.data) {
                savedData = result.message.data;
                console.log('üì• Fetched saved data for form submission:', savedData);
            }
        } catch (error) {
            console.error('‚ùå Error fetching saved data:', error);
        }
        
        // Debug: Check last_name field during collection
        const lastNameField = document.getElementById('last_name');
        console.log('üîç Last Name Field Debug (during collection):');
        console.log('   Field element:', lastNameField);
        console.log('   Field value:', lastNameField ? lastNameField.value : 'FIELD NOT FOUND');
        console.log('   Field value length:', lastNameField ? lastNameField.value.length : 'N/A');
        console.log('   Field classList:', lastNameField ? lastNameField.classList.toString() : 'N/A');
        console.log('   Field required:', lastNameField ? lastNameField.required : 'N/A');
        console.log('   Field visible:', lastNameField ? lastNameField.offsetParent !== null : 'N/A');
        
        const formData = {
            // Step 1: Contact Details - Use saved data if available, otherwise use current field values
            first_name: savedData?.first_name || document.getElementById('first_name').value,
            middle_name: savedData?.middle_name || document.getElementById('middle_name').value,
            last_name: savedData?.last_name || (lastNameField ? lastNameField.value : ''),
            phone_number: savedData?.phone_number || document.getElementById('phone_number').value,
            email: savedData?.email || document.getElementById('email').value,
            position: savedData?.position || document.getElementById('position').value,
            
            // Step 2: Company Details - Use saved data if available, otherwise use current field values
            company_name: savedData?.company_name || document.getElementById('company_name').value,
            address: savedData?.address || document.getElementById('address').value,
            gps_coordinates: savedData?.gps_coordinates || document.getElementById('gps_coordinates').value,
            location_name: savedData?.location_name || document.getElementById('location_name').value,
            cin: savedData?.cin || document.getElementById('cin').value,
            gst_number: savedData?.gst_number || document.getElementById('gst_number').value,
            industry_type: savedData?.industry_type || document.getElementById('industry_type').value,
            sub_industry_type: savedData?.sub_industry_type || document.getElementById('sub_industry_type').value,
            website: savedData?.website || document.getElementById('website').value,
            letter_of_authorisation: savedData?.letter_of_authorisation || document.getElementById('letter_of_authorisation').getAttribute('data-file-url') || '',
            
            // Step 4: GHG Accounting
            purpose_of_reporting: this.getMultiSelectValue('purpose_of_reporting'),
            
            // Individual gas checkboxes
            gases_to_report_co2: this.getCheckboxValue('gases_to_report_co2'),
            gases_to_report_ch4: this.getCheckboxValue('gases_to_report_ch4'),
            gases_to_report_n2o: this.getCheckboxValue('gases_to_report_n2o'),
            gases_to_report_hfcs: this.getCheckboxValue('gases_to_report_hfcs'),
            gases_to_report_pfcs: this.getCheckboxValue('gases_to_report_pfcs'),
            gases_to_report_sf6: this.getCheckboxValue('gases_to_report_sf6'),
            gases_to_report_nf3: this.getCheckboxValue('gases_to_report_nf3'),
            
            // Individual scope checkboxes
            scopes_to_report_scope1: this.getCheckboxValue('scopes_to_report_scope1'),
            scopes_to_report_scope2: this.getCheckboxValue('scopes_to_report_scope2'),
            scopes_to_report_scope3: this.getCheckboxValue('scopes_to_report_scope3'),
            scopes_to_report_reductions: this.getCheckboxValue('scopes_to_report_reductions'),
            
            // Individual scope 1 options
            scope_1_options_process: this.getCheckboxValue('scope_1_options_process'),
            scope_1_options_stationary: this.getCheckboxValue('scope_1_options_stationary'),
            scope_1_options_mobile: this.getCheckboxValue('scope_1_options_mobile'),
            scope_1_options_fugitive: this.getCheckboxValue('scope_1_options_fugitive'),
            
            // Individual scope 2 options
            scope_2_options_electricity: this.getCheckboxValue('scope_2_options_electricity'),
            scope_2_options_heating: this.getCheckboxValue('scope_2_options_heating'),
            scope_2_options_cooling: this.getCheckboxValue('scope_2_options_cooling'),
            
            // Individual scope 3 options
            scope_3_options_upstream: this.getCheckboxValue('scope_3_options_upstream'),
            scope_3_options_downstream: this.getCheckboxValue('scope_3_options_downstream'),
            
            // Individual reduction options
            reduction_options_energy_efficiency: this.getCheckboxValue('reduction_options_energy_efficiency'),
            reduction_options_renewable_energy: this.getCheckboxValue('reduction_options_renewable_energy'),
            reduction_options_process_optimization: this.getCheckboxValue('reduction_options_process_optimization'),
            reduction_options_waste_management: this.getCheckboxValue('reduction_options_waste_management'),
            reduction_options_transportation: this.getCheckboxValue('reduction_options_transportation'),
            reduction_options_other: this.getCheckboxValue('reduction_options_other'),
            
            // Step 5: Reduction Form - Section A: Emissions Inventory Setup
            base_year: document.getElementById('base_year')?.value || '',
            base_year_reason: document.getElementById('base_year_reason')?.value || '',
            
            // Scopes Covered
            scopes_covered_scope1: this.getCheckboxValue('scopes_covered_scope1'),
            scopes_covered_scope2: this.getCheckboxValue('scopes_covered_scope2'),
            scopes_covered_scope3: this.getCheckboxValue('scopes_covered_scope3'),
            
            // GHG Boundary Approach
            ghg_boundary_approach_operational_control: this.getCheckboxValue('ghg_boundary_approach_operational_control'),
            ghg_boundary_approach_financial_control: this.getCheckboxValue('ghg_boundary_approach_financial_control'),
            ghg_boundary_approach_equity_share: this.getCheckboxValue('ghg_boundary_approach_equity_share'),
            
            // Scope 3 Categories Included
            scope_3_categories_purchased_goods: this.getCheckboxValue('scope_3_categories_purchased_goods'),
            scope_3_categories_capital_goods: this.getCheckboxValue('scope_3_categories_capital_goods'),
            scope_3_categories_fuel_energy: this.getCheckboxValue('scope_3_categories_fuel_energy'),
            scope_3_categories_transportation: this.getCheckboxValue('scope_3_categories_transportation'),
            scope_3_categories_waste: this.getCheckboxValue('scope_3_categories_waste'),
            scope_3_categories_business_travel: this.getCheckboxValue('scope_3_categories_business_travel'),
            scope_3_categories_use_sold_products: this.getCheckboxValue('scope_3_categories_use_sold_products'),
            scope_3_categories_end_life_treatment: this.getCheckboxValue('scope_3_categories_end_life_treatment'),
            scope_3_categories_leased_assets: this.getCheckboxValue('scope_3_categories_leased_assets'),
            
            emissions_exclusions: document.getElementById('emissions_exclusions')?.value || '',
            
            // Section B: Emissions Reduction Targets
            target_type: document.getElementById('target_type')?.value || '',
            scope_1_2_intensity_percentage: document.getElementById('scope_1_2_intensity_percentage')?.value || '',
            scope_1_2_target_year: document.getElementById('scope_1_2_target_year')?.value || '',
            scope_3_intensity_percentage: document.getElementById('scope_3_intensity_percentage')?.value || '',
            scope_3_target_year: document.getElementById('scope_3_target_year')?.value || '',
            absolute_emissions_percentage: document.getElementById('absolute_emissions_percentage')?.value || '',
            near_term_target_year: document.getElementById('near_term_target_year')?.value || '',
            long_term_target_year: document.getElementById('long_term_target_year')?.value || '',
            
            // Target Metrics
            target_metrics_absolute_emissions: this.getCheckboxValue('target_metrics_absolute_emissions'),
            target_metrics_kgco2e_mwh: this.getCheckboxValue('target_metrics_kgco2e_mwh'),
                            target_metrics_kgco2e_tonne: this.getCheckboxValue('target_metrics_kgco2e_tonne'),
            target_metrics_kgco2e_unit_service: this.getCheckboxValue('target_metrics_kgco2e_unit_service'),
            target_metrics_kgco2e_usd_revenue: this.getCheckboxValue('target_metrics_kgco2e_usd_revenue'),
            target_metrics_kgco2e_stove_year: this.getCheckboxValue('target_metrics_kgco2e_stove_year'),
            target_metrics_kgco2e_tonne_biochar: this.getCheckboxValue('target_metrics_kgco2e_tonne_biochar'),
            target_metrics_kgco2e_km_travelled: this.getCheckboxValue('target_metrics_kgco2e_km_travelled'),
            
            // Target Boundary
            target_boundary_scope1_2_95_percent: this.getCheckboxValue('target_boundary_scope1_2_95_percent'),
            target_boundary_scope3_90_percent_long_term: this.getCheckboxValue('target_boundary_scope3_90_percent_long_term'),
            target_boundary_scope3_67_percent_near_term: this.getCheckboxValue('target_boundary_scope3_67_percent_near_term'),
            target_boundary_prioritize_relevance: this.getCheckboxValue('target_boundary_prioritize_relevance'),
            
            // Section C: Mitigation Strategies
            // Operational Emissions
            operational_emissions_energy_efficiency: this.getCheckboxValue('operational_emissions_energy_efficiency'),
            operational_emissions_onsite_renewable: this.getCheckboxValue('operational_emissions_onsite_renewable'),
            operational_emissions_offsite_renewable: this.getCheckboxValue('operational_emissions_offsite_renewable'),
            operational_emissions_fuel_switching: this.getCheckboxValue('operational_emissions_fuel_switching'),
            operational_emissions_process_optimization: this.getCheckboxValue('operational_emissions_process_optimization'),
            
            // Value Chain Emissions
            value_chain_emissions_supplier_engagement: this.getCheckboxValue('value_chain_emissions_supplier_engagement'),
            value_chain_emissions_low_carbon_materials: this.getCheckboxValue('value_chain_emissions_low_carbon_materials'),
            value_chain_emissions_redesign_use_phase: this.getCheckboxValue('value_chain_emissions_redesign_use_phase'),
            value_chain_emissions_optimize_logistics: this.getCheckboxValue('value_chain_emissions_optimize_logistics'),
            value_chain_emissions_circular_economy: this.getCheckboxValue('value_chain_emissions_circular_economy'),
            
            // Land Sector & Removals
            land_sector_removals_afforestation: this.getCheckboxValue('land_sector_removals_afforestation'),
            land_sector_removals_soil_carbon: this.getCheckboxValue('land_sector_removals_soil_carbon'),
            land_sector_removals_urban_greening: this.getCheckboxValue('land_sector_removals_urban_greening'),
            land_sector_removals_biochar: this.getCheckboxValue('land_sector_removals_biochar'),
            land_sector_removals_carbon_capture: this.getCheckboxValue('land_sector_removals_carbon_capture'),
            land_sector_removals_certified_removals: this.getCheckboxValue('land_sector_removals_certified_removals'),
            
            // Residual Emissions Strategy
            residual_emissions_high_quality_credits: this.getCheckboxValue('residual_emissions_high_quality_credits'),
            residual_emissions_bvcm: this.getCheckboxValue('residual_emissions_bvcm'),
            residual_emissions_temporary_solutions: this.getCheckboxValue('residual_emissions_temporary_solutions'),
            
            // Section D: Monitoring, Adjustments & Reporting
            monitoring_frequency: document.getElementById('monitoring_frequency')?.value || '',
            monitoring_frequency_other_text: document.getElementById('monitoring_frequency_other_text')?.value || '',
            assurance_validation: document.getElementById('assurance_validation')?.value || '',
            
            // GHG Tracking Tools
            ghg_tracking_tools_excel: this.getCheckboxValue('ghg_tracking_tools_excel'),
            ghg_tracking_tools_software: this.getCheckboxValue('ghg_tracking_tools_software'),
            ghg_tracking_tools_software_name: document.getElementById('ghg_tracking_tools_software_name')?.value || '',
            ghg_tracking_tools_web_platform: this.getCheckboxValue('ghg_tracking_tools_web_platform'),
            
            // Recalculation Policy
            recalculation_policy_structural: this.getCheckboxValue('recalculation_policy_structural'),
            recalculation_policy_methodology: this.getCheckboxValue('recalculation_policy_methodology'),
            recalculation_policy_boundary: this.getCheckboxValue('recalculation_policy_boundary'),
            
            // Progress Communication
            progress_communication_esg_dashboard: this.getCheckboxValue('progress_communication_esg_dashboard'),
            progress_communication_sustainability_report: this.getCheckboxValue('progress_communication_sustainability_report'),
            progress_communication_cdp_disclosure: this.getCheckboxValue('progress_communication_cdp_disclosure'),
            progress_communication_sbti_registry: this.getCheckboxValue('progress_communication_sbti_registry'),
            
                    // Step 6: Method of Calculation
        method_of_calculation_option_a: this.getCheckboxValue('method_of_calculation_option_a'),
        method_of_calculation_option_b: this.getCheckboxValue('method_of_calculation_option_b'),
        method_of_calculation_option_c: this.getCheckboxValue('method_of_calculation_option_c'),
        method_of_calculation_option_d: this.getCheckboxValue('method_of_calculation_option_d'),
        method_of_calculation_option_e: this.getCheckboxValue('method_of_calculation_option_e'),
        method_of_calculation_option_f: this.getCheckboxValue('method_of_calculation_option_f'),
        method_of_calculation_option_g: this.getCheckboxValue('method_of_calculation_option_g'),
            
            // Step 3: Units and Users
            units: [],
            assigned_users: []
        };
        
                    // Debug: Log the collected last_name value
            console.log('üîç Collected last_name value:', formData.last_name);
            console.log('üîç Collected last_name type:', typeof formData.last_name);
            console.log('üîç Collected last_name length:', formData.last_name ? formData.last_name.length : 0);
            console.log('üîç Saved data used for last_name:', !!savedData?.last_name);
            console.log('üîç Saved data last_name value:', savedData?.last_name);
            console.log('üîç Current last_name field value:', document.getElementById('last_name')?.value);
        
                    // Debug: Log the collected sub_industry_type value
            console.log('üîç Collected sub_industry_type value:', formData.sub_industry_type);
            console.log('üîç Collected sub_industry_type type:', typeof formData.sub_industry_type);
            console.log('üîç Sub-industry field element:', document.getElementById('sub_industry_type'));
            console.log('üîç Sub-industry field value:', document.getElementById('sub_industry_type')?.value);
            
            // Debug: Log the complete formData object
            console.log('üîç Complete formData object:', JSON.stringify(formData, null, 2));
            
            // Debug: Log GHG Accounting fields specifically
            console.log('üå± GHG Accounting Fields Debug:');
            console.log('   Purpose of reporting:', formData.purpose_of_reporting);
            console.log('   Gases to report:', formData.gases_to_report);
            console.log('   Scopes to report:', formData.scopes_to_report);
            console.log('   Base year:', formData.base_year);
            console.log('   GHG boundary approach:', formData.ghg_boundary_approach);
            console.log('   Monitoring frequency:', formData.monitoring_frequency);
        
        // Collect units data
        const units = document.querySelectorAll('.unit-container');
        console.log('üîç Units Debug: Found', units.length, 'units');
        units.forEach((unit, index) => {
            const unitData = {
                type_of_unit: unit.querySelector('.unit-type').value,
                name_of_unit: unit.querySelector('.unit-name').value,
                size_of_unit: parseFloat(unit.querySelector('.unit-size').value),
                address: unit.querySelector('.unit-address').value,
                gps_coordinates: unit.querySelector('.unit-gps-coordinates').value,
                location_name: unit.querySelector('.unit-location-name').value,
                gst: unit.querySelector('.unit-gst').value,
                phone_number: unit.querySelector('.unit-phone').value,
                position: unit.querySelector('.unit-position').value
            };
            console.log('üîç Unit', index + 1, 'data:', unitData);
            formData.units.push(unitData);
        });
        
        // Collect users data from within units
        units.forEach(unit => {
            const unitName = unit.querySelector('.unit-name').value;
            const usersInUnit = unit.querySelectorAll('.user-container');
            console.log('üîç Users Debug: Found', usersInUnit.length, 'users in unit:', unitName);
            usersInUnit.forEach((user, userIndex) => {
                const userData = {
                    assigned_unit: unitName, // Use unit name as reference
                    email: user.querySelector('.user-email').value,
                    first_name: user.querySelector('.user-first-name').value,
                    user_role: user.querySelector('.user-role').value
                };
                console.log('üîç User', userIndex + 1, 'data:', userData);
                formData.assigned_users.push(userData);
            });
        });
        
        return formData;
    }
    
    // Helper function to get checkbox values
    getCheckboxValues(fieldName) {
        const checkboxes = document.querySelectorAll(`input[name="${fieldName}"]:checked`);
        return Array.from(checkboxes).map(checkbox => checkbox.value);
    }
    
    // Helper function to get single checkbox value
    getCheckboxValue(fieldName) {
        const checkbox = document.querySelector(`input[name="${fieldName}"]:checked`);
        return checkbox ? checkbox.value : '';
    }
    
    // Helper function to get multi-select value
    getMultiSelectValue(fieldName) {
        const select = document.getElementById(fieldName);
        return select ? select.value : '';
    }
    
    showLoading(show) {
        if (show) {
            this.form.classList.add('loading');
            this.submitBtn.disabled = true;
        } else {
            this.form.classList.remove('loading');
            this.submitBtn.disabled = false;
        }
    }
    
    showSuccessMessage(message) {
        // Create success message
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success';
        successDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        successDiv.textContent = message;
        
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
            successDiv.remove();
        }, 5000);
    }
    
    showErrorMessage(message) {
        // Create error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger-color);
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        errorDiv.textContent = message;
        
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }
    
    showAcknowledgmentPage(formData, result) {
        console.log('üéâ Showing acknowledgment page');
        console.log('üìã Form data:', formData);
        console.log('üìã Result:', result);
        
        // Hide the main form
        document.getElementById('onboarding-form').style.display = 'none';
        
        // Set application ID and submission date
        const applicationId = result.application_id || 'N/A';
        document.getElementById('ack-application-id').textContent = applicationId;
        
        const submissionDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('ack-submission-date').textContent = submissionDate;
        
        // Show the acknowledgment page
        document.getElementById('acknowledgmentPage').style.display = 'block';
        
        // Scroll to top
        window.scrollTo(0, 0);
    }
    
    // File Upload Functions
    initializeFileUploads() {
        console.log('Initializing file uploads...');
        
        const uploadAreas = document.querySelectorAll('.file-upload-area');
        uploadAreas.forEach(area => {
            this.initializeFileUpload(area);
        });
    }
    
    initializeFileUpload(uploadArea) {
        const fieldName = uploadArea.getAttribute('data-field');
        const fileInput = uploadArea.querySelector('input[type="file"]');
        const placeholder = uploadArea.querySelector('.upload-placeholder');
        const browseLink = uploadArea.querySelector('.browse-link');
        
        if (!fileInput || !placeholder || !browseLink) {
            console.error('Missing required elements for file upload:', fieldName);
            return;
        }
        
        // Set up click handler on browse link
        browseLink.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log(`Browse clicked for ${fieldName}`);
            fileInput.click();
        };
        
        // Set up file input change handler
        fileInput.onchange = (e) => {
            console.log(`File selected for ${fieldName}:`, e.target.files[0]);
            if (e.target.files.length > 0) {
                this.handleFileSelection(e.target);
            }
        };
        
        // Set up drag and drop
        uploadArea.ondragover = (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        };
        
        uploadArea.ondragleave = (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        };
        
        uploadArea.ondrop = (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                this.handleFileSelection(fileInput);
            }
        };
    }
    
    handleFileSelection(fileInput) {
        console.log('handleFileSelection called with:', fileInput);
        const file = fileInput.files[0];
        console.log('Selected file:', file);
        
        if (!file) {
            console.log('No file selected');
            return;
        }
        
        // Validate file
        const validation = this.validateFile(file);
        console.log('File validation result:', validation);
        
        if (!validation.valid) {
            this.showFileError(fileInput.id, validation.message);
            fileInput.value = '';
            return;
        }
        
        // Show file preview
        this.showFilePreview(fileInput.id, file);
        
        // Upload file
        console.log('Starting file upload for:', fileInput.name);
        this.uploadFile(fileInput, file);
    }
    
    validateFile(file) {
        // Check file size (25MB = 25 * 1024 * 1024 bytes)
        const maxSize = 25 * 1024 * 1024;
        if (file.size > maxSize) {
            return {
                valid: false,
                message: 'File size must be less than 25MB'
            };
        }
        
        // Check file type
        const allowedTypes = [
            'application/pdf',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // DOCX
            'application/msword', // DOC
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // XLSX
            'application/vnd.ms-excel', // XLS
            'text/csv',
            'image/jpeg',
            'image/jpg',
            'image/png',
            'image/gif',
            'image/bmp'
        ];
        
        const allowedExtensions = ['.pdf', '.docx', '.doc', '.xlsx', '.xls', '.csv', '.jpg', '.jpeg', '.png', '.gif', '.bmp'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
            return {
                valid: false,
                message: 'File type not supported. Please upload PDF, DOCX, JPG, PNG, XLSX, or CSV files.'
            };
        }
        
        return { valid: true };
    }
    
    showFilePreview(inputId, file) {
        const uploadArea = document.querySelector(`input#${inputId}`).closest('.file-upload-area');
        const placeholder = uploadArea.querySelector('.upload-placeholder');
        const preview = uploadArea.querySelector('.file-preview');
        
        placeholder.style.display = 'none';
        preview.style.display = 'block';
        
        const fileSize = this.formatFileSize(file.size);
        const fileName = file.name;
        
        preview.innerHTML = `
            <div class="file-item">
                <div class="file-item-info">
                    <div class="file-item-icon">üìÑ</div>
                    <div class="file-item-details">
                        <div class="file-item-name" id="filename-${inputId}">${fileName}</div>
                        <div class="file-item-size">${fileSize}</div>
                        <div class="file-item-status">Uploading...</div>
                    </div>
                </div>
                <div class="file-item-actions">
                    <button type="button" class="file-action-btn remove" onclick="window.onboardingForm.removeFile('${inputId}')">Remove</button>
                </div>
            </div>
        `;
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    uploadFile(fileInput, file) {
        console.log('uploadFile called for:', fileInput.name, 'file:', file.name);
        
        const uploadArea = fileInput.closest('.file-upload-area');
        const progress = uploadArea.querySelector('.upload-progress');
        
        if (!progress) {
            console.error('Progress element not found for:', fileInput.name);
            return;
        }
        
        const progressBar = progress.querySelector('.progress-bar');
        const progressFill = progress.querySelector('.progress-fill');
        const progressText = progress.querySelector('.progress-text');
        
        progress.style.display = 'block';
        console.log('Upload progress shown');
        
        // Create FormData for file upload
        const formData = new FormData();
        formData.append('file', file);
        formData.append('field_name', fileInput.name);
        
        console.log('FormData created, sending request...');
        
        // Use XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        // Progress tracking
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressFill.style.width = percentComplete + '%';
                progressText.textContent = Math.round(percentComplete) + '%';
                console.log('Upload progress:', Math.round(percentComplete) + '%');
            }
        });
        
        // Handle completion
        xhr.addEventListener('load', () => {
            console.log('Upload completed, status:', xhr.status);
            console.log('Response:', xhr.responseText);
            
            progress.style.display = 'none';
            
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    console.log('Parsed response:', response);
                    
                    // Check for success in response.message.success (Frappe API structure)
                    const uploadSuccess = response.message && response.message.success;
                    
                    if (uploadSuccess) {
                        console.log('File uploaded successfully, URL:', response.message.file_url);
                        this.showUploadSuccess(fileInput.id);
                        // Store file reference for later use
                        fileInput.setAttribute('data-file-url', response.message.file_url);
                        console.log('File URL stored in data-file-url attribute:', response.message.file_url);
                    } else {
                        const errorMessage = response.message?.message || response.message || 'Upload failed';
                        console.error('Upload failed:', errorMessage);
                        this.showFileError(fileInput.id, errorMessage);
                    }
                } catch (e) {
                    console.error('Failed to parse response:', e);
                    this.showFileError(fileInput.id, 'Upload failed - invalid response');
                }
            } else {
                console.error('Upload failed with status:', xhr.status);
                this.showFileError(fileInput.id, 'Upload failed. Please try again.');
            }
        });
        
        // Handle errors
        xhr.addEventListener('error', () => {
            console.error('Upload network error');
            progress.style.display = 'none';
            this.showFileError(fileInput.id, 'Upload failed. Please check your connection.');
        });
        
        // Send the request
        xhr.open('POST', '/api/method/climoro_onboarding.www.apply.api.upload_file');
        
        // Add CSRF token header (required for Frappe API calls)
        if (typeof frappe !== 'undefined' && frappe.csrf_token) {
            xhr.setRequestHeader('X-Frappe-CSRF-Token', frappe.csrf_token);
        }
        
        console.log('Sending upload request...');
        xhr.send(formData);
    }
    
    showUploadSuccess(inputId) {
        const uploadArea = document.querySelector(`input#${inputId}`).closest('.file-upload-area');
        const statusElement = uploadArea.querySelector('.file-item-status');
        if (statusElement) {
            statusElement.textContent = 'Uploaded successfully';
            statusElement.style.color = 'var(--success-color)';
        }
    }
    
    showFileError(inputId, message) {
        const uploadArea = document.querySelector(`input#${inputId}`).closest('.file-upload-area');
        const fileInput = uploadArea.querySelector('input[type="file"]');
        const placeholder = uploadArea.querySelector('.upload-placeholder');
        const preview = uploadArea.querySelector('.file-preview');
        const progress = uploadArea.querySelector('.upload-progress');
        
        // Clear file input
        fileInput.value = '';
        
        // Show placeholder
        placeholder.style.display = 'flex';
        preview.style.display = 'none';
        progress.style.display = 'none';
        
        // Show error message
        let errorDiv = uploadArea.querySelector('.file-error');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'file-error';
            uploadArea.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        // Remove error after 5 seconds
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
    
    removeFile(inputId) {
        const uploadArea = document.querySelector(`input#${inputId}`).closest('.file-upload-area');
        const fileInput = uploadArea.querySelector('input[type="file"]');
        const placeholder = uploadArea.querySelector('.upload-placeholder');
        const preview = uploadArea.querySelector('.file-preview');
        const progress = uploadArea.querySelector('.upload-progress');
        const errorDiv = uploadArea.querySelector('.file-error');
        
        // Clear file input
        fileInput.value = '';
        fileInput.removeAttribute('data-file-url');
        
        // Show placeholder
        placeholder.style.display = 'flex';
        preview.style.display = 'none';
        progress.style.display = 'none';
        
        // Hide error if present
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
        
        console.log('File removed:', inputId);
    }

    validateAllSteps() {
        let isValid = true;
        let warnings = [];
        
        // Check all required fields across all steps, not just current step
        for (let step = 1; step <= this.totalSteps; step++) {
            const stepElement = document.getElementById(`step-${step}`);
            const requiredFields = stepElement.querySelectorAll('[required]');
            
            requiredFields.forEach((field) => {
                const fieldName = field.name || field.id;
                const fieldValue = field.value.trim();
                
                if (!fieldValue) {
                    field.classList.add('error');
                    field.classList.remove('success');
                    isValid = false;
                    warnings.push(`Step ${step}: ${this.getFieldLabel(field)} is required`);
                }
            });
        }
        
        // Also check special validation for method of calculation - at least one option must be selected
        if (this.currentStep === 6) {
            const methodOptions = [
                'method_of_calculation_option_a',
                'method_of_calculation_option_b', 
                'method_of_calculation_option_c',
                'method_of_calculation_option_d',
                'method_of_calculation_option_e',
                'method_of_calculation_option_f',
                'method_of_calculation_option_g'
            ];
            
            const hasSelectedMethod = methodOptions.some(option => {
                const checkbox = document.querySelector(`input[name="${option}"]`);
                return checkbox && checkbox.checked;
            });
            
            if (!hasSelectedMethod) {
                isValid = false;
                warnings.push('Please select at least one method of calculation');
            }
        }
        
        console.log('üîç Complete Form Validation Debug:');
        console.log('   Current step:', this.currentStep);
        console.log('   Is valid:', isValid);
        console.log('   Warnings:', warnings);
        
        // Show warnings if any
        if (warnings.length > 0) {
            this.showWarnings(warnings);
        }
        
        return isValid;
    }
}

// Initialize Google Maps functionality when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Google Maps functionality
    initializeGoogleMaps();
});

// Google Maps Variables
let map;
let selectedMarker;
let selectedCoordinates = null;
let selectedLocationName = null;
let searchBox;
let currentMapField = null;

// Google Maps Functions
function initializeGoogleMaps() {
    // Add click handlers to map buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.map-select-btn')) {
            const button = e.target.closest('.map-select-btn');
            const isUnitMap = button.classList.contains('unit-map-btn');
            
            if (isUnitMap) {
                // Handle unit map button
                const unit = button.closest('.unit-container');
                const gpsField = unit.querySelector('.unit-gps-coordinates');
                openMapModal(gpsField, 'unit');
            } else {
                // Handle main form map button
                const gpsField = document.getElementById('gps_coordinates');
                openMapModal(gpsField, 'main');
            }
        }
    });
}

function openMapModal(field, type) {
    currentMapField = { field, type };
    
    const modal = document.getElementById('mapModal');
    modal.style.display = 'block';
    
    // Load Google Maps
    loadGoogleMaps()
        .then(() => {
            console.log('Google Maps loaded successfully, initializing map...');
            initMap();
            
            // If there's already a selected location, enable the confirm button
            if (selectedCoordinates) {
                const confirmBtn = document.getElementById('confirmLocationBtn');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                    confirmBtn.style.backgroundColor = '#28a745';
                    confirmBtn.style.borderColor = '#28a745';
                    confirmBtn.innerHTML = '<i class="fa fa-check"></i> Confirm Location';
                    console.log('‚úÖ Confirm button enabled for existing location');
                }
            }
        })
        .catch((error) => {
            console.error('Failed to load Google Maps:', error);
            showMapError(error.message);
        });
}

function loadGoogleMaps() {
    return new Promise((resolve, reject) => {
        // Check if Google Maps is already loaded
        if (typeof google !== 'undefined' && google.maps) {
            console.log('‚úÖ Google Maps already available');
            console.log('Places API available:', !!google.maps.places);
            resolve();
            return;
        }
        
        console.log('üîÑ Loading Google Maps...');
        
        // Get API key from server
        fetch('/api/method/climoro_onboarding.climoro_onboarding.doctype.onboarding_form.onboarding_form.get_google_maps_api_key')
            .then(response => {
                console.log('üì° API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üì° API response data:', data);
                
                if (data.message && data.message.success) {
                    const apiKey = data.message.api_key;
                    console.log('üîë API key retrieved successfully');
                    
                    // Check if script already exists
                    const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
                    if (existingScript) {
                        console.log('üìú Google Maps script already exists, waiting for load...');
                        // Wait for existing script to load
                        const checkGoogleMaps = setInterval(() => {
                            if (typeof google !== 'undefined' && google.maps) {
                                clearInterval(checkGoogleMaps);
                                console.log('‚úÖ Google Maps loaded from existing script');
                                console.log('Places API available:', !!google.maps.places);
                                resolve();
                            }
                        }, 100);
                        
                        setTimeout(() => {
                            clearInterval(checkGoogleMaps);
                            reject(new Error('Google Maps loading timeout'));
                        }, 10000);
                        return;
                    }
                    
                    // Create callback function
                    window.mapCallback = function() {
                        console.log('üéØ Google Maps callback triggered');
                        console.log('Google Maps loaded:', typeof google !== 'undefined' && !!google.maps);
                        console.log('Places API loaded:', !!google.maps.places);
                        resolve();
                    };
                    
                    // Create and load script
                    const script = document.createElement('script');
                    script.async = true;
                    script.defer = true;
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=mapCallback`;
                    script.onerror = (error) => {
                        console.error('‚ùå Script load error:', error);
                        reject(new Error('Failed to load Google Maps script'));
                    };
                    
                    console.log('üìú Loading script:', script.src);
                    document.head.appendChild(script);
                    
                } else {
                    console.error('‚ùå Failed to get API key:', data);
                    reject(new Error('Failed to get API key: ' + (data.message?.message || 'Unknown error')));
                }
            })
            .catch(error => {
                console.error('‚ùå Error fetching API key:', error);
                reject(new Error('Error fetching API key: ' + error.message));
            });
    });
}

function initMap() {
    console.log('üó∫Ô∏è initMap called');
    
    try {
        // Check if Google Maps is loaded
        if (typeof google === 'undefined' || !google.maps) {
            console.error('‚ùå Google Maps API not loaded');
            return;
        }
        
        console.log('‚úÖ Google Maps API loaded successfully');
        console.log('üîç Places API available:', !!google.maps.places);
        
        // Initialize map centered on India
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error('‚ùå Map element not found');
            return;
        }
        
        // Clear loading message
        mapElement.innerHTML = '';
        
        map = new google.maps.Map(mapElement, {
            center: { lat: 20.5937, lng: 78.9629 }, // India center
            zoom: 5,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true
        });
        
        console.log('‚úÖ Map initialized successfully');
        
        // Initialize Places search with Autocomplete
        const searchInput = document.getElementById('mapSearchInput');
        console.log('üîç Search input found:', !!searchInput);
        console.log('üîç Places API available:', !!google.maps.places);
        
        if (searchInput && google.maps.places) {
            try {
                // Create Autocomplete instead of SearchBox for better dropdown functionality
                const autocomplete = new google.maps.places.Autocomplete(searchInput, {
                    types: ['geocode', 'establishment'],
                    componentRestrictions: { country: 'in' }, // Restrict to India
                    fields: ['place_id', 'geometry', 'name', 'formatted_address']
                });
                
                console.log('‚úÖ Autocomplete created successfully');
                
                // Listen for place selection
                autocomplete.addListener('place_changed', () => {
                    console.log('üîç Place changed event triggered');
                    const place = autocomplete.getPlace();
                    console.log('üîç Selected place:', place);
                    
                    if (!place.geometry || !place.geometry.location) {
                        console.log('‚ùå Place has no geometry or location');
                        showNotification('No location found for this search. Please try a different search term.', 'warning');
                        return;
                    }
                    
                    // Store location name
                    selectedLocationName = place.name || place.formatted_address;
                    
                    // Center map on selected place
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    
                    // Add marker at selected place
                    addMarkerAtLocation(place.geometry.location);
                    
                    console.log('‚úÖ Place selected and map updated');
                    showNotification(`Location found: ${selectedLocationName}. Click "Confirm Location" to save.`, 'success');
                });
                
                // Add Enter key handler for manual address entry
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const address = searchInput.value.trim();
                        if (address) {
                            // Use Geocoder to convert address to coordinates
                            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ address: address }, (results, status) => {
                                if (status === 'OK' && results[0]) {
                                    const location = results[0].geometry.location;
                                    selectedLocationName = results[0].formatted_address;
                                    map.setCenter(location);
                                    map.setZoom(15);
                                    addMarkerAtLocation(location);
                                    showNotification(`Location found: ${selectedLocationName}. Click "Confirm Location" to save.`, 'success');
                                } else {
                                    showNotification('Could not find this address. Please try a different search term.', 'warning');
                                }
                            });
                        }
                    }
                });
                
                // Also create SearchBox for additional functionality
                searchBox = new google.maps.places.SearchBox(searchInput);
                console.log('‚úÖ SearchBox created successfully');
                
                // Bias search results to current map viewport
                map.addListener('bounds_changed', () => {
                    if (searchBox && map.getBounds()) {
                        searchBox.setBounds(map.getBounds());
                    }
                });
                
                // Listen for place search results (backup)
                searchBox.addListener('places_changed', () => {
                    console.log('üîç Places changed event triggered (SearchBox)');
                    const places = searchBox.getPlaces();
                    console.log('üîç Number of places found:', places.length);
                    
                    if (places.length === 0) {
                        console.log('üîç No places found');
                        return;
                    }
                    
                    const place = places[0];
                    console.log('üîç Selected place:', place.name);
                    console.log('üîç Place geometry:', !!place.geometry);
                    console.log('üîç Place location:', !!place.geometry?.location);
                    
                    if (!place.geometry || !place.geometry.location) {
                        console.log('‚ùå Place has no geometry or location');
                        return;
                    }
                    
                    // Center map on selected place
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    
                    // Add marker at selected place
                    addMarkerAtLocation(place.geometry.location);
                    
                    console.log('‚úÖ Place selected and map updated');
                });
                
                console.log('‚úÖ Places search initialized successfully with Autocomplete');
            } catch (placesError) {
                console.error('‚ùå Error initializing Places search:', placesError);
            }
        } else {
            console.warn('‚ö†Ô∏è Places API not available or search input not found');
            console.warn('Search input:', !!searchInput);
            console.warn('Places API:', !!google.maps.places);
        }
        
        // Add click listener to map
        map.addListener('click', (event) => {
            console.log('üó∫Ô∏è Map clicked at:', event.latLng.toString());
            addMarkerAtLocation(event.latLng);
        });
        
    } catch (error) {
        console.error('‚ùå Error initializing map:', error);
    }
}

function addMarkerAtLocation(location) {
    console.log('üìç Adding marker at location:', location.toString());
    
    // Remove existing marker
    if (selectedMarker) {
        selectedMarker.setMap(null);
    }
    
    // Add new marker
    selectedMarker = new google.maps.Marker({
        position: location,
        map: map,
        title: 'Selected Location'
    });
    
    // Store coordinates
    selectedCoordinates = {
        lat: location.lat(),
        lng: location.lng()
    };
    
    // Get location name using reverse geocoding
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: location }, (results, status) => {
        if (status === 'OK' && results[0]) {
            // Extract a more user-friendly location name
            const addressComponents = results[0].address_components;
            let locationParts = [];
            
            // Look for building name, establishment, or point of interest
            const building = addressComponents.find(component => 
                component.types.includes('establishment') || 
                component.types.includes('point_of_interest') ||
                component.types.includes('premise')
            );
            
            // Look for street name
            const street = addressComponents.find(component => 
                component.types.includes('route')
            );
            
            // Look for street number
            const streetNumber = addressComponents.find(component => 
                component.types.includes('street_number')
            );
            
            // Look for sublocality (area/neighborhood)
            const sublocality = addressComponents.find(component => 
                component.types.includes('sublocality_level_1') || 
                component.types.includes('sublocality')
            );
            
            // Look for postal code
            const postalCode = addressComponents.find(component => 
                component.types.includes('postal_code')
            );
            
            // Look for administrative area level 2 (district)
            const district = addressComponents.find(component => 
                component.types.includes('administrative_area_level_2')
            );
            
            // Look for locality (city)
            const locality = addressComponents.find(component => 
                component.types.includes('locality') || component.types.includes('sublocality')
            );
            
            // Look for state
            const state = addressComponents.find(component => 
                component.types.includes('administrative_area_level_1')
            );
            
            // Look for country
            const country = addressComponents.find(component => 
                component.types.includes('country')
            );
            
            // Build location name from available components in order of specificity
            if (building) locationParts.push(building.long_name);
            if (streetNumber && street) locationParts.push(`${streetNumber.long_name} ${street.long_name}`);
            else if (street) locationParts.push(street.long_name);
            if (sublocality) locationParts.push(sublocality.long_name);
            if (locality) locationParts.push(locality.long_name);
            if (district) locationParts.push(district.long_name);
            if (state) locationParts.push(state.long_name);
            if (postalCode) locationParts.push(postalCode.long_name);
            if (country) locationParts.push(country.long_name);
            
            // If we have meaningful location parts, use them; otherwise fall back to formatted address
            if (locationParts.length > 0) {
                // Create a concise but informative location name
                let finalLocationParts = [];
                
                // Always include building/establishment if available
                if (building) finalLocationParts.push(building.long_name);
                
                // Include street info if available
                if (streetNumber && street) finalLocationParts.push(`${streetNumber.long_name} ${street.long_name}`);
                else if (street) finalLocationParts.push(street.long_name);
                
                // Include area/neighborhood if available
                if (sublocality) finalLocationParts.push(sublocality.long_name);
                
                // Include city
                if (locality) finalLocationParts.push(locality.long_name);
                
                // Include state and country (always include these for context)
                if (state) finalLocationParts.push(state.long_name);
                if (country) finalLocationParts.push(country.long_name);
                
                selectedCoordinates.locationName = finalLocationParts.join(', ');
            } else {
                // Remove Plus Codes from formatted address if present
                let cleanAddress = results[0].formatted_address;
                // Remove Plus Code patterns (e.g., "28GP+7H ")
                cleanAddress = cleanAddress.replace(/[A-Z0-9]{2}[A-Z0-9]{2}\+[A-Z0-9]{2,3}\s*/g, '');
                selectedCoordinates.locationName = cleanAddress.trim();
            }
            
            console.log('üìç Location name:', selectedCoordinates.locationName);
            
            // Update coordinates display with location name
            const coordinatesText = `${selectedCoordinates.lat.toFixed(6)}, ${selectedCoordinates.lng.toFixed(6)}`;
            const coordinatesDisplay = document.getElementById('coordinatesDisplay');
            if (coordinatesDisplay) {
                coordinatesDisplay.textContent = `Selected: ${coordinatesText}\nLocation: ${selectedCoordinates.locationName}`;
                console.log('üìç Updated coordinates display with location name');
            }
        } else {
            console.log('üìç Could not get location name');
        }
    });
    
    // Update coordinates display immediately
    const coordinatesText = `${selectedCoordinates.lat.toFixed(6)}, ${selectedCoordinates.lng.toFixed(6)}`;
    const coordinatesDisplay = document.getElementById('coordinatesDisplay');
    if (coordinatesDisplay) {
        coordinatesDisplay.textContent = `Selected: ${coordinatesText}\nGetting location name...`;
        console.log('üìç Updated coordinates display');
    }
    
    console.log('‚úÖ Location selected');
}

function closeMapModal() {
    document.getElementById('mapModal').style.display = 'none';
}

function confirmLocation() {
    console.log('üîò Confirm Location clicked');
    console.log('Selected coordinates:', selectedCoordinates);
    
    if (selectedCoordinates) {
        const coordinatesText = `${selectedCoordinates.lat.toFixed(6)}, ${selectedCoordinates.lng.toFixed(6)}`;
        console.log('Setting coordinates:', coordinatesText);
        
        // Update the GPS coordinates field
        if (currentMapField && currentMapField.field) {
            currentMapField.field.value = coordinatesText;
            
            // Trigger change event to ensure form validation updates
            const event = new Event('input', { bubbles: true });
            currentMapField.field.dispatchEvent(event);
        }
        
        // Update the location name field if it exists
        if (selectedCoordinates.locationName) {
            const locationNameField = document.getElementById('location_name');
            if (locationNameField) {
                locationNameField.value = selectedCoordinates.locationName;
                console.log('üìç Setting location name:', selectedCoordinates.locationName);
                
                // Trigger change event
                const event = new Event('input', { bubbles: true });
                locationNameField.dispatchEvent(event);
            }
            
            // For unit fields, find the corresponding location name field
            if (currentMapField && currentMapField.type === 'unit') {
                const unitContainer = currentMapField.field.closest('.unit-container');
                if (unitContainer) {
                    const unitLocationNameField = unitContainer.querySelector('.unit-location-name');
                    if (unitLocationNameField) {
                        unitLocationNameField.value = selectedCoordinates.locationName;
                        console.log('üìç Setting unit location name:', selectedCoordinates.locationName);
                        
                        // Trigger change event
                        const event = new Event('input', { bubbles: true });
                        unitLocationNameField.dispatchEvent(event);
                    }
                }
            }
        }
        
        closeMapModal();
        
        // Show success message
        const message = selectedCoordinates.locationName 
            ? `Location selected: ${selectedCoordinates.locationName}`
            : `Location selected: ${coordinatesText}`;
        showNotification(message, 'success');
        
        console.log('‚úÖ Location confirmed successfully');
    } else {
        console.log('‚ùå No coordinates selected');
        showNotification('Please click on the map to select a location first.', 'error');
    }
}

function enableManualEntry() {
    if (!currentMapField) return;
    
    // Enable manual entry
    currentMapField.field.removeAttribute('readonly');
    currentMapField.field.focus();
    currentMapField.field.placeholder = 'Enter coordinates manually (e.g., 28.6139, 77.2090)';
    
    // Show help message
    showNotification('You can now enter coordinates manually. Format: latitude, longitude', 'info');
}

function showMapError(message) {
    const mapElement = document.getElementById('map');
    if (mapElement) {
        mapElement.innerHTML = `
            <div class="map-error">
                <h4>üìç Map Loading Issue</h4>
                <p>${message}</p>
                <div class="manual-entry-help">
                    <strong>‚úÖ Alternative: Manual Entry</strong><br>
                    You can enter coordinates directly in the GPS field below:<br>
                    <code style="background: white; padding: 2px 5px;">28.6139, 77.2090</code> (latitude, longitude)<br>
                    <small>üí° Get coordinates from Google Maps by right-clicking any location</small>
                </div>
            </div>
        `;
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10001;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;
    
    // Set background color based on type
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        info: '#17a2b8',
        warning: '#ffc107'
    };
    notification.style.backgroundColor = colors[type] || colors.info;
    
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Add slideIn animation
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
`;
document.head.appendChild(style);

// Industry and Sub-Industry mapping
const industrySubTypes = {
    "Energy": [
        "Oil & Gas Extraction",
        "Oil Refining",
        "Natural Gas Transmission & Distribution",
        "Coal Mining & Processing",
        "Renewable Energy (Solar, Wind, Hydro, etc.)",
        "Power Generation (Thermal)",
        "Transmission & Distribution (Electric Utilities)"
    ],
    "Manufacturing": [
        "Cement & Lime Production",
        "Iron & Steel",
        "Aluminum",
        "Chemicals & Fertilizers",
        "Glass & Ceramics",
        "Paper & Pulp",
        "Food & Beverage",
        "Textiles & Apparel",
        "Plastics & Rubber",
        "Electronics & Electrical Equipment",
        "Machinery & Tools",
        "Automobile & Parts Manufacturing"
    ],
    "Construction": [
        "Commercial Construction",
        "Residential Construction",
        "Infrastructure (Roads, Bridges, etc.)",
        "Cement/Concrete On-site Mixing",
        "Demolition & Waste Handling"
    ],
    "Transportation & Logistics": [
        "Freight (Road, Rail, Air, Sea)",
        "Passenger Transport (Buses, Airlines, Rail)",
        "Warehousing & Distribution",
        "Shipping & Port Operations",
        "Courier & Postal Services"
    ],
    "Retail & Consumer Goods": [
        "Fashion & Apparel",
        "Food Retail & Supermarkets",
        "Electronics & Appliances",
        "E-commerce",
        "Department Stores"
    ],
    "Chemical & Petrochemical": [
        "Basic Chemicals",
        "Specialty Chemicals",
        "Agrochemicals",
        "Petrochemical Derivatives",
        "Pharmaceuticals"
    ],
    "Financial & Insurance Services": [
        "Banks & Lending Institutions",
        "Investment Firms",
        "Insurance",
        "Asset Management",
        "Fintech"
    ],
    "Real Estate & Property Management": [
        "Commercial Real Estate",
        "Residential Real Estate",
        "Property Development",
        "Facility Management"
    ],
    "Services": [
        "IT & Data Centers",
        "Hospitality (Hotels, Resorts)",
        "Education (Universities, Schools)",
        "Healthcare (Hospitals, Clinics)",
        "Professional Services (Legal, Consulting)"
    ],
    "Agriculture, Forestry & Land Use": [
        "Crop Cultivation",
        "Livestock (Cattle, Poultry, etc.)",
        "Dairy Farming",
        "Aquaculture",
        "Agroforestry",
        "Timber & Logging",
        "Land Restoration"
    ],
    "Waste Management": [
        "Solid Waste Collection",
        "Landfilling",
        "Waste-to-Energy",
        "Composting",
        "Wastewater Treatment",
        "Recycling Operations"
    ],
    "Water Supply & Treatment": [
        "Water Utilities",
        "Desalination Plants",
        "Irrigation Systems",
        "Stormwater Management"
    ],
    "Telecommunications": [
        "Data Transmission Services",
        "Mobile Network Operations",
        "Satellite Communications",
        "Cable & Broadcasting"
    ],
    "Government & Public Administration": [
        "Defense & Military Operations",
        "Municipal Services",
        "Urban Planning",
        "Public Infrastructure"
    ],
    "Aviation & Aerospace": [
        "Commercial Airlines",
        "Private Aviation",
        "Aircraft Manufacturing",
        "Airport Operations"
    ],
    "Mining & Quarrying": [
        "Metal Ore Mining",
        "Non-metallic Mineral Extraction",
        "Rare Earth Elements",
        "Quarry Operations"
    ],
    "Fossil Fuel Supply Chain": [
        "Exploration & Production",
        "Midstream (Pipelines, Storage)",
        "Downstream (Retail Fuel, Gas Stations)"
    ],
    "Fisheries & Marine": [
        "Industrial Fishing",
        "Aquaculture",
        "Seafood Processing",
        "Marine Transport"
    ],
    "Media, Entertainment & Culture": [
        "Streaming Services",
        "Publishing",
        "Events & Exhibitions",
        "Film Production"
    ],
    "Carbon Market & Climate Services": [
        "Project Developers (RE, Cookstoves, AFOLU)",
        "MRV Providers",
        "Carbon Credit Traders & Registries",
        "Environmental Consulting"
    ]
};

// Function to update sub-industry options based on selected industry
function updateSubIndustryOptions() {
    const industrySelect = document.getElementById('industry_type');
    const subIndustrySelect = document.getElementById('sub_industry_type');
    
    console.log('üîÑ updateSubIndustryOptions called');
    console.log('Industry select value:', industrySelect?.value);
    console.log('Industry subtypes available:', industrySubTypes);
    
    // Clear existing options
    subIndustrySelect.innerHTML = '<option value="">Select Sub-Industry Type</option>';
    
    const selectedIndustry = industrySelect.value;
    
    if (selectedIndustry && industrySubTypes[selectedIndustry]) {
        // Add options for the selected industry
        industrySubTypes[selectedIndustry].forEach(subType => {
            const option = document.createElement('option');
            option.value = subType;
            option.textContent = subType;
            subIndustrySelect.appendChild(option);
        });
        
        // Enable the sub-industry select
        subIndustrySelect.disabled = false;
        console.log(`‚úÖ Updated sub-industry options for: ${selectedIndustry}`);
        console.log('Available sub-industry options:', industrySubTypes[selectedIndustry]);
    } else {
        // Disable the sub-industry select if no industry is selected
        subIndustrySelect.disabled = true;
        subIndustrySelect.innerHTML = '<option value="">Select Industry Type First</option>';
        console.log('‚ùå No industry selected or industry not found');
    }
}

// Initialize sub-industry select as disabled on page load
document.addEventListener('DOMContentLoaded', function() {
    const subIndustrySelect = document.getElementById('sub_industry_type');
    if (subIndustrySelect) {
        subIndustrySelect.disabled = true;
    }
});

    // Add acknowledgment page HTML
    document.addEventListener('DOMContentLoaded', function() {
        const acknowledgmentHTML = `
            <div id="acknowledgmentPage" class="acknowledgment-page" style="display: none;">
                <div class="acknowledgment-container">
                    <div class="acknowledgment-header">
                        <div class="success-icon">‚úÖ</div>
                        <h1>Application Submitted Successfully!</h1>
                        <p>Thank you for submitting your onboarding application. We have received your information and will process it shortly.</p>
                    </div>
                    
                    <div class="acknowledgment-footer">
                        <p><strong>Application ID:</strong> <span id="ack-application-id"></span></p>
                        <p><strong>Submission Date:</strong> <span id="ack-submission-date"></span></p>
                        <p><strong>Status:</strong> <span class="status-badge">Submitted</span></p>
                    </div>
                    
                    <div class="acknowledgment-actions">
                        <button type="button" class="btn btn-primary" onclick="window.location.href='/'">
                            <i class="fas fa-home"></i> Go to Home
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Append the acknowledgment HTML to the body
        document.body.insertAdjacentHTML('beforeend', acknowledgmentHTML);
    });

// GHG Accounting Dynamic Functions

// Function to toggle scope options visibility
function toggleScopeOptions(scopeType) {
    const optionsDiv = document.getElementById(scopeType + '-options');
    let checkboxName;
    
    // Map scopeType to the new individual checkbox field names
    switch(scopeType) {
        case 'scope1':
            checkboxName = 'scopes_to_report_scope1';
            break;
        case 'scope2':
            checkboxName = 'scopes_to_report_scope2';
            break;
        case 'scope3':
            checkboxName = 'scopes_to_report_scope3';
            break;
        case 'reductions':
            checkboxName = 'scopes_to_report_reductions';
            break;
        default:
            checkboxName = '';
    }
    
    const checkbox = document.querySelector(`input[name="${checkboxName}"]`);
    
    if (checkbox && checkbox.checked) {
        optionsDiv.style.display = 'block';
        console.log('üå± Showing options for:', scopeType);
    } else {
        optionsDiv.style.display = 'none';
        console.log('üå± Hiding options for:', scopeType);
    }
}

// Function to populate Scope 1 fields
function populateScope1Fields() {
    const section = document.getElementById('scope1-section');
    section.innerHTML = `
        <h3>Section B: Scope 1 Emissions Reduction Targets</h3>
        
        <div class="form-group">
            <label for="scope_1_target_type">Scope 1 Target Type</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_target_type" value="Near-term Target (5‚Äì10 years)"> Near-term Target (5‚Äì10 years)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_target_type" value="Long-term Net-Zero Target (by 2050 or earlier)"> Long-term Net-Zero Target (by 2050 or earlier)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_target_type" value="Both"> Both
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label for="scope_1_intensity_reduction">Scope 1 Intensity Reduction</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_intensity_reduction" onchange="toggleScope1Fields()"> Reduce Scope 1 emissions intensity by percentage
                </label>
            </div>
        </div>
        
        <div class="form-group" id="scope1-percentage-group" style="display: none;">
            <label for="scope_1_reduction_percentage">Scope 1 Reduction Percentage</label>
            <input type="number" id="scope_1_reduction_percentage" name="scope_1_reduction_percentage" min="0" max="100" step="0.1" placeholder="Enter percentage">
        </div>
        
        <div class="form-group" id="scope1-year-group" style="display: none;">
            <label for="scope_1_target_year">Scope 1 Target Year</label>
            <input type="number" id="scope_1_target_year" name="scope_1_target_year" min="2024" max="2050" placeholder="Enter target year">
        </div>
        
        <div class="form-group">
            <label for="scope_1_mitigation_strategies">Scope 1 Mitigation Strategies</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_mitigation_strategies" value="Energy efficiency improvements"> Energy efficiency improvements
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_mitigation_strategies" value="Onsite renewable energy (e.g., rooftop solar)"> Onsite renewable energy (e.g., rooftop solar)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_mitigation_strategies" value="Fuel switching to clean alternatives"> Fuel switching to clean alternatives
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_mitigation_strategies" value="Process optimization"> Process optimization
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_mitigation_strategies" value="Equipment upgrades"> Equipment upgrades
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_1_mitigation_strategies" value="Fugitive emissions control"> Fugitive emissions control
                </label>
            </div>
        </div>
    `;
}

// Function to populate Scope 2 fields
function populateScope2Fields() {
    const section = document.getElementById('scope2-section');
    section.innerHTML = `
        <h3>Section C: Scope 2 Emissions Reduction Targets</h3>
        
        <div class="form-group">
            <label for="scope_2_target_type">Scope 2 Target Type</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_target_type" value="Near-term Target (5‚Äì10 years)"> Near-term Target (5‚Äì10 years)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_target_type" value="Long-term Net-Zero Target (by 2050 or earlier)"> Long-term Net-Zero Target (by 2050 or earlier)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_target_type" value="Both"> Both
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label for="scope_2_intensity_reduction">Scope 2 Intensity Reduction</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_intensity_reduction" onchange="toggleScope2Fields()"> Reduce Scope 2 emissions intensity by percentage
                </label>
            </div>
        </div>
        
        <div class="form-group" id="scope2-percentage-group" style="display: none;">
            <label for="scope_2_reduction_percentage">Scope 2 Reduction Percentage</label>
            <input type="number" id="scope_2_reduction_percentage" name="scope_2_reduction_percentage" min="0" max="100" step="0.1" placeholder="Enter percentage">
        </div>
        
        <div class="form-group" id="scope2-year-group" style="display: none;">
            <label for="scope_2_target_year">Scope 2 Target Year</label>
            <input type="number" id="scope_2_target_year" name="scope_2_target_year" min="2024" max="2050" placeholder="Enter target year">
        </div>
        
        <div class="form-group">
            <label for="scope_2_mitigation_strategies">Scope 2 Mitigation Strategies</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_mitigation_strategies" value="Offsite renewable procurement"> Offsite renewable procurement
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_mitigation_strategies" value="Green power purchase agreements"> Green power purchase agreements
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_mitigation_strategies" value="Energy efficiency improvements"> Energy efficiency improvements
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_mitigation_strategies" value="Demand response programs"> Demand response programs
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_2_mitigation_strategies" value="Grid decarbonization support"> Grid decarbonization support
                </label>
            </div>
        </div>
    `;
}

// Function to populate Scope 3 fields
function populateScope3Fields() {
    const section = document.getElementById('scope3-section');
    section.innerHTML = `
        <h3>Section D: Scope 3 Emissions Reduction Targets</h3>
        
        <div class="form-group">
            <label for="scope_3_categories_included">Scope 3 Categories Included</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Purchased goods and services"> Purchased goods and services
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Capital goods"> Capital goods
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Fuel- and energy-related activities"> Fuel- and energy-related activities
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Upstream/downstream transportation and distribution"> Upstream/downstream transportation and distribution
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Waste generated in operations"> Waste generated in operations
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Business travel / employee commuting"> Business travel / employee commuting
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Use of sold products"> Use of sold products
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="End-of-life treatment of sold products"> End-of-life treatment of sold products
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_categories_included" value="Leased assets, franchises, or investments"> Leased assets, franchises, or investments
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label for="scope_3_target_type">Scope 3 Target Type</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_target_type" value="Near-term Target (5‚Äì10 years)"> Near-term Target (5‚Äì10 years)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_target_type" value="Long-term Net-Zero Target (by 2050 or earlier)"> Long-term Net-Zero Target (by 2050 or earlier)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_target_type" value="Both"> Both
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label for="scope_3_intensity_reduction">Scope 3 Intensity Reduction</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_intensity_reduction" onchange="toggleScope3Fields()"> Reduce Scope 3 emissions intensity by percentage
                </label>
            </div>
        </div>
        
        <div class="form-group" id="scope3-percentage-group" style="display: none;">
            <label for="scope_3_reduction_percentage">Scope 3 Reduction Percentage</label>
            <input type="number" id="scope_3_reduction_percentage" name="scope_3_reduction_percentage" min="0" max="100" step="0.1" placeholder="Enter percentage">
        </div>
        
        <div class="form-group" id="scope3-year-group" style="display: none;">
            <label for="scope_3_target_year">Scope 3 Target Year</label>
            <input type="number" id="scope_3_target_year" name="scope_3_target_year" min="2024" max="2050" placeholder="Enter target year">
        </div>
        
        <div class="form-group">
            <label for="scope_3_mitigation_strategies">Scope 3 Mitigation Strategies</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_mitigation_strategies" value="Supplier engagement"> Supplier engagement
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_mitigation_strategies" value="Low-carbon input materials"> Low-carbon input materials
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_mitigation_strategies" value="Redesign for use-phase reduction"> Redesign for use-phase reduction
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_mitigation_strategies" value="Optimize logistics"> Optimize logistics
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_mitigation_strategies" value="Circular economy practices"> Circular economy practices
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="scope_3_mitigation_strategies" value="Product lifecycle optimization"> Product lifecycle optimization
                </label>
            </div>
        </div>
    `;
}

// Function to populate Reductions fields
function populateReductionsFields() {
    const section = document.getElementById('reductions-section');
    section.innerHTML = `
        <h3>Section E: Reduction Strategies</h3>
        
        <div class="form-group">
            <label for="reduction_target_type">Reduction Target Type</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="reduction_target_type" value="Near-term Target (5‚Äì10 years)"> Near-term Target (5‚Äì10 years)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="reduction_target_type" value="Long-term Net-Zero Target (by 2050 or earlier)"> Long-term Net-Zero Target (by 2050 or earlier)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="reduction_target_type" value="Both"> Both
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label for="land_sector_removals">Land Sector & Removals (Optional)</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="land_sector_removals" value="Afforestation / reforestation"> Afforestation / reforestation
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="land_sector_removals" value="Soil carbon improvement"> Soil carbon improvement
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="land_sector_removals" value="Urban greening"> Urban greening
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="land_sector_removals" value="Biochar application"> Biochar application
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="land_sector_removals" value="Carbon capture or enhanced weathering"> Carbon capture or enhanced weathering
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="land_sector_removals" value="Certified removals (DAC, agroforestry)"> Certified removals (DAC, agroforestry)
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label for="residual_emissions_strategy">Residual Emissions Strategy</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="residual_emissions_strategy" value="High-quality removal credits"> High-quality removal credits
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="residual_emissions_strategy" value="Beyond Value Chain Mitigation (BVCM)"> Beyond Value Chain Mitigation (BVCM)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" name="residual_emissions_strategy" value="Temporary voluntary solutions"> Temporary voluntary solutions
                </label>
            </div>
        </div>
    `;
}

// Toggle functions for dynamic fields
function toggleScope1Fields() {
    const checkbox = document.querySelector('input[name="scope_1_intensity_reduction"]');
    const percentageGroup = document.getElementById('scope1-percentage-group');
    const yearGroup = document.getElementById('scope1-year-group');
    
    if (checkbox && checkbox.checked) {
        percentageGroup.style.display = 'block';
        yearGroup.style.display = 'block';
    } else {
        percentageGroup.style.display = 'none';
        yearGroup.style.display = 'none';
    }
}

function toggleScope2Fields() {
    const checkbox = document.querySelector('input[name="scope_2_intensity_reduction"]');
    const percentageGroup = document.getElementById('scope2-percentage-group');
    const yearGroup = document.getElementById('scope2-year-group');
    
    if (checkbox && checkbox.checked) {
        percentageGroup.style.display = 'block';
        yearGroup.style.display = 'block';
    } else {
        percentageGroup.style.display = 'none';
        yearGroup.style.display = 'none';
    }
}

function toggleScope3Fields() {
    const checkbox = document.querySelector('input[name="scope_3_intensity_reduction"]');
    const percentageGroup = document.getElementById('scope3-percentage-group');
    const yearGroup = document.getElementById('scope3-year-group');
    
    if (checkbox && checkbox.checked) {
        percentageGroup.style.display = 'block';
        yearGroup.style.display = 'block';
    } else {
        percentageGroup.style.display = 'none';
        yearGroup.style.display = 'none';
    }
}

function toggleOtherFrequency() {
    const select = document.getElementById('monitoring_frequency');
    const otherGroup = document.getElementById('other-frequency-group');
    
    if (select && select.value === 'Other') {
        otherGroup.style.display = 'block';
    } else {
        otherGroup.style.display = 'none';
    }
}

function toggleSoftwareName() {
    const checkbox = document.querySelector('input[name="ghg_tracking_tools_software"]');
    const softwareGroup = document.getElementById('software-name-group');
    
    if (checkbox && checkbox.checked) {
        softwareGroup.style.display = 'block';
    } else {
        softwareGroup.style.display = 'none';
    }
}

// Check for semiconductor industry to show NF3 option
document.addEventListener('DOMContentLoaded', function() {
    const industrySelect = document.getElementById('industry_type');
    const nf3Checkbox = document.getElementById('nf3-checkbox');
    
    if (industrySelect && nf3Checkbox) {
        industrySelect.addEventListener('change', function() {
            const selectedIndustry = this.value;
            if (selectedIndustry && selectedIndustry.toLowerCase().includes('semiconductor')) {
                nf3Checkbox.style.display = 'block';
            } else {
                nf3Checkbox.style.display = 'none';
                // Uncheck NF3 if not semiconductor industry
                const nf3Input = nf3Checkbox.querySelector('input');
                if (nf3Input) {
                    nf3Input.checked = false;
                }
            }
        });
    }
    
    // Debug function to check all checkbox field names
    window.debugCheckboxFields = function() {
        console.log('=== Checking all checkbox field names ===');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const fieldNames = [];
        
        checkboxes.forEach((checkbox, index) => {
            const name = checkbox.getAttribute('name');
            const value = checkbox.getAttribute('value');
            const checked = checkbox.checked;
            fieldNames.push({ name, value, checked, index });
            console.log(`Checkbox ${index + 1}: name="${name}", value="${value}", checked=${checked}`);
        });
        
        console.log('Total checkboxes found:', checkboxes.length);
        console.log('Field names array:', fieldNames);
        return fieldNames;
    };
    
    // Debug function to check specific field mapping
    window.debugFieldMapping = function(fieldName) {
        console.log(`=== Debugging field: ${fieldName} ===`);
        const checkbox = document.querySelector(`input[name="${fieldName}"]`);
        if (checkbox) {
            console.log(`Found checkbox:`, checkbox);
            console.log(`Checked: ${checkbox.checked}`);
            console.log(`Value: ${checkbox.value}`);
            console.log(`Visible: ${checkbox.offsetWidth > 0 && checkbox.offsetHeight > 0}`);
        } else {
            console.log(`‚ùå Checkbox with name "${fieldName}" not found!`);
        }
    };
    
    // Debug function specifically for the problematic field
    window.debugTonneField = function() {
        console.log('=== Debugging kgCO‚ÇÇe per tonne field ===');
        const checkbox = document.querySelector('input[name="target_metrics_kgco2e_tonne"]');
        if (checkbox) {
            console.log('‚úÖ Checkbox found:', checkbox);
            console.log('Checked:', checkbox.checked);
            console.log('Value:', checkbox.value);
            console.log('Name:', checkbox.name);
            
            // Test the getCheckboxValue function
            const form = document.getElementById('onboarding-form');
            if (form && form.getCheckboxValue) {
                const value = form.getCheckboxValue('target_metrics_kgco2e_tonne');
                console.log('getCheckboxValue result:', value);
            }
        } else {
            console.log('‚ùå Checkbox not found!');
        }
    };
    
    // Debug function to test checkbox styling
    window.debugCheckboxStyling = function() {
        console.log('=== Testing Checkbox Styling ===');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        console.log(`Found ${checkboxes.length} checkboxes`);
        
        checkboxes.forEach((checkbox, index) => {
            const computedStyle = window.getComputedStyle(checkbox);
            console.log(`Checkbox ${index + 1}:`, {
                name: checkbox.name,
                checked: checkbox.checked,
                backgroundColor: computedStyle.backgroundColor,
                borderColor: computedStyle.borderColor,
                borderRadius: computedStyle.borderRadius,
                width: computedStyle.width,
                height: computedStyle.height,
                appearance: computedStyle.appearance,
                webkitAppearance: computedStyle.webkitAppearance
            });
        });
    };
    
    // Auto-run debug on page load (remove this in production)
    // setTimeout(() => debugCheckboxFields(), 2000);
});


</script>

<!-- Welcome Modal (Shows on page load) -->
<div id="welcome-modal" class="modal welcome-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üéØ Welcome to Climoro Onboarding</h3>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">üöÄ</div>
                <h4>Get Started with Your Onboarding</h4>
                <p>Choose how you'd like to proceed with your Climoro onboarding application:</p>
                <div class="welcome-options">
                    <button type="button" class="btn btn-primary welcome-btn" id="start-new-application">
                        <div class="btn-icon">üÜï</div>
                        <div class="btn-content">
                            <div class="btn-title">Start New Application</div>
                            <div class="btn-subtitle">Begin a fresh onboarding process</div>
                        </div>
                    </button>
                    <button type="button" class="btn btn-secondary welcome-btn" id="resume-application">
                        <div class="btn-icon">üîÑ</div>
                        <div class="btn-content">
                            <div class="btn-title">Resume Application</div>
                            <div class="btn-subtitle">Continue where you left off</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resume Modal -->
<div id="resume-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîÑ Resume Your Application</h3>
            <span class="close" id="close-resume-modal">&times;</span>
        </div>
        <div class="modal-body">
            <div id="resume-form-container">
                <p>Enter your email address to resume your incomplete onboarding application:</p>
                <form id="resume-form">
                    <div class="form-group">
                        <label for="resume-email">Email Address *</label>
                        <input type="email" id="resume-email" name="resume-email" class="form-control" required>
                    </div>
                                    <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Send Resume Link</button>
                    <button type="button" class="btn btn-secondary" id="back-to-welcome">‚Üê Back</button>
                </div>
                </form>
                <div id="resume-message"></div>
            </div>
        </div>
    </div>
</div>

<!-- Resume Success Modal -->
<div id="resume-success-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úÖ Resume Link Sent</h3>
            <span class="close" id="close-success-modal">&times;</span>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">üìß</div>
                <h4>Check Your Email</h4>
                <p>We've sent a resume link to your email address. The link will expire in 24 hours.</p>
                <p><strong>Didn't receive the email?</strong> Check your spam folder or try again.</p>
                <button type="button" class="btn btn-primary" id="close-success-btn">Got it!</button>
            </div>
        </div>
    </div>
</div>

<!-- Resume Application Modal -->
<div id="resume-application-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîÑ Resume Application</h3>
            <span class="close" id="close-application-modal">&times;</span>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                <h4>Welcome Back!</h4>
                <p>We found your incomplete application. You can resume from where you left off or start fresh.</p>
                <div class="resume-options">
                    <button type="button" class="btn btn-primary" id="resume-existing">üîÑ Resume Existing Application</button>
                    <button type="button" class="btn btn-secondary" id="start-fresh">üÜï Start Fresh</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Styles -->
<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.welcome-modal {
    display: none;
    z-index: 2000;
}

.form-blur {
    filter: blur(5px);
    pointer-events: none;
    opacity: 0.3;
    transition: all 0.3s ease;
}

.welcome-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 30px;
}

.welcome-btn {
    display: flex;
    align-items: center;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    text-align: left;
    min-height: 80px;
}

.welcome-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.welcome-btn .btn-icon {
    font-size: 32px;
    margin-right: 20px;
    flex-shrink: 0;
}

.welcome-btn .btn-content {
    flex: 1;
}

.welcome-btn .btn-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 5px;
}

.welcome-btn .btn-subtitle {
    font-size: 14px;
    opacity: 0.8;
}

#form-container {
    transition: all 0.3s ease;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    background: #28a745;
    color: white;
    padding: 20px;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 20px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.resume-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.resume-options .btn {
    padding: 15px 20px;
    font-size: 16px;
}



#resume-message {
    margin-top: 15px;
    padding: 10px;
    border-radius: 5px;
}

#resume-message .success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

#resume-message .error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

#resume-message .info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
</style>

<!-- Resume JavaScript -->
<script>
// Resume functionality
let isResumeMode = false;
let resumeSessionData = null;
let welcomeModalShown = false;

// Initialize resume functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeWelcomeModal();
    initializeResumeFunctionality();
    checkForResumeToken();

    // Check for resume token and wait for verification before initializing form
    const urlParams = new URLSearchParams(window.location.search);
    const resumeToken = urlParams.get('resume');
    
    if (resumeToken) {
        console.log('Resume token found, verifying before form initialization...');
        verifyResumeToken(resumeToken);
        
        // Wait for resume data to be loaded before initializing form
        let attempts = 0;
        const maxAttempts = 100; // 10 seconds max wait
        
        const waitForResumeData = () => {
            attempts++;
            console.log(`Waiting for resume data (attempt ${attempts}/${maxAttempts})...`);
            
            if (window.resumeSessionData) {
                console.log('Resume data loaded, initializing form...');
                // Initialize form after resume data is loaded
                window.onboardingForm = new OnboardingForm();
                return;
            }
            
            if (attempts >= maxAttempts) {
                console.log('Timeout waiting for resume data, initializing form normally');
                window.onboardingForm = new OnboardingForm();
                return;
            }
            
            // Check again in 100ms
            setTimeout(waitForResumeData, 100);
        };
        
        // Start waiting
        setTimeout(waitForResumeData, 100);
    } else {
        // No resume token, initialize form immediately
        console.log('No resume token, initializing form immediately...');
        window.onboardingForm = new OnboardingForm();
    }
});

function initializeWelcomeModal() {
    const welcomeModal = document.getElementById('welcome-modal');
    const formContainer = document.getElementById('form-container');
    const startNewBtn = document.getElementById('start-new-application');
    const resumeBtn = document.getElementById('resume-application');
    
    // Check for tokens in URL before showing welcome modal
    const urlParams = new URLSearchParams(window.location.search);
    const resumeToken = urlParams.get('resume');
    const verifyToken = urlParams.get('verify');
    
    // Only show welcome modal if no tokens are present
    if (welcomeModal && !welcomeModalShown && !resumeToken && !verifyToken) {
        welcomeModal.style.display = 'block';
        formContainer.classList.add('form-blur');
        welcomeModalShown = true;
    }
    
    // Start new application
    startNewBtn.addEventListener('click', function() {
        welcomeModal.style.display = 'none';
        formContainer.classList.remove('form-blur');
        resetForm();
        // Focus on first field
        const firstInput = document.querySelector('#onboarding-form input');
        if (firstInput) {
            firstInput.focus();
        }
    });
    
    // Resume application
    resumeBtn.addEventListener('click', function() {
        welcomeModal.style.display = 'none';
        // Don't remove blur yet - keep form blurred while in resume modal
        // Show resume modal
        const resumeModal = document.getElementById('resume-modal');
        if (resumeModal) {
            resumeModal.style.display = 'block';
        }
    });
}

function initializeResumeFunctionality() {
    const resumeModal = document.getElementById('resume-modal');
    const closeResumeModal = document.getElementById('close-resume-modal');
    const resumeForm = document.getElementById('resume-form');
    const backToWelcome = document.getElementById('back-to-welcome');
    
    const successModal = document.getElementById('resume-success-modal');
    const closeSuccessModal = document.getElementById('close-success-modal');
    const closeSuccessBtn = document.getElementById('close-success-btn');
    
    const applicationModal = document.getElementById('resume-application-modal');
    const closeApplicationModal = document.getElementById('close-application-modal');
    const resumeExisting = document.getElementById('resume-existing');
    const startFresh = document.getElementById('start-fresh');
    
    // Close modal events
    closeResumeModal.addEventListener('click', function() {
        resumeModal.style.display = 'none';
    });
    
    closeSuccessModal.addEventListener('click', function() {
        successModal.style.display = 'none';
    });
    
    closeSuccessBtn.addEventListener('click', function() {
        successModal.style.display = 'none';
    });
    
    closeApplicationModal.addEventListener('click', function() {
        applicationModal.style.display = 'none';
    });
    
    // Back to welcome modal
    backToWelcome.addEventListener('click', function() {
        resumeModal.style.display = 'none';
        const welcomeModal = document.getElementById('welcome-modal');
        const formContainer = document.getElementById('form-container');
        if (welcomeModal) {
            welcomeModal.style.display = 'block';
        }
        if (formContainer) {
            formContainer.classList.add('form-blur');
        }
    });
    
    startFresh.addEventListener('click', function() {
        applicationModal.style.display = 'none';
        resetForm();
    });
    
    // Resume existing application
    resumeExisting.addEventListener('click', function() {
        applicationModal.style.display = 'none';
        if (resumeSessionData) {
            restoreFormData(resumeSessionData);
        }
    });
    
    // Resume form submission
    resumeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('resume-email').value;
        
        if (!email) {
            showResumeMessage('Please enter your email address.', 'error');
            return;
        }
        
        showResumeMessage('Sending resume link...', 'info');
        
        frappe.call({
            method: 'climoro_onboarding.www.apply.api.send_resume_email',
            args: {
                email: email
            },
            callback: function(response) {
                if (response.message && response.message.success) {
                    resumeModal.style.display = 'none';
                    successModal.style.display = 'block';
                } else {
                    showResumeMessage(response.message?.message || 'Failed to send resume link. Please try again.', 'error');
                }
            },
            error: function() {
                showResumeMessage('Error sending resume link. Please try again.', 'error');
            }
        });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === resumeModal) {
            resumeModal.style.display = 'none';
        }
        if (event.target === successModal) {
            successModal.style.display = 'none';
        }
        if (event.target === applicationModal) {
            applicationModal.style.display = 'none';
        }
        // Don't allow closing welcome modal by clicking outside
        // User must make a choice
    });
}

function checkForResumeToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const resumeToken = urlParams.get('resume');
    const verifyToken = urlParams.get('verify');
    
    // If there's a resume token or verification token, skip welcome modal
    if (resumeToken || verifyToken) {
        console.log('Token detected:', resumeToken ? 'resume' : 'verify', resumeToken || verifyToken);
        // Hide welcome modal if any token is present
        const welcomeModal = document.getElementById('welcome-modal');
        const formContainer = document.getElementById('form-container');
        if (welcomeModal) {
            welcomeModal.style.display = 'none';
        }
        if (formContainer) {
            formContainer.classList.remove('form-blur');
        }
        
        // Handle resume token
        if (resumeToken) {
            verifyResumeToken(resumeToken);
        }
        // Note: Verification token handling is done by existing verification logic
    }
}

function verifyResumeToken(token) {
    console.log('üîç Starting verifyResumeToken with token:', token);
    
    frappe.call({
        method: 'climoro_onboarding.www.apply.api.verify_resume_token',
        args: {
            token: token
        },
        callback: function(response) {
            console.log('üì° verifyResumeToken callback received:', response);
            
            if (response.message && response.message.success) {
                console.log('‚úÖ Resume token valid:', response.message);
                console.log('Current step from API:', response.message.current_step);
                console.log('Session data current step:', response.message.session_data.current_step);
                resumeSessionData = response.message.session_data;
                // Make it globally available for the form class
                window.resumeSessionData = response.message.session_data;
                
                console.log('üåê Set window.resumeSessionData:', window.resumeSessionData);
                
                // Automatically restore form data without showing modal
                if (resumeSessionData) {
                    restoreFormData(resumeSessionData);
                }
                
                // Keep resume token in URL for refresh functionality
                // Don't clean the URL - preserve the resume token
                console.log('‚úÖ Resume token verified, keeping token in URL for refresh functionality');
                console.log('üîó Current URL with resume token:', window.location.href);
                
            } else {
                console.log('‚ùå Resume token invalid:', response.message);
                alert('Invalid or expired resume link. Please start a new application.');
            }
        },
        error: function(xhr, status, error) {
            console.log('‚ùå verifyResumeToken error:', {xhr, status, error});
            alert('Error verifying resume link. Please start a new application.');
        }
    });
}

function restoreFormData(sessionData) {
    console.log('üîÑ Global restoreFormData called with:', sessionData);
    isResumeMode = true;
    // Make it globally accessible
    window.isResumeMode = true;
    
    const applicationData = sessionData.application_data;
    const currentStep = sessionData.current_step || 1;
    
    console.log('üìÑ Application data:', applicationData);
    console.log('üî¢ Current step:', currentStep);
    
    if (applicationData) {
        // Enhanced form field restoration
        Object.keys(applicationData).forEach(key => {
            // Try multiple selectors to find the field
            let field = document.querySelector(`[name="${key}"]`) || 
                       document.querySelector(`#${key}`) ||
                       document.querySelector(`input[name="${key}"]`) ||
                       document.querySelector(`select[name="${key}"]`) ||
                       document.querySelector(`textarea[name="${key}"]`);
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = applicationData[key] === 1 || applicationData[key] === true || applicationData[key] === '1';
                    // Trigger change event for checkboxes
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (field.type === 'file') {
                    // Skip file inputs - they can't be set programmatically for security reasons
                    console.log(`Skipping file field ${key} (cannot set programmatically), value was: ${applicationData[key]}`);
                } else if (field.type === 'select-one') {
                    field.value = applicationData[key] || '';
                    // Trigger change event for selects
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                } else {
                    field.value = applicationData[key] || '';
                    // Trigger input event for text fields
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
                console.log(`‚úÖ Global set field ${key} to ${applicationData[key]}`);
                
                // Add visual feedback for successfully restored fields
                if (field.type !== 'checkbox' && field.value) {
                    field.classList.add('success');
                    field.classList.remove('error', 'warning');
                }
            } else {
                console.log(`‚ö†Ô∏è Global field ${key} not found in form`);
            }
        });
        
        // Handle dependent dropdowns first
        const industryTypeField = document.querySelector('[name="industry_type"]');
        if (industryTypeField && industryTypeField.value) {
            console.log('Setting up dependent dropdowns for industry type:', industryTypeField.value);
            // Update sub-industry options first
            updateSubIndustryOptions();
            
            // Wait a bit for the options to be populated, then set the sub-industry value
            setTimeout(() => {
                const subIndustryField = document.querySelector('[name="sub_industry_type"]');
                if (subIndustryField && applicationData.sub_industry_type) {
                    subIndustryField.value = applicationData.sub_industry_type;
                    console.log('Set sub-industry type to:', applicationData.sub_industry_type);
                }
            }, 100);
        }
        
        // Trigger change events for other select fields to update dependent fields
        document.querySelectorAll('select').forEach(select => {
            if (select.value && select.name !== 'industry_type' && select.name !== 'sub_industry_type') {
                select.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        
        // Set current step
        console.log('Setting current step to:', currentStep);
        setCurrentStep(currentStep);
        showStep(currentStep);
        updateProgressIndicator();
        
        // Also update the form class current step
        if (window.onboardingForm) {
            window.onboardingForm.handleResume(sessionData);
        } else {
            // If form is not initialized yet, wait a bit and try again
            setTimeout(() => {
                if (window.onboardingForm) {
                    window.onboardingForm.handleResume(sessionData);
                }
            }, 100);
        }
        
        // Show success message
        showResumeMessage('Application resumed successfully! Your previous data has been loaded.', 'success');
        
        // Hide welcome modal and remove blur
        const welcomeModal = document.getElementById('welcome-modal');
        const formContainer = document.getElementById('form-container');
        if (welcomeModal) {
            welcomeModal.style.display = 'none';
        }
        if (formContainer) {
            formContainer.classList.remove('form-blur');
        }
    } else {
        console.log('No application data found in session data');
        // Try to at least set the current step
        setCurrentStep(currentStep);
        showStep(currentStep);
        updateProgressIndicator();
        
        // Also update the form class current step
        if (window.onboardingForm) {
            window.onboardingForm.handleResume(sessionData);
        } else {
            // If form is not initialized yet, wait a bit and try again
            setTimeout(() => {
                if (window.onboardingForm) {
                    window.onboardingForm.handleResume(sessionData);
                }
            }, 100);
        }
        
        // Show success message
        showResumeMessage('Application resumed successfully! You are now at step ' + currentStep, 'success');
        
        // Hide welcome modal and remove blur
        const welcomeModal = document.getElementById('welcome-modal');
        const formContainer = document.getElementById('form-container');
        if (welcomeModal) {
            welcomeModal.style.display = 'none';
        }
        if (formContainer) {
            formContainer.classList.remove('form-blur');
        }
    }
}

function resetForm() {
    isResumeMode = false;
    window.isResumeMode = false;
    resumeSessionData = null;
    window.resumeSessionData = null;
    
    // Reset form
    document.getElementById('onboarding-form').reset();
    
    // Reset to step 1
    setCurrentStep(1);
    showStep(1);
    updateProgressIndicator();
    
    // Clear any messages
    const resumeMessage = document.getElementById('resume-message');
    if (resumeMessage) {
        resumeMessage.innerHTML = '';
    }
    
    // Hide welcome modal and remove blur
    const welcomeModal = document.getElementById('welcome-modal');
    const formContainer = document.getElementById('form-container');
    if (welcomeModal) {
        welcomeModal.style.display = 'none';
    }
    if (formContainer) {
        formContainer.classList.remove('form-blur');
    }
}

function showResumeMessage(message, type) {
    const resumeMessage = document.getElementById('resume-message');
    if (resumeMessage) {
        resumeMessage.innerHTML = `<div class="${type}">${message}</div>`;
    }
}

// Override existing functions to handle resume mode
function setCurrentStep(step) {
    currentStep = step;
    // Store in session storage for persistence
    sessionStorage.setItem('climoro_current_step', step);
}

function showStep(step) {
    console.log('Global showStep called with step:', step);
    
    // Hide all steps
    document.querySelectorAll('.form-step').forEach(stepElement => {
        stepElement.classList.remove('active');
    });
    
    // Show current step
    const currentStepElement = document.getElementById(`step-${step}`);
    if (currentStepElement) {
        currentStepElement.classList.add('active');
        console.log('Global showStep activated step element:', `step-${step}`);
    } else {
        console.log('Global showStep step element not found:', `step-${step}`);
    }
    
    // Update progress indicator
    updateProgressIndicator();
    
    // Also update form class navigation if available
    if (window.onboardingForm) {
        console.log('Global showStep updating form class navigation');
        window.onboardingForm.currentStep = step;
        window.onboardingForm.updateNavigation();
    }
}

function updateProgressIndicator() {
    // Remove current class from all steps
    document.querySelectorAll('.onboarding-progress-step').forEach(step => {
        step.classList.remove('onboarding-current');
        step.classList.remove('onboarding-completed');
    });
    
    // Add current class to current step and completed to previous steps
    for (let i = 1; i <= 6; i++) {
        const stepElement = document.querySelector(`[data-step="${i}"]`);
        if (i < currentStep) {
            stepElement.classList.add('onboarding-completed');
        } else if (i === currentStep) {
            stepElement.classList.add('onboarding-current');
        }
    }
}
</script>

{% endblock %} 